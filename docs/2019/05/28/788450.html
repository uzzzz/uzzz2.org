<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>大数据学习笔记之Oozie（一）：Oozie入门 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="大数据学习笔记之Oozie（一）：Oozie入门" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="文章目录 1、Oozie英文翻译 2、Oozie简介 3、Oozie在集群中扮演的角色 4、Oozie的功能模块 5、Oozie的节点 6、Oozie的安装与部署 7、案例 7.1、案例一：使用Oozie调度Shell脚本 7.2、案例二：执行多个Job调度 7.3、案例三：调度MapReduce任务 7.4、案例四：Coordinator周期性调度任务（这个最后是没有成功的，start和stop配置的格式的问题，不要修改时区试试，毕竟修改时区是为了强迫症患者~） 小问题总结 （排查问题）： 1、Oozie英文翻译 驯象人 2、Oozie简介 一个基于工作流引擎的开源框架，由Cloudera公司贡献给Apache，提供对Hadoop Mapreduce、Pig Jobs的任务调度与协调。 Oozie需要部署到Java Servlet容器中运行。 3、Oozie在集群中扮演的角色 定时调度任务，多任务可以按照执行的逻辑顺序调度。 4、Oozie的功能模块 4.1、Workflow 顺序执行流程节点，支持fork（分支多个节点），join（合并多个节点为一个） 4.2、Coordinator 定时触发workflow 4.3、Bundle Job 绑定多个Coordinator 5、Oozie的节点 5.1、控制流节点（Control Flow Nodes） 控制流节点一般都是定义在工作流开始或者结束的位置，比如start,end,kill等。以及提供工作流的执行路径机制， 如decision,fork,join等。 5.2、动作节点（Action Nodes） 就是执行具体任务动作的节点。 6、Oozie的安装与部署 6.1、解压Oozie（有桌面版的有非桌面版的，下面这个是桌面版的，ext-2.2.zip是非桌面版的） $ tar -zxf /opt/softwares/oozie-4.0.0-cdh5.3.6.tar.gz -C /opt/modules/cdh/ 6.2、Hadoop配置文件修改，完成后scp到其他机器节点 6.2.1、core-site.xml &lt;!-- Oozie Server的Hostname --&gt; //配置中的admin可以改为其他的用户，比如root &lt;property&gt; //代理的用户是admin &lt;name&gt;hadoop.proxyuser.admin.hosts&lt;/name&gt; &lt;value&gt;*&lt;/value&gt; &lt;/property&gt; &lt;!-- 允许被Oozie代理的用户组 --&gt; &lt;property&gt; //允许被Oozie代理的用户组是admin所在的组，admin所在的组，都允许被所有的用户代理 &lt;name&gt;hadoop.proxyuser.admin.groups&lt;/name&gt; &lt;value&gt;*&lt;/value&gt; &lt;/property&gt; 6.2.2、配置JobHistoryServer服务（必须） mapred-site.xml &lt;!-- 配置 MapReduce JobHistory Server 地址 ，通信，默认端口10020 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.jobhistory.address&lt;/name&gt; &lt;value&gt;hadoop-senior01.itguigu.com:10020&lt;/value&gt; &lt;/property&gt; &lt;!-- 配置 MapReduce JobHistory Server web ui 地址，展示web， 默认端口19888 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.jobhistory.webapp.address&lt;/name&gt; &lt;value&gt;hadoop-senior01.itguigu.com:19888&lt;/value&gt; &lt;/property&gt; yarn-site.xml &lt;!-- 任务历史服务 --&gt; &lt;property&gt; &lt;name&gt;yarn.log.server.url&lt;/name&gt; &lt;value&gt;http://hadoop-senior01.itguigu.com:19888/jobhistory/logs/&lt;/value&gt; &lt;/property&gt; 完成后：记得scp同步到其他机器节点 6.3、开启Hadoop集群 $ sh ~/start-cluster.sh（这是之前hive学习的时候的一个脚本：https://blog.csdn.net/dataiyangu/article/details/90116342#_126） 主要是最后一句话，开启JobHistoryServer jps看一下 尖叫提示：需要配合开启JobHistoryServer 最好执行一个MR任务进行测试。 succeeded说明成功了 6.4、解压hadooplibs $ tar -zxf /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-hadooplibs-4.0.0-cdh5.3.6.tar.gz -C /opt/modules/cdh/ 完成后Oozie目录下会出现hadooplibs目录 目录结构： 6.5、在Oozie目录下创建libext目录 $ mkdir libext/ 6.6、拷贝一些依赖的Jar包 6.6.1、将hadooplibs里面的jar包，拷贝到libext目录下 $ cp -ra /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/hadooplibs/hadooplib-2.5.0-cdh5.3.6.oozie-4.0.0-cdh5.3.6/* libext/ 6.6.2、拷贝Mysql驱动包到libext目录下 $ cp -a /opt/softwares/mysql-connector-java-5.1.27/mysql-connector-java-5.1.27-bin.jar /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/libext/ 如果不拷贝mysql的驱动包，Oozie会报错 6.7、将ext-2.2.zip拷贝到libext/目录下 $ cp /opt/softwares/ext-2.2.zip libext/ 6.8、修改Oozie配置文件 6.8.1、oozie-site.xml ** JDBC驱动 oozie.service.JPAService.jdbc.driver com.mysql.jdbc.Driver ** Mysql的oozie数据库的配置 oozie.service.JPAService.jdbc.url jdbc:mysql://192.168.122.20:3306/oozie ** 数据库用户名 oozie.service.JPAService.jdbc.username root ** 数据库密码 oozie.service.JPAService.jdbc.password 123456 ** 让Oozie引用Hadoop的配置文件 oozie.service.HadoopAccessorService.hadoop.configurations 真的就是这样：--&gt; *=/opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/etc/hadoop 6.9、在Mysql中创建Oozie的数据库 6.9.1、进入数据库 $ mysql -uroot -p123456 6.9.2、创建oozie数据库 mysql&gt; create database oozie; 6.10、初始化Oozie的配置 6.10.1、上传Oozie目录下的yarn.tar.gz文件到HDFS（尖叫提示：yarn.tar.gz文件会自行解压） $ bin/oozie-setup.sh sharelib create -fs hdfs://hadoop-senior01.itguigu.com:8020 -locallib oozie-sharelib-4.0.0-cdh5.3.6-yarn.tar.gz 执行成功之后，去50070检查对应目录有没有文件生成。 6.10.2、创建oozie.sql文件 $ bin/oozie-setup.sh db create -run -sqlfile oozie.sql cat oozie.sql 里面有很多oozie依赖的表结构 6.10.3、打包项目，生成war包 $ bin/oozie-setup.sh prepare-war 注意：在打包的过程中oozie线程没有被停掉的话，打包是失败的，如果oozie 的进程停掉了，一定会成功吗？cd oozie-server/temp 有一个safeToDelete.tmp临时文件，如果oozie在没有配置好的情况下，已经不小心的启动了，现在需要停掉重新打包，重新启动，如果有这个过程的话，一定要来temp目录下看一看，有没有.pid结尾的文件，如果有的话就删除掉，当然如果oozie跑着好好的，不要把.pid结尾的文件删除掉，否则就会导致oozie停不掉，只能kill掉 启动成功的话如下图： 6.11、启动Oozie服务 $ bin/oozied.sh start （关闭Oozie服务：$ bin/oozied.sh stop） 6.12、访问Oozie的Web页面 http://hadoop-senior01.itguigu.com:11000/oozie 如何查看异常？在logs目录下有catalina.out 7、案例 7.1、案例一：使用Oozie调度Shell脚本 7.1.1、解压官方案例模板 $ tar -zxf oozie-examples.tar.gz 7.1.2、创建工作目录 $ mkdir oozie-apps/ 7.1.3、拷贝任务模板到oozie-apps/目录 $ cp -r examples/apps/shell/ oozie-apps/ 在shell目录下有job.properties（当前任务调度的属性信息） 和 workflow.xml（调度任务的工作流），在oozie进行调度的时候，配置文件必须上传到hdfs系统，所以应该把这两个模板拷贝到自己的文件夹，修改完成之后上传到hdfs 7.1.4、随意编写一个脚本p1.sh $ vi /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps/shell/p1.log 内容如下： #!/bin/bash /usr/sbin/ifconfig &gt; /tmp/p1.log 7.1.5、修改job.properties和workflow.xml文件 ** job.properties #HDFS地址 //如果是集群的话就不要写8020了，写mycluster // //&lt;!-- 集群中NameNode节点都有哪些 --&gt; // &lt;property&gt; // //这里的mycluster和上面名称一致 // &lt;name&gt;dfs.ha.namenodes.mycluster&lt;/name&gt; // &lt;value&gt;nn1,nn2&lt;/value&gt; // &lt;/property&gt; nameNode=hdfs://hadoop-senior01.itguigu.com:8020 #ResourceManager地址 jobTracker=hadoop-senior02.itguigu.com:8032 #队列名称 //oozie在任务调度的时候会产生一个任务队列 queueName=default //存放job.properties 和 workflow.xml的目录 examplesRoot=oozie-apps //oozie app的存放路径 oozie.wf.application.path=${nameNode}/user/${user.name}/${examplesRoot}/shell //如果希望oozie调度某个脚本的话，就将这个脚本赋值给变量EXEC //脚本中的内容任意 EXEC=p1.sh p1.sh需要放在和job.properties 和 workflow.xml同目录的文件夹下， ** workflow.xml //workflow-app表示是一个workflow的工作调度 &lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.4&quot; name=&quot;shell-wf&quot;&gt; //任务在开始的时候，首先去执行谁 &lt;start to=&quot;shell-node&quot;/&gt; //action是一个任务 &lt;action name=&quot;shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; //这里的jobTracker、nameNode和queueName是直接引用的 job.properties 里面的内容 &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; //这里原来是echo 下面 argument中的内容 //这里我们改成执行我们的脚本 &lt;exec&gt;${EXEC}&lt;/exec&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt; --&gt; //注意后面的${EXEC}#${EXEC}，如果不这样写的话是找不到这个文件的 &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC}#${EXEC}&lt;/file&gt; &lt;capture-output/&gt; &lt;/shell&gt; //如果成功的话跳转到end &lt;ok to=&quot;end&quot;/&gt; //如果失败的话跳转到fail &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;decision name=&quot;check-output&quot;&gt; &lt;switch&gt; &lt;case to=&quot;end&quot;&gt; ${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;] eq &#39;Hello Oozie&#39;} &lt;/case&gt; &lt;default to=&quot;fail-output&quot;/&gt; &lt;/switch&gt; &lt;/decision&gt; //如果失败的话kill掉自己 &lt;kill name=&quot;fail&quot;&gt; &lt;message&gt;Shell action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]&lt;/message&gt; &lt;/kill&gt; &lt;kill name=&quot;fail-output&quot;&gt; &lt;message&gt;Incorrect output, expected [Hello Oozie] but was [${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;]}] &lt;/message&gt; &lt;/kill&gt; &lt;end name=&quot;end&quot;/&gt; &lt;/workflow-app&gt; 如果需要修改任务，需要kill掉当前的任务，从hdfs上删除原来的配置文件，然后上传新的配置文件，再重新启动。 7.1.6、上传任务配置 $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/hdfs dfs -put /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps /user/admin 7.1.7、执行任务 $ bin/oozie job -oozie http://hadoop-senior01.itguigu.com:11000/oozie -config oozie-apps/shell/job.properties -run http://hadoop-senior01.itguigu.com:11000/oozie oozie的服务器地址 -config oozie-apps/shell/job.properties 是oozie的配置文件 执行完之后会生成一个jobid，用于下面杀死某个任务 7.1.8、杀死某个任务 $ bin/oozie job -oozie http://hadoop-senior01.itguigu.com:11000/oozie -kill 0000004-170425105153692-oozie-z-W 查看页面： 双击打开会有一些任务信息 注意：如果某个任务没有成功调度的话，上图中是删除不掉的，也kill不掉，也就是说执行了上面的杀死命令，在这个页面中这个任务也还是存在的，那是不是没有办法了呢？可以进入mysql drop database oozie ; 删除掉oozie这个数据库，或者进入删除具体的某张表的某个数据。强迫症患者~哎，可以再use oozie ; seledt * from WF_ACTIONS里面看到，并删除。 如果成功的话在MapReduce中也是有oozie这个任务的，对应于ob.properties中的MapReduce配置 执行完了之后 all jobs里面刚才的任务没有了，因为到了done jobs里面 这个时候到第二台机器查看 ，刚才执行的脚本是将某个日志复制到某个目录 ，发现是没有的 因为MapReduce的调度，所以在放到了第三台 到第三台上查看 如果希望固定放到某个机器上，可以在脚本里面写 ssh 固定某台机器 7.2、案例二：执行多个Job调度 7.2.1、解压官方案例模板 job.properties nameNode=hdfs://hadoop-senior01.itguigu.com:8020 jobTracker=hadoop-senior02.itguigu.com:8032 queueName=default examplesRoot=oozie-apps oozie.wf.application.path=${nameNode}/user/${user.name}/${examplesRoot}/shell EXEC1=p1.sh EXEC2=p2.sh workflow.xml &lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.4&quot; name=&quot;shell-wf&quot;&gt; &lt;start to=&quot;p1-shell-node&quot;/&gt; &lt;action name=&quot;p1-shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;exec&gt;${EXEC1}&lt;/exec&gt; &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC1}#${EXEC1}&lt;/file&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt;--&gt; &lt;capture-output/&gt; &lt;/shell&gt; &lt;ok to=&quot;p2-shell-node&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;action name=&quot;p2-shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;exec&gt;${EXEC2}&lt;/exec&gt; &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC2}#${EXEC2}&lt;/file&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt;--&gt; &lt;capture-output/&gt; &lt;/shell&gt; &lt;ok to=&quot;end&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;decision name=&quot;check-output&quot;&gt; &lt;switch&gt; &lt;case to=&quot;end&quot;&gt; ${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;] eq &#39;Hello Oozie&#39;} &lt;/case&gt; &lt;default to=&quot;fail-output&quot;/&gt; &lt;/switch&gt; &lt;/decision&gt; &lt;kill name=&quot;fail&quot;&gt; &lt;message&gt;Shell action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]&lt;/message&gt; &lt;/kill&gt; &lt;kill name=&quot;fail-output&quot;&gt; &lt;message&gt;Incorrect output, expected [Hello Oozie] but was [${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;]}]&lt;/message&gt; &lt;/kill&gt; &lt;end name=&quot;end&quot;/&gt; &lt;/workflow-app&gt; 上面的配置文件主要是增加了一个actoin，第一个action不是to end 变成了，第二个才是 执行之前将之前上传的文件全部删掉，直接删掉原来的oozie-apps目录，然后重新上传、运行 测试时需要留意的点： 1、每个脚本是在哪台机器上执行的。 2、脚本的执行时间。 3、发现一个问题：执行任务的时间和本地时间不一致。它的时间是utc的，比北京的时间慢了八个小时。 7.3、案例三：调度MapReduce任务 7.3.1、先编写一个可以运行的MR任务的.jar包 7.3.2、拷贝官方模板到oozie-apps $ cp -r /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/examples/apps/map-reduce/ /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps/ 7.3.3、测试一下wordcount在yarn中的运行 $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/yarn jar hadoop-mapreduce-examples-2.5.0-cdh5.3.6.jar wordcount /input/ /output111/ 为什么要跑这个任务？一会在配置workflow的时候，需要用到MapReduce在运行的过程中出现的各种参数，比如mapclass、reduceclass、输出的类型等，如果代码是自己写的可以直接拷贝，但是如果不是自己写的，需要看代码的内部结构，比较麻烦，所以可以通过页面查看MapReduce的history，查看已经运行好的任务的参数。 可以到概览页面，然后点击history，再点击configuration，就能够看到各种参数 可以直接搜索找到需要的配置参数。 7.3.4、配置map-reduce任务 job.properties nameNode=hdfs://hadoop-senior01.itguigu.com:8020 jobTracker=hadoop-senior02.itguigu.com:8021 queueName=default examplesRoot=oozie-apps #hdfs://hadoop-senior01.itguigu.com:8020/user/admin/oozie-apps/map-reduce/workflow.xml oozie.wf.application.path=${nameNode}/user/${user.name}/${examplesRoot}/map-reduce/workflow.xml //输出路径可有可无，这里面的参数都是为了在下面的配置文件中进行引用的，可以在这里进行引用，也可以 //在下面的配置文件中写死。 outputDir=map-reduce workflow.xml &lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.2&quot; name=&quot;map-reduce-wf&quot;&gt; &lt;start to=&quot;mr-node&quot;/&gt; &lt;action name=&quot;mr-node&quot;&gt; //下面的configuration中的内容是对map-reduce生效的 &lt;map-reduce&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; //在运行之前可以做一些准备工作 &lt;prepare&gt; //删除output目录 &lt;delete path=&quot;${nameNode}/output/&quot;/&gt; &lt;/prepare&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;!-- 配置调度MR任务时，使用新的API，即MapReduce，老的是MapRed。改为true即可--&gt; &lt;property&gt; &lt;name&gt;mapred.mapper.new-api&lt;/name&gt; &lt;value&gt;true&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;mapred.reducer.new-api&lt;/name&gt; &lt;value&gt;true&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定Job Key输出类型 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.job.output.key.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.io.Text&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定Job Value输出类型 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.job.output.value.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.io.IntWritable&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定输入路径 --&gt; &lt;property&gt; &lt;name&gt;mapred.input.dir&lt;/name&gt; &lt;value&gt;/input/&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定输出路径 --&gt; &lt;property&gt; &lt;name&gt;mapred.output.dir&lt;/name&gt; &lt;value&gt;/output/&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定Map类 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.job.map.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.examples.WordCount$TokenizerMapper&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定Reduce类 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.job.reduce.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.examples.WordCount$IntSumReducer&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;mapred.map.tasks&lt;/name&gt; &lt;value&gt;1&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;/map-reduce&gt; &lt;ok to=&quot;end&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;kill name=&quot;fail&quot;&gt; &lt;message&gt;Map/Reduce failed, error message[${wf:errorMessage(wf:lastErrorNode())}]&lt;/message&gt; &lt;/kill&gt; &lt;end name=&quot;end&quot;/&gt; &lt;/workflow-app&gt; 7.3.5、拷贝待执行的jar包到map-reduce的lib目录下 $ cp -a /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/hadoop-mapreduce-examples-2.5.0-cdh5.3.6.jar ./ 7.3.6、上传配置好的app文件夹到HDFS $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/hdfs dfs -put map-reduce/ /user/admin/oozie-apps 是可以看到刚才上传的jar包的oozie提供的官方的jar没用，上传上来也不会坏了一锅汤 7.3.7、执行任务 $ bin/oozie job -oozie http://hadoop-senior01.itguigu.com:11000/oozie -config oozie-apps/map-reduce/job.properties -run 查看任务情况 7.4、案例四：Coordinator周期性调度任务（这个最后是没有成功的，start和stop配置的格式的问题，不要修改时区试试，毕竟修改时区是为了强迫症患者~） 7.4.1、配置Linux时区 详见Hive第一天Word文档 7.4.2、修改oozie-default.xml文件，涉及属性： ** 修改oozie的时区 oozie.processing.timezone GMT+0800（默认是UTC的） 7.4.3、修改js框架中的关于时间设置的代码 $ vi /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-server/webapps/oozie/oozie-console.js 修改如下： function getTimeZone() { Ext.state.Manager.setProvider(new Ext.state.CookieProvider()); return Ext.state.Manager.get(“TimezoneId”,“GMT+0800”); } 7.4.4、重启oozie服务，并重启浏览器（一定要注意清除缓存） $ bin/oozied.sh stop $ bin/oozied.sh start 然后重新查看时间 7.4.5、拷贝官方模板配置定时任务 $ cp -r /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/examples/apps/cron/ /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps/ 7.4.6、修改模板 job.properties nameNode=hdfs://hadoop-senior01.itguigu.com:8020 jobTracker=hadoop-senior02.itguigu.com:8032 queueName=default examplesRoot=oozie-apps oozie.coord.application.path=${nameNode}/user/${user.name}/${examplesRoot}/apps/cron #start：必须设置为未来时间，否则任务失败，一次都不会执行 start=2017-07-29T17:00+0800 end=2017-07-30T17:00+0800 workflowAppUri=${nameNode}/user/${user.name}/${examplesRoot}/cron EXEC1=p1.sh EXEC2=p2.sh coordinator.xml //frequency频率的意思，这里是每十分钟执行一次 //start 开始时间 引用前面的配置文件 end 结束时间 timezone时区 &lt;coordinator-app name=&quot;cron-coord&quot; frequency=&quot;${coord:minutes(10)}&quot; start=&quot;${start}&quot; end=&quot;${end}&quot; timezone=&quot;GMT+0800&quot; xmlns=&quot;uri:oozie:coordinator:0.2&quot;&gt; &lt;action&gt; &lt;workflow&gt; &lt;app-path&gt;${workflowAppUri}&lt;/app-path&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;jobTracker&lt;/name&gt; &lt;value&gt;${jobTracker}&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;nameNode&lt;/name&gt; &lt;value&gt;${nameNode}&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;queueName&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;/workflow&gt; &lt;/action&gt; &lt;/coordinator-app&gt; workflow.xml &lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.5&quot; name=&quot;one-op-wf&quot;&gt; &lt;start to=&quot;p1-shell-node&quot;/&gt; &lt;action name=&quot;p1-shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;exec&gt;${EXEC1}&lt;/exec&gt; &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC1}#${EXEC1}&lt;/file&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt;--&gt; &lt;capture-output/&gt; &lt;/shell&gt; &lt;ok to=&quot;p2-shell-node&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;action name=&quot;p2-shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;exec&gt;${EXEC2}&lt;/exec&gt; &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC2}#${EXEC2}&lt;/file&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt;--&gt; &lt;capture-output/&gt; &lt;/shell&gt; &lt;ok to=&quot;end&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;decision name=&quot;check-output&quot;&gt; &lt;switch&gt; &lt;case to=&quot;end&quot;&gt; ${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;] eq &#39;Hello Oozie&#39;} &lt;/case&gt; &lt;default to=&quot;fail-output&quot;/&gt; &lt;/switch&gt; &lt;/decision&gt; &lt;kill name=&quot;fail&quot;&gt; &lt;message&gt;Shell action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]&lt;/message&gt; &lt;/kill&gt; &lt;kill name=&quot;fail-output&quot;&gt; &lt;message&gt;Incorrect output, expected [Hello Oozie] but was [${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;]}]&lt;/message&gt; &lt;/kill&gt; &lt;end name=&quot;end&quot;/&gt; &lt;/workflow-app&gt; 7.4.7、上传配置，启动任务 $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/hdfs dfs -put oozie-apps/cron/ /user/admin/oozie-apps $ bin/oozie job -oozie http://hadoop-senior01.itguigu.com:11000/oozie -config oozie-apps/cron/job.properties -run (尖叫提示：oozie允许的最小执行任务的频率是5分钟) 小问题总结 （排查问题）： 1、Mysql权限配置 2、workflow.xml配置的时候不要忽略file属性 3、jps查看进程时，注意有没有bootstrap 4、关闭oozie ** bin/oozied.sh stop）如果无法关闭，则可以使用kill ** kill -9 11111 kill之后oozie-server/temp/xxx.pid文件一定要删除 5、Oozie重新打包时，一定要注意先关闭进程，删除对应文件夹下面的pid文件。（可以参考第4条目） 6、配置文件一定要生效 ** 起始标签和结束标签无对应则不生效 ** 配置文件的属性写错了，那么则执行默认的属性。 7、libext下边的jar存放于某个文件夹中，导致share/lib创建不成功 8、-rmr share/lib这样是不行的。 rm -rmr /user/admin这样删除是错误的。 9、调度任务时，找不到指定的脚本，可能是oozie-site.xml里面的Hadoop配置文件没有关联上 10、修改Hadoop配置文件，需要重启集群。一定要记得scp到其他节点 11、JobHistoryServer必须开启，集群要重启的。 12、Mysql配置如果没有生效的话，默认使用derby数据库 13、在本地修改完成的job配置，必须重新上传到HDFS 14、将HDFS上面的配置文件，下载下来查看是否有错误。 15、Linux用户名和Hadoop的用户名不一致。" />
<meta property="og:description" content="文章目录 1、Oozie英文翻译 2、Oozie简介 3、Oozie在集群中扮演的角色 4、Oozie的功能模块 5、Oozie的节点 6、Oozie的安装与部署 7、案例 7.1、案例一：使用Oozie调度Shell脚本 7.2、案例二：执行多个Job调度 7.3、案例三：调度MapReduce任务 7.4、案例四：Coordinator周期性调度任务（这个最后是没有成功的，start和stop配置的格式的问题，不要修改时区试试，毕竟修改时区是为了强迫症患者~） 小问题总结 （排查问题）： 1、Oozie英文翻译 驯象人 2、Oozie简介 一个基于工作流引擎的开源框架，由Cloudera公司贡献给Apache，提供对Hadoop Mapreduce、Pig Jobs的任务调度与协调。 Oozie需要部署到Java Servlet容器中运行。 3、Oozie在集群中扮演的角色 定时调度任务，多任务可以按照执行的逻辑顺序调度。 4、Oozie的功能模块 4.1、Workflow 顺序执行流程节点，支持fork（分支多个节点），join（合并多个节点为一个） 4.2、Coordinator 定时触发workflow 4.3、Bundle Job 绑定多个Coordinator 5、Oozie的节点 5.1、控制流节点（Control Flow Nodes） 控制流节点一般都是定义在工作流开始或者结束的位置，比如start,end,kill等。以及提供工作流的执行路径机制， 如decision,fork,join等。 5.2、动作节点（Action Nodes） 就是执行具体任务动作的节点。 6、Oozie的安装与部署 6.1、解压Oozie（有桌面版的有非桌面版的，下面这个是桌面版的，ext-2.2.zip是非桌面版的） $ tar -zxf /opt/softwares/oozie-4.0.0-cdh5.3.6.tar.gz -C /opt/modules/cdh/ 6.2、Hadoop配置文件修改，完成后scp到其他机器节点 6.2.1、core-site.xml &lt;!-- Oozie Server的Hostname --&gt; //配置中的admin可以改为其他的用户，比如root &lt;property&gt; //代理的用户是admin &lt;name&gt;hadoop.proxyuser.admin.hosts&lt;/name&gt; &lt;value&gt;*&lt;/value&gt; &lt;/property&gt; &lt;!-- 允许被Oozie代理的用户组 --&gt; &lt;property&gt; //允许被Oozie代理的用户组是admin所在的组，admin所在的组，都允许被所有的用户代理 &lt;name&gt;hadoop.proxyuser.admin.groups&lt;/name&gt; &lt;value&gt;*&lt;/value&gt; &lt;/property&gt; 6.2.2、配置JobHistoryServer服务（必须） mapred-site.xml &lt;!-- 配置 MapReduce JobHistory Server 地址 ，通信，默认端口10020 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.jobhistory.address&lt;/name&gt; &lt;value&gt;hadoop-senior01.itguigu.com:10020&lt;/value&gt; &lt;/property&gt; &lt;!-- 配置 MapReduce JobHistory Server web ui 地址，展示web， 默认端口19888 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.jobhistory.webapp.address&lt;/name&gt; &lt;value&gt;hadoop-senior01.itguigu.com:19888&lt;/value&gt; &lt;/property&gt; yarn-site.xml &lt;!-- 任务历史服务 --&gt; &lt;property&gt; &lt;name&gt;yarn.log.server.url&lt;/name&gt; &lt;value&gt;http://hadoop-senior01.itguigu.com:19888/jobhistory/logs/&lt;/value&gt; &lt;/property&gt; 完成后：记得scp同步到其他机器节点 6.3、开启Hadoop集群 $ sh ~/start-cluster.sh（这是之前hive学习的时候的一个脚本：https://blog.csdn.net/dataiyangu/article/details/90116342#_126） 主要是最后一句话，开启JobHistoryServer jps看一下 尖叫提示：需要配合开启JobHistoryServer 最好执行一个MR任务进行测试。 succeeded说明成功了 6.4、解压hadooplibs $ tar -zxf /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-hadooplibs-4.0.0-cdh5.3.6.tar.gz -C /opt/modules/cdh/ 完成后Oozie目录下会出现hadooplibs目录 目录结构： 6.5、在Oozie目录下创建libext目录 $ mkdir libext/ 6.6、拷贝一些依赖的Jar包 6.6.1、将hadooplibs里面的jar包，拷贝到libext目录下 $ cp -ra /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/hadooplibs/hadooplib-2.5.0-cdh5.3.6.oozie-4.0.0-cdh5.3.6/* libext/ 6.6.2、拷贝Mysql驱动包到libext目录下 $ cp -a /opt/softwares/mysql-connector-java-5.1.27/mysql-connector-java-5.1.27-bin.jar /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/libext/ 如果不拷贝mysql的驱动包，Oozie会报错 6.7、将ext-2.2.zip拷贝到libext/目录下 $ cp /opt/softwares/ext-2.2.zip libext/ 6.8、修改Oozie配置文件 6.8.1、oozie-site.xml ** JDBC驱动 oozie.service.JPAService.jdbc.driver com.mysql.jdbc.Driver ** Mysql的oozie数据库的配置 oozie.service.JPAService.jdbc.url jdbc:mysql://192.168.122.20:3306/oozie ** 数据库用户名 oozie.service.JPAService.jdbc.username root ** 数据库密码 oozie.service.JPAService.jdbc.password 123456 ** 让Oozie引用Hadoop的配置文件 oozie.service.HadoopAccessorService.hadoop.configurations 真的就是这样：--&gt; *=/opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/etc/hadoop 6.9、在Mysql中创建Oozie的数据库 6.9.1、进入数据库 $ mysql -uroot -p123456 6.9.2、创建oozie数据库 mysql&gt; create database oozie; 6.10、初始化Oozie的配置 6.10.1、上传Oozie目录下的yarn.tar.gz文件到HDFS（尖叫提示：yarn.tar.gz文件会自行解压） $ bin/oozie-setup.sh sharelib create -fs hdfs://hadoop-senior01.itguigu.com:8020 -locallib oozie-sharelib-4.0.0-cdh5.3.6-yarn.tar.gz 执行成功之后，去50070检查对应目录有没有文件生成。 6.10.2、创建oozie.sql文件 $ bin/oozie-setup.sh db create -run -sqlfile oozie.sql cat oozie.sql 里面有很多oozie依赖的表结构 6.10.3、打包项目，生成war包 $ bin/oozie-setup.sh prepare-war 注意：在打包的过程中oozie线程没有被停掉的话，打包是失败的，如果oozie 的进程停掉了，一定会成功吗？cd oozie-server/temp 有一个safeToDelete.tmp临时文件，如果oozie在没有配置好的情况下，已经不小心的启动了，现在需要停掉重新打包，重新启动，如果有这个过程的话，一定要来temp目录下看一看，有没有.pid结尾的文件，如果有的话就删除掉，当然如果oozie跑着好好的，不要把.pid结尾的文件删除掉，否则就会导致oozie停不掉，只能kill掉 启动成功的话如下图： 6.11、启动Oozie服务 $ bin/oozied.sh start （关闭Oozie服务：$ bin/oozied.sh stop） 6.12、访问Oozie的Web页面 http://hadoop-senior01.itguigu.com:11000/oozie 如何查看异常？在logs目录下有catalina.out 7、案例 7.1、案例一：使用Oozie调度Shell脚本 7.1.1、解压官方案例模板 $ tar -zxf oozie-examples.tar.gz 7.1.2、创建工作目录 $ mkdir oozie-apps/ 7.1.3、拷贝任务模板到oozie-apps/目录 $ cp -r examples/apps/shell/ oozie-apps/ 在shell目录下有job.properties（当前任务调度的属性信息） 和 workflow.xml（调度任务的工作流），在oozie进行调度的时候，配置文件必须上传到hdfs系统，所以应该把这两个模板拷贝到自己的文件夹，修改完成之后上传到hdfs 7.1.4、随意编写一个脚本p1.sh $ vi /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps/shell/p1.log 内容如下： #!/bin/bash /usr/sbin/ifconfig &gt; /tmp/p1.log 7.1.5、修改job.properties和workflow.xml文件 ** job.properties #HDFS地址 //如果是集群的话就不要写8020了，写mycluster // //&lt;!-- 集群中NameNode节点都有哪些 --&gt; // &lt;property&gt; // //这里的mycluster和上面名称一致 // &lt;name&gt;dfs.ha.namenodes.mycluster&lt;/name&gt; // &lt;value&gt;nn1,nn2&lt;/value&gt; // &lt;/property&gt; nameNode=hdfs://hadoop-senior01.itguigu.com:8020 #ResourceManager地址 jobTracker=hadoop-senior02.itguigu.com:8032 #队列名称 //oozie在任务调度的时候会产生一个任务队列 queueName=default //存放job.properties 和 workflow.xml的目录 examplesRoot=oozie-apps //oozie app的存放路径 oozie.wf.application.path=${nameNode}/user/${user.name}/${examplesRoot}/shell //如果希望oozie调度某个脚本的话，就将这个脚本赋值给变量EXEC //脚本中的内容任意 EXEC=p1.sh p1.sh需要放在和job.properties 和 workflow.xml同目录的文件夹下， ** workflow.xml //workflow-app表示是一个workflow的工作调度 &lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.4&quot; name=&quot;shell-wf&quot;&gt; //任务在开始的时候，首先去执行谁 &lt;start to=&quot;shell-node&quot;/&gt; //action是一个任务 &lt;action name=&quot;shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; //这里的jobTracker、nameNode和queueName是直接引用的 job.properties 里面的内容 &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; //这里原来是echo 下面 argument中的内容 //这里我们改成执行我们的脚本 &lt;exec&gt;${EXEC}&lt;/exec&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt; --&gt; //注意后面的${EXEC}#${EXEC}，如果不这样写的话是找不到这个文件的 &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC}#${EXEC}&lt;/file&gt; &lt;capture-output/&gt; &lt;/shell&gt; //如果成功的话跳转到end &lt;ok to=&quot;end&quot;/&gt; //如果失败的话跳转到fail &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;decision name=&quot;check-output&quot;&gt; &lt;switch&gt; &lt;case to=&quot;end&quot;&gt; ${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;] eq &#39;Hello Oozie&#39;} &lt;/case&gt; &lt;default to=&quot;fail-output&quot;/&gt; &lt;/switch&gt; &lt;/decision&gt; //如果失败的话kill掉自己 &lt;kill name=&quot;fail&quot;&gt; &lt;message&gt;Shell action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]&lt;/message&gt; &lt;/kill&gt; &lt;kill name=&quot;fail-output&quot;&gt; &lt;message&gt;Incorrect output, expected [Hello Oozie] but was [${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;]}] &lt;/message&gt; &lt;/kill&gt; &lt;end name=&quot;end&quot;/&gt; &lt;/workflow-app&gt; 如果需要修改任务，需要kill掉当前的任务，从hdfs上删除原来的配置文件，然后上传新的配置文件，再重新启动。 7.1.6、上传任务配置 $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/hdfs dfs -put /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps /user/admin 7.1.7、执行任务 $ bin/oozie job -oozie http://hadoop-senior01.itguigu.com:11000/oozie -config oozie-apps/shell/job.properties -run http://hadoop-senior01.itguigu.com:11000/oozie oozie的服务器地址 -config oozie-apps/shell/job.properties 是oozie的配置文件 执行完之后会生成一个jobid，用于下面杀死某个任务 7.1.8、杀死某个任务 $ bin/oozie job -oozie http://hadoop-senior01.itguigu.com:11000/oozie -kill 0000004-170425105153692-oozie-z-W 查看页面： 双击打开会有一些任务信息 注意：如果某个任务没有成功调度的话，上图中是删除不掉的，也kill不掉，也就是说执行了上面的杀死命令，在这个页面中这个任务也还是存在的，那是不是没有办法了呢？可以进入mysql drop database oozie ; 删除掉oozie这个数据库，或者进入删除具体的某张表的某个数据。强迫症患者~哎，可以再use oozie ; seledt * from WF_ACTIONS里面看到，并删除。 如果成功的话在MapReduce中也是有oozie这个任务的，对应于ob.properties中的MapReduce配置 执行完了之后 all jobs里面刚才的任务没有了，因为到了done jobs里面 这个时候到第二台机器查看 ，刚才执行的脚本是将某个日志复制到某个目录 ，发现是没有的 因为MapReduce的调度，所以在放到了第三台 到第三台上查看 如果希望固定放到某个机器上，可以在脚本里面写 ssh 固定某台机器 7.2、案例二：执行多个Job调度 7.2.1、解压官方案例模板 job.properties nameNode=hdfs://hadoop-senior01.itguigu.com:8020 jobTracker=hadoop-senior02.itguigu.com:8032 queueName=default examplesRoot=oozie-apps oozie.wf.application.path=${nameNode}/user/${user.name}/${examplesRoot}/shell EXEC1=p1.sh EXEC2=p2.sh workflow.xml &lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.4&quot; name=&quot;shell-wf&quot;&gt; &lt;start to=&quot;p1-shell-node&quot;/&gt; &lt;action name=&quot;p1-shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;exec&gt;${EXEC1}&lt;/exec&gt; &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC1}#${EXEC1}&lt;/file&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt;--&gt; &lt;capture-output/&gt; &lt;/shell&gt; &lt;ok to=&quot;p2-shell-node&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;action name=&quot;p2-shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;exec&gt;${EXEC2}&lt;/exec&gt; &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC2}#${EXEC2}&lt;/file&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt;--&gt; &lt;capture-output/&gt; &lt;/shell&gt; &lt;ok to=&quot;end&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;decision name=&quot;check-output&quot;&gt; &lt;switch&gt; &lt;case to=&quot;end&quot;&gt; ${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;] eq &#39;Hello Oozie&#39;} &lt;/case&gt; &lt;default to=&quot;fail-output&quot;/&gt; &lt;/switch&gt; &lt;/decision&gt; &lt;kill name=&quot;fail&quot;&gt; &lt;message&gt;Shell action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]&lt;/message&gt; &lt;/kill&gt; &lt;kill name=&quot;fail-output&quot;&gt; &lt;message&gt;Incorrect output, expected [Hello Oozie] but was [${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;]}]&lt;/message&gt; &lt;/kill&gt; &lt;end name=&quot;end&quot;/&gt; &lt;/workflow-app&gt; 上面的配置文件主要是增加了一个actoin，第一个action不是to end 变成了，第二个才是 执行之前将之前上传的文件全部删掉，直接删掉原来的oozie-apps目录，然后重新上传、运行 测试时需要留意的点： 1、每个脚本是在哪台机器上执行的。 2、脚本的执行时间。 3、发现一个问题：执行任务的时间和本地时间不一致。它的时间是utc的，比北京的时间慢了八个小时。 7.3、案例三：调度MapReduce任务 7.3.1、先编写一个可以运行的MR任务的.jar包 7.3.2、拷贝官方模板到oozie-apps $ cp -r /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/examples/apps/map-reduce/ /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps/ 7.3.3、测试一下wordcount在yarn中的运行 $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/yarn jar hadoop-mapreduce-examples-2.5.0-cdh5.3.6.jar wordcount /input/ /output111/ 为什么要跑这个任务？一会在配置workflow的时候，需要用到MapReduce在运行的过程中出现的各种参数，比如mapclass、reduceclass、输出的类型等，如果代码是自己写的可以直接拷贝，但是如果不是自己写的，需要看代码的内部结构，比较麻烦，所以可以通过页面查看MapReduce的history，查看已经运行好的任务的参数。 可以到概览页面，然后点击history，再点击configuration，就能够看到各种参数 可以直接搜索找到需要的配置参数。 7.3.4、配置map-reduce任务 job.properties nameNode=hdfs://hadoop-senior01.itguigu.com:8020 jobTracker=hadoop-senior02.itguigu.com:8021 queueName=default examplesRoot=oozie-apps #hdfs://hadoop-senior01.itguigu.com:8020/user/admin/oozie-apps/map-reduce/workflow.xml oozie.wf.application.path=${nameNode}/user/${user.name}/${examplesRoot}/map-reduce/workflow.xml //输出路径可有可无，这里面的参数都是为了在下面的配置文件中进行引用的，可以在这里进行引用，也可以 //在下面的配置文件中写死。 outputDir=map-reduce workflow.xml &lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.2&quot; name=&quot;map-reduce-wf&quot;&gt; &lt;start to=&quot;mr-node&quot;/&gt; &lt;action name=&quot;mr-node&quot;&gt; //下面的configuration中的内容是对map-reduce生效的 &lt;map-reduce&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; //在运行之前可以做一些准备工作 &lt;prepare&gt; //删除output目录 &lt;delete path=&quot;${nameNode}/output/&quot;/&gt; &lt;/prepare&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;!-- 配置调度MR任务时，使用新的API，即MapReduce，老的是MapRed。改为true即可--&gt; &lt;property&gt; &lt;name&gt;mapred.mapper.new-api&lt;/name&gt; &lt;value&gt;true&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;mapred.reducer.new-api&lt;/name&gt; &lt;value&gt;true&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定Job Key输出类型 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.job.output.key.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.io.Text&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定Job Value输出类型 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.job.output.value.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.io.IntWritable&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定输入路径 --&gt; &lt;property&gt; &lt;name&gt;mapred.input.dir&lt;/name&gt; &lt;value&gt;/input/&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定输出路径 --&gt; &lt;property&gt; &lt;name&gt;mapred.output.dir&lt;/name&gt; &lt;value&gt;/output/&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定Map类 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.job.map.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.examples.WordCount$TokenizerMapper&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定Reduce类 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.job.reduce.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.examples.WordCount$IntSumReducer&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;mapred.map.tasks&lt;/name&gt; &lt;value&gt;1&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;/map-reduce&gt; &lt;ok to=&quot;end&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;kill name=&quot;fail&quot;&gt; &lt;message&gt;Map/Reduce failed, error message[${wf:errorMessage(wf:lastErrorNode())}]&lt;/message&gt; &lt;/kill&gt; &lt;end name=&quot;end&quot;/&gt; &lt;/workflow-app&gt; 7.3.5、拷贝待执行的jar包到map-reduce的lib目录下 $ cp -a /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/hadoop-mapreduce-examples-2.5.0-cdh5.3.6.jar ./ 7.3.6、上传配置好的app文件夹到HDFS $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/hdfs dfs -put map-reduce/ /user/admin/oozie-apps 是可以看到刚才上传的jar包的oozie提供的官方的jar没用，上传上来也不会坏了一锅汤 7.3.7、执行任务 $ bin/oozie job -oozie http://hadoop-senior01.itguigu.com:11000/oozie -config oozie-apps/map-reduce/job.properties -run 查看任务情况 7.4、案例四：Coordinator周期性调度任务（这个最后是没有成功的，start和stop配置的格式的问题，不要修改时区试试，毕竟修改时区是为了强迫症患者~） 7.4.1、配置Linux时区 详见Hive第一天Word文档 7.4.2、修改oozie-default.xml文件，涉及属性： ** 修改oozie的时区 oozie.processing.timezone GMT+0800（默认是UTC的） 7.4.3、修改js框架中的关于时间设置的代码 $ vi /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-server/webapps/oozie/oozie-console.js 修改如下： function getTimeZone() { Ext.state.Manager.setProvider(new Ext.state.CookieProvider()); return Ext.state.Manager.get(“TimezoneId”,“GMT+0800”); } 7.4.4、重启oozie服务，并重启浏览器（一定要注意清除缓存） $ bin/oozied.sh stop $ bin/oozied.sh start 然后重新查看时间 7.4.5、拷贝官方模板配置定时任务 $ cp -r /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/examples/apps/cron/ /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps/ 7.4.6、修改模板 job.properties nameNode=hdfs://hadoop-senior01.itguigu.com:8020 jobTracker=hadoop-senior02.itguigu.com:8032 queueName=default examplesRoot=oozie-apps oozie.coord.application.path=${nameNode}/user/${user.name}/${examplesRoot}/apps/cron #start：必须设置为未来时间，否则任务失败，一次都不会执行 start=2017-07-29T17:00+0800 end=2017-07-30T17:00+0800 workflowAppUri=${nameNode}/user/${user.name}/${examplesRoot}/cron EXEC1=p1.sh EXEC2=p2.sh coordinator.xml //frequency频率的意思，这里是每十分钟执行一次 //start 开始时间 引用前面的配置文件 end 结束时间 timezone时区 &lt;coordinator-app name=&quot;cron-coord&quot; frequency=&quot;${coord:minutes(10)}&quot; start=&quot;${start}&quot; end=&quot;${end}&quot; timezone=&quot;GMT+0800&quot; xmlns=&quot;uri:oozie:coordinator:0.2&quot;&gt; &lt;action&gt; &lt;workflow&gt; &lt;app-path&gt;${workflowAppUri}&lt;/app-path&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;jobTracker&lt;/name&gt; &lt;value&gt;${jobTracker}&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;nameNode&lt;/name&gt; &lt;value&gt;${nameNode}&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;queueName&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;/workflow&gt; &lt;/action&gt; &lt;/coordinator-app&gt; workflow.xml &lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.5&quot; name=&quot;one-op-wf&quot;&gt; &lt;start to=&quot;p1-shell-node&quot;/&gt; &lt;action name=&quot;p1-shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;exec&gt;${EXEC1}&lt;/exec&gt; &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC1}#${EXEC1}&lt;/file&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt;--&gt; &lt;capture-output/&gt; &lt;/shell&gt; &lt;ok to=&quot;p2-shell-node&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;action name=&quot;p2-shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;exec&gt;${EXEC2}&lt;/exec&gt; &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC2}#${EXEC2}&lt;/file&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt;--&gt; &lt;capture-output/&gt; &lt;/shell&gt; &lt;ok to=&quot;end&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;decision name=&quot;check-output&quot;&gt; &lt;switch&gt; &lt;case to=&quot;end&quot;&gt; ${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;] eq &#39;Hello Oozie&#39;} &lt;/case&gt; &lt;default to=&quot;fail-output&quot;/&gt; &lt;/switch&gt; &lt;/decision&gt; &lt;kill name=&quot;fail&quot;&gt; &lt;message&gt;Shell action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]&lt;/message&gt; &lt;/kill&gt; &lt;kill name=&quot;fail-output&quot;&gt; &lt;message&gt;Incorrect output, expected [Hello Oozie] but was [${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;]}]&lt;/message&gt; &lt;/kill&gt; &lt;end name=&quot;end&quot;/&gt; &lt;/workflow-app&gt; 7.4.7、上传配置，启动任务 $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/hdfs dfs -put oozie-apps/cron/ /user/admin/oozie-apps $ bin/oozie job -oozie http://hadoop-senior01.itguigu.com:11000/oozie -config oozie-apps/cron/job.properties -run (尖叫提示：oozie允许的最小执行任务的频率是5分钟) 小问题总结 （排查问题）： 1、Mysql权限配置 2、workflow.xml配置的时候不要忽略file属性 3、jps查看进程时，注意有没有bootstrap 4、关闭oozie ** bin/oozied.sh stop）如果无法关闭，则可以使用kill ** kill -9 11111 kill之后oozie-server/temp/xxx.pid文件一定要删除 5、Oozie重新打包时，一定要注意先关闭进程，删除对应文件夹下面的pid文件。（可以参考第4条目） 6、配置文件一定要生效 ** 起始标签和结束标签无对应则不生效 ** 配置文件的属性写错了，那么则执行默认的属性。 7、libext下边的jar存放于某个文件夹中，导致share/lib创建不成功 8、-rmr share/lib这样是不行的。 rm -rmr /user/admin这样删除是错误的。 9、调度任务时，找不到指定的脚本，可能是oozie-site.xml里面的Hadoop配置文件没有关联上 10、修改Hadoop配置文件，需要重启集群。一定要记得scp到其他节点 11、JobHistoryServer必须开启，集群要重启的。 12、Mysql配置如果没有生效的话，默认使用derby数据库 13、在本地修改完成的job配置，必须重新上传到HDFS 14、将HDFS上面的配置文件，下载下来查看是否有错误。 15、Linux用户名和Hadoop的用户名不一致。" />
<link rel="canonical" href="https://uzzz.org/2019/05/28/788450.html" />
<meta property="og:url" content="https://uzzz.org/2019/05/28/788450.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-05-28T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"文章目录 1、Oozie英文翻译 2、Oozie简介 3、Oozie在集群中扮演的角色 4、Oozie的功能模块 5、Oozie的节点 6、Oozie的安装与部署 7、案例 7.1、案例一：使用Oozie调度Shell脚本 7.2、案例二：执行多个Job调度 7.3、案例三：调度MapReduce任务 7.4、案例四：Coordinator周期性调度任务（这个最后是没有成功的，start和stop配置的格式的问题，不要修改时区试试，毕竟修改时区是为了强迫症患者~） 小问题总结 （排查问题）： 1、Oozie英文翻译 驯象人 2、Oozie简介 一个基于工作流引擎的开源框架，由Cloudera公司贡献给Apache，提供对Hadoop Mapreduce、Pig Jobs的任务调度与协调。 Oozie需要部署到Java Servlet容器中运行。 3、Oozie在集群中扮演的角色 定时调度任务，多任务可以按照执行的逻辑顺序调度。 4、Oozie的功能模块 4.1、Workflow 顺序执行流程节点，支持fork（分支多个节点），join（合并多个节点为一个） 4.2、Coordinator 定时触发workflow 4.3、Bundle Job 绑定多个Coordinator 5、Oozie的节点 5.1、控制流节点（Control Flow Nodes） 控制流节点一般都是定义在工作流开始或者结束的位置，比如start,end,kill等。以及提供工作流的执行路径机制， 如decision,fork,join等。 5.2、动作节点（Action Nodes） 就是执行具体任务动作的节点。 6、Oozie的安装与部署 6.1、解压Oozie（有桌面版的有非桌面版的，下面这个是桌面版的，ext-2.2.zip是非桌面版的） $ tar -zxf /opt/softwares/oozie-4.0.0-cdh5.3.6.tar.gz -C /opt/modules/cdh/ 6.2、Hadoop配置文件修改，完成后scp到其他机器节点 6.2.1、core-site.xml &lt;!-- Oozie Server的Hostname --&gt; //配置中的admin可以改为其他的用户，比如root &lt;property&gt; //代理的用户是admin &lt;name&gt;hadoop.proxyuser.admin.hosts&lt;/name&gt; &lt;value&gt;*&lt;/value&gt; &lt;/property&gt; &lt;!-- 允许被Oozie代理的用户组 --&gt; &lt;property&gt; //允许被Oozie代理的用户组是admin所在的组，admin所在的组，都允许被所有的用户代理 &lt;name&gt;hadoop.proxyuser.admin.groups&lt;/name&gt; &lt;value&gt;*&lt;/value&gt; &lt;/property&gt; 6.2.2、配置JobHistoryServer服务（必须） mapred-site.xml &lt;!-- 配置 MapReduce JobHistory Server 地址 ，通信，默认端口10020 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.jobhistory.address&lt;/name&gt; &lt;value&gt;hadoop-senior01.itguigu.com:10020&lt;/value&gt; &lt;/property&gt; &lt;!-- 配置 MapReduce JobHistory Server web ui 地址，展示web， 默认端口19888 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.jobhistory.webapp.address&lt;/name&gt; &lt;value&gt;hadoop-senior01.itguigu.com:19888&lt;/value&gt; &lt;/property&gt; yarn-site.xml &lt;!-- 任务历史服务 --&gt; &lt;property&gt; &lt;name&gt;yarn.log.server.url&lt;/name&gt; &lt;value&gt;http://hadoop-senior01.itguigu.com:19888/jobhistory/logs/&lt;/value&gt; &lt;/property&gt; 完成后：记得scp同步到其他机器节点 6.3、开启Hadoop集群 $ sh ~/start-cluster.sh（这是之前hive学习的时候的一个脚本：https://blog.csdn.net/dataiyangu/article/details/90116342#_126） 主要是最后一句话，开启JobHistoryServer jps看一下 尖叫提示：需要配合开启JobHistoryServer 最好执行一个MR任务进行测试。 succeeded说明成功了 6.4、解压hadooplibs $ tar -zxf /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-hadooplibs-4.0.0-cdh5.3.6.tar.gz -C /opt/modules/cdh/ 完成后Oozie目录下会出现hadooplibs目录 目录结构： 6.5、在Oozie目录下创建libext目录 $ mkdir libext/ 6.6、拷贝一些依赖的Jar包 6.6.1、将hadooplibs里面的jar包，拷贝到libext目录下 $ cp -ra /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/hadooplibs/hadooplib-2.5.0-cdh5.3.6.oozie-4.0.0-cdh5.3.6/* libext/ 6.6.2、拷贝Mysql驱动包到libext目录下 $ cp -a /opt/softwares/mysql-connector-java-5.1.27/mysql-connector-java-5.1.27-bin.jar /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/libext/ 如果不拷贝mysql的驱动包，Oozie会报错 6.7、将ext-2.2.zip拷贝到libext/目录下 $ cp /opt/softwares/ext-2.2.zip libext/ 6.8、修改Oozie配置文件 6.8.1、oozie-site.xml ** JDBC驱动 oozie.service.JPAService.jdbc.driver com.mysql.jdbc.Driver ** Mysql的oozie数据库的配置 oozie.service.JPAService.jdbc.url jdbc:mysql://192.168.122.20:3306/oozie ** 数据库用户名 oozie.service.JPAService.jdbc.username root ** 数据库密码 oozie.service.JPAService.jdbc.password 123456 ** 让Oozie引用Hadoop的配置文件 oozie.service.HadoopAccessorService.hadoop.configurations 真的就是这样：--&gt; *=/opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/etc/hadoop 6.9、在Mysql中创建Oozie的数据库 6.9.1、进入数据库 $ mysql -uroot -p123456 6.9.2、创建oozie数据库 mysql&gt; create database oozie; 6.10、初始化Oozie的配置 6.10.1、上传Oozie目录下的yarn.tar.gz文件到HDFS（尖叫提示：yarn.tar.gz文件会自行解压） $ bin/oozie-setup.sh sharelib create -fs hdfs://hadoop-senior01.itguigu.com:8020 -locallib oozie-sharelib-4.0.0-cdh5.3.6-yarn.tar.gz 执行成功之后，去50070检查对应目录有没有文件生成。 6.10.2、创建oozie.sql文件 $ bin/oozie-setup.sh db create -run -sqlfile oozie.sql cat oozie.sql 里面有很多oozie依赖的表结构 6.10.3、打包项目，生成war包 $ bin/oozie-setup.sh prepare-war 注意：在打包的过程中oozie线程没有被停掉的话，打包是失败的，如果oozie 的进程停掉了，一定会成功吗？cd oozie-server/temp 有一个safeToDelete.tmp临时文件，如果oozie在没有配置好的情况下，已经不小心的启动了，现在需要停掉重新打包，重新启动，如果有这个过程的话，一定要来temp目录下看一看，有没有.pid结尾的文件，如果有的话就删除掉，当然如果oozie跑着好好的，不要把.pid结尾的文件删除掉，否则就会导致oozie停不掉，只能kill掉 启动成功的话如下图： 6.11、启动Oozie服务 $ bin/oozied.sh start （关闭Oozie服务：$ bin/oozied.sh stop） 6.12、访问Oozie的Web页面 http://hadoop-senior01.itguigu.com:11000/oozie 如何查看异常？在logs目录下有catalina.out 7、案例 7.1、案例一：使用Oozie调度Shell脚本 7.1.1、解压官方案例模板 $ tar -zxf oozie-examples.tar.gz 7.1.2、创建工作目录 $ mkdir oozie-apps/ 7.1.3、拷贝任务模板到oozie-apps/目录 $ cp -r examples/apps/shell/ oozie-apps/ 在shell目录下有job.properties（当前任务调度的属性信息） 和 workflow.xml（调度任务的工作流），在oozie进行调度的时候，配置文件必须上传到hdfs系统，所以应该把这两个模板拷贝到自己的文件夹，修改完成之后上传到hdfs 7.1.4、随意编写一个脚本p1.sh $ vi /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps/shell/p1.log 内容如下： #!/bin/bash /usr/sbin/ifconfig &gt; /tmp/p1.log 7.1.5、修改job.properties和workflow.xml文件 ** job.properties #HDFS地址 //如果是集群的话就不要写8020了，写mycluster // //&lt;!-- 集群中NameNode节点都有哪些 --&gt; // &lt;property&gt; // //这里的mycluster和上面名称一致 // &lt;name&gt;dfs.ha.namenodes.mycluster&lt;/name&gt; // &lt;value&gt;nn1,nn2&lt;/value&gt; // &lt;/property&gt; nameNode=hdfs://hadoop-senior01.itguigu.com:8020 #ResourceManager地址 jobTracker=hadoop-senior02.itguigu.com:8032 #队列名称 //oozie在任务调度的时候会产生一个任务队列 queueName=default //存放job.properties 和 workflow.xml的目录 examplesRoot=oozie-apps //oozie app的存放路径 oozie.wf.application.path=${nameNode}/user/${user.name}/${examplesRoot}/shell //如果希望oozie调度某个脚本的话，就将这个脚本赋值给变量EXEC //脚本中的内容任意 EXEC=p1.sh p1.sh需要放在和job.properties 和 workflow.xml同目录的文件夹下， ** workflow.xml //workflow-app表示是一个workflow的工作调度 &lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.4&quot; name=&quot;shell-wf&quot;&gt; //任务在开始的时候，首先去执行谁 &lt;start to=&quot;shell-node&quot;/&gt; //action是一个任务 &lt;action name=&quot;shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; //这里的jobTracker、nameNode和queueName是直接引用的 job.properties 里面的内容 &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; //这里原来是echo 下面 argument中的内容 //这里我们改成执行我们的脚本 &lt;exec&gt;${EXEC}&lt;/exec&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt; --&gt; //注意后面的${EXEC}#${EXEC}，如果不这样写的话是找不到这个文件的 &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC}#${EXEC}&lt;/file&gt; &lt;capture-output/&gt; &lt;/shell&gt; //如果成功的话跳转到end &lt;ok to=&quot;end&quot;/&gt; //如果失败的话跳转到fail &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;decision name=&quot;check-output&quot;&gt; &lt;switch&gt; &lt;case to=&quot;end&quot;&gt; ${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;] eq &#39;Hello Oozie&#39;} &lt;/case&gt; &lt;default to=&quot;fail-output&quot;/&gt; &lt;/switch&gt; &lt;/decision&gt; //如果失败的话kill掉自己 &lt;kill name=&quot;fail&quot;&gt; &lt;message&gt;Shell action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]&lt;/message&gt; &lt;/kill&gt; &lt;kill name=&quot;fail-output&quot;&gt; &lt;message&gt;Incorrect output, expected [Hello Oozie] but was [${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;]}] &lt;/message&gt; &lt;/kill&gt; &lt;end name=&quot;end&quot;/&gt; &lt;/workflow-app&gt; 如果需要修改任务，需要kill掉当前的任务，从hdfs上删除原来的配置文件，然后上传新的配置文件，再重新启动。 7.1.6、上传任务配置 $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/hdfs dfs -put /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps /user/admin 7.1.7、执行任务 $ bin/oozie job -oozie http://hadoop-senior01.itguigu.com:11000/oozie -config oozie-apps/shell/job.properties -run http://hadoop-senior01.itguigu.com:11000/oozie oozie的服务器地址 -config oozie-apps/shell/job.properties 是oozie的配置文件 执行完之后会生成一个jobid，用于下面杀死某个任务 7.1.8、杀死某个任务 $ bin/oozie job -oozie http://hadoop-senior01.itguigu.com:11000/oozie -kill 0000004-170425105153692-oozie-z-W 查看页面： 双击打开会有一些任务信息 注意：如果某个任务没有成功调度的话，上图中是删除不掉的，也kill不掉，也就是说执行了上面的杀死命令，在这个页面中这个任务也还是存在的，那是不是没有办法了呢？可以进入mysql drop database oozie ; 删除掉oozie这个数据库，或者进入删除具体的某张表的某个数据。强迫症患者~哎，可以再use oozie ; seledt * from WF_ACTIONS里面看到，并删除。 如果成功的话在MapReduce中也是有oozie这个任务的，对应于ob.properties中的MapReduce配置 执行完了之后 all jobs里面刚才的任务没有了，因为到了done jobs里面 这个时候到第二台机器查看 ，刚才执行的脚本是将某个日志复制到某个目录 ，发现是没有的 因为MapReduce的调度，所以在放到了第三台 到第三台上查看 如果希望固定放到某个机器上，可以在脚本里面写 ssh 固定某台机器 7.2、案例二：执行多个Job调度 7.2.1、解压官方案例模板 job.properties nameNode=hdfs://hadoop-senior01.itguigu.com:8020 jobTracker=hadoop-senior02.itguigu.com:8032 queueName=default examplesRoot=oozie-apps oozie.wf.application.path=${nameNode}/user/${user.name}/${examplesRoot}/shell EXEC1=p1.sh EXEC2=p2.sh workflow.xml &lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.4&quot; name=&quot;shell-wf&quot;&gt; &lt;start to=&quot;p1-shell-node&quot;/&gt; &lt;action name=&quot;p1-shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;exec&gt;${EXEC1}&lt;/exec&gt; &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC1}#${EXEC1}&lt;/file&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt;--&gt; &lt;capture-output/&gt; &lt;/shell&gt; &lt;ok to=&quot;p2-shell-node&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;action name=&quot;p2-shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;exec&gt;${EXEC2}&lt;/exec&gt; &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC2}#${EXEC2}&lt;/file&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt;--&gt; &lt;capture-output/&gt; &lt;/shell&gt; &lt;ok to=&quot;end&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;decision name=&quot;check-output&quot;&gt; &lt;switch&gt; &lt;case to=&quot;end&quot;&gt; ${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;] eq &#39;Hello Oozie&#39;} &lt;/case&gt; &lt;default to=&quot;fail-output&quot;/&gt; &lt;/switch&gt; &lt;/decision&gt; &lt;kill name=&quot;fail&quot;&gt; &lt;message&gt;Shell action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]&lt;/message&gt; &lt;/kill&gt; &lt;kill name=&quot;fail-output&quot;&gt; &lt;message&gt;Incorrect output, expected [Hello Oozie] but was [${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;]}]&lt;/message&gt; &lt;/kill&gt; &lt;end name=&quot;end&quot;/&gt; &lt;/workflow-app&gt; 上面的配置文件主要是增加了一个actoin，第一个action不是to end 变成了，第二个才是 执行之前将之前上传的文件全部删掉，直接删掉原来的oozie-apps目录，然后重新上传、运行 测试时需要留意的点： 1、每个脚本是在哪台机器上执行的。 2、脚本的执行时间。 3、发现一个问题：执行任务的时间和本地时间不一致。它的时间是utc的，比北京的时间慢了八个小时。 7.3、案例三：调度MapReduce任务 7.3.1、先编写一个可以运行的MR任务的.jar包 7.3.2、拷贝官方模板到oozie-apps $ cp -r /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/examples/apps/map-reduce/ /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps/ 7.3.3、测试一下wordcount在yarn中的运行 $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/yarn jar hadoop-mapreduce-examples-2.5.0-cdh5.3.6.jar wordcount /input/ /output111/ 为什么要跑这个任务？一会在配置workflow的时候，需要用到MapReduce在运行的过程中出现的各种参数，比如mapclass、reduceclass、输出的类型等，如果代码是自己写的可以直接拷贝，但是如果不是自己写的，需要看代码的内部结构，比较麻烦，所以可以通过页面查看MapReduce的history，查看已经运行好的任务的参数。 可以到概览页面，然后点击history，再点击configuration，就能够看到各种参数 可以直接搜索找到需要的配置参数。 7.3.4、配置map-reduce任务 job.properties nameNode=hdfs://hadoop-senior01.itguigu.com:8020 jobTracker=hadoop-senior02.itguigu.com:8021 queueName=default examplesRoot=oozie-apps #hdfs://hadoop-senior01.itguigu.com:8020/user/admin/oozie-apps/map-reduce/workflow.xml oozie.wf.application.path=${nameNode}/user/${user.name}/${examplesRoot}/map-reduce/workflow.xml //输出路径可有可无，这里面的参数都是为了在下面的配置文件中进行引用的，可以在这里进行引用，也可以 //在下面的配置文件中写死。 outputDir=map-reduce workflow.xml &lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.2&quot; name=&quot;map-reduce-wf&quot;&gt; &lt;start to=&quot;mr-node&quot;/&gt; &lt;action name=&quot;mr-node&quot;&gt; //下面的configuration中的内容是对map-reduce生效的 &lt;map-reduce&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; //在运行之前可以做一些准备工作 &lt;prepare&gt; //删除output目录 &lt;delete path=&quot;${nameNode}/output/&quot;/&gt; &lt;/prepare&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;!-- 配置调度MR任务时，使用新的API，即MapReduce，老的是MapRed。改为true即可--&gt; &lt;property&gt; &lt;name&gt;mapred.mapper.new-api&lt;/name&gt; &lt;value&gt;true&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;mapred.reducer.new-api&lt;/name&gt; &lt;value&gt;true&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定Job Key输出类型 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.job.output.key.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.io.Text&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定Job Value输出类型 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.job.output.value.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.io.IntWritable&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定输入路径 --&gt; &lt;property&gt; &lt;name&gt;mapred.input.dir&lt;/name&gt; &lt;value&gt;/input/&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定输出路径 --&gt; &lt;property&gt; &lt;name&gt;mapred.output.dir&lt;/name&gt; &lt;value&gt;/output/&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定Map类 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.job.map.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.examples.WordCount$TokenizerMapper&lt;/value&gt; &lt;/property&gt; &lt;!-- 指定Reduce类 --&gt; &lt;property&gt; &lt;name&gt;mapreduce.job.reduce.class&lt;/name&gt; &lt;value&gt;org.apache.hadoop.examples.WordCount$IntSumReducer&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;mapred.map.tasks&lt;/name&gt; &lt;value&gt;1&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;/map-reduce&gt; &lt;ok to=&quot;end&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;kill name=&quot;fail&quot;&gt; &lt;message&gt;Map/Reduce failed, error message[${wf:errorMessage(wf:lastErrorNode())}]&lt;/message&gt; &lt;/kill&gt; &lt;end name=&quot;end&quot;/&gt; &lt;/workflow-app&gt; 7.3.5、拷贝待执行的jar包到map-reduce的lib目录下 $ cp -a /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/hadoop-mapreduce-examples-2.5.0-cdh5.3.6.jar ./ 7.3.6、上传配置好的app文件夹到HDFS $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/hdfs dfs -put map-reduce/ /user/admin/oozie-apps 是可以看到刚才上传的jar包的oozie提供的官方的jar没用，上传上来也不会坏了一锅汤 7.3.7、执行任务 $ bin/oozie job -oozie http://hadoop-senior01.itguigu.com:11000/oozie -config oozie-apps/map-reduce/job.properties -run 查看任务情况 7.4、案例四：Coordinator周期性调度任务（这个最后是没有成功的，start和stop配置的格式的问题，不要修改时区试试，毕竟修改时区是为了强迫症患者~） 7.4.1、配置Linux时区 详见Hive第一天Word文档 7.4.2、修改oozie-default.xml文件，涉及属性： ** 修改oozie的时区 oozie.processing.timezone GMT+0800（默认是UTC的） 7.4.3、修改js框架中的关于时间设置的代码 $ vi /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-server/webapps/oozie/oozie-console.js 修改如下： function getTimeZone() { Ext.state.Manager.setProvider(new Ext.state.CookieProvider()); return Ext.state.Manager.get(“TimezoneId”,“GMT+0800”); } 7.4.4、重启oozie服务，并重启浏览器（一定要注意清除缓存） $ bin/oozied.sh stop $ bin/oozied.sh start 然后重新查看时间 7.4.5、拷贝官方模板配置定时任务 $ cp -r /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/examples/apps/cron/ /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps/ 7.4.6、修改模板 job.properties nameNode=hdfs://hadoop-senior01.itguigu.com:8020 jobTracker=hadoop-senior02.itguigu.com:8032 queueName=default examplesRoot=oozie-apps oozie.coord.application.path=${nameNode}/user/${user.name}/${examplesRoot}/apps/cron #start：必须设置为未来时间，否则任务失败，一次都不会执行 start=2017-07-29T17:00+0800 end=2017-07-30T17:00+0800 workflowAppUri=${nameNode}/user/${user.name}/${examplesRoot}/cron EXEC1=p1.sh EXEC2=p2.sh coordinator.xml //frequency频率的意思，这里是每十分钟执行一次 //start 开始时间 引用前面的配置文件 end 结束时间 timezone时区 &lt;coordinator-app name=&quot;cron-coord&quot; frequency=&quot;${coord:minutes(10)}&quot; start=&quot;${start}&quot; end=&quot;${end}&quot; timezone=&quot;GMT+0800&quot; xmlns=&quot;uri:oozie:coordinator:0.2&quot;&gt; &lt;action&gt; &lt;workflow&gt; &lt;app-path&gt;${workflowAppUri}&lt;/app-path&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;jobTracker&lt;/name&gt; &lt;value&gt;${jobTracker}&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;nameNode&lt;/name&gt; &lt;value&gt;${nameNode}&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;queueName&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;/workflow&gt; &lt;/action&gt; &lt;/coordinator-app&gt; workflow.xml &lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.5&quot; name=&quot;one-op-wf&quot;&gt; &lt;start to=&quot;p1-shell-node&quot;/&gt; &lt;action name=&quot;p1-shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;exec&gt;${EXEC1}&lt;/exec&gt; &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC1}#${EXEC1}&lt;/file&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt;--&gt; &lt;capture-output/&gt; &lt;/shell&gt; &lt;ok to=&quot;p2-shell-node&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;action name=&quot;p2-shell-node&quot;&gt; &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt; &lt;job-tracker&gt;${jobTracker}&lt;/job-tracker&gt; &lt;name-node&gt;${nameNode}&lt;/name-node&gt; &lt;configuration&gt; &lt;property&gt; &lt;name&gt;mapred.job.queue.name&lt;/name&gt; &lt;value&gt;${queueName}&lt;/value&gt; &lt;/property&gt; &lt;/configuration&gt; &lt;exec&gt;${EXEC2}&lt;/exec&gt; &lt;file&gt;/user/admin/oozie-apps/shell/${EXEC2}#${EXEC2}&lt;/file&gt; &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt;--&gt; &lt;capture-output/&gt; &lt;/shell&gt; &lt;ok to=&quot;end&quot;/&gt; &lt;error to=&quot;fail&quot;/&gt; &lt;/action&gt; &lt;decision name=&quot;check-output&quot;&gt; &lt;switch&gt; &lt;case to=&quot;end&quot;&gt; ${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;] eq &#39;Hello Oozie&#39;} &lt;/case&gt; &lt;default to=&quot;fail-output&quot;/&gt; &lt;/switch&gt; &lt;/decision&gt; &lt;kill name=&quot;fail&quot;&gt; &lt;message&gt;Shell action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]&lt;/message&gt; &lt;/kill&gt; &lt;kill name=&quot;fail-output&quot;&gt; &lt;message&gt;Incorrect output, expected [Hello Oozie] but was [${wf:actionData(&#39;shell-node&#39;)[&#39;my_output&#39;]}]&lt;/message&gt; &lt;/kill&gt; &lt;end name=&quot;end&quot;/&gt; &lt;/workflow-app&gt; 7.4.7、上传配置，启动任务 $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/hdfs dfs -put oozie-apps/cron/ /user/admin/oozie-apps $ bin/oozie job -oozie http://hadoop-senior01.itguigu.com:11000/oozie -config oozie-apps/cron/job.properties -run (尖叫提示：oozie允许的最小执行任务的频率是5分钟) 小问题总结 （排查问题）： 1、Mysql权限配置 2、workflow.xml配置的时候不要忽略file属性 3、jps查看进程时，注意有没有bootstrap 4、关闭oozie ** bin/oozied.sh stop）如果无法关闭，则可以使用kill ** kill -9 11111 kill之后oozie-server/temp/xxx.pid文件一定要删除 5、Oozie重新打包时，一定要注意先关闭进程，删除对应文件夹下面的pid文件。（可以参考第4条目） 6、配置文件一定要生效 ** 起始标签和结束标签无对应则不生效 ** 配置文件的属性写错了，那么则执行默认的属性。 7、libext下边的jar存放于某个文件夹中，导致share/lib创建不成功 8、-rmr share/lib这样是不行的。 rm -rmr /user/admin这样删除是错误的。 9、调度任务时，找不到指定的脚本，可能是oozie-site.xml里面的Hadoop配置文件没有关联上 10、修改Hadoop配置文件，需要重启集群。一定要记得scp到其他节点 11、JobHistoryServer必须开启，集群要重启的。 12、Mysql配置如果没有生效的话，默认使用derby数据库 13、在本地修改完成的job配置，必须重新上传到HDFS 14、将HDFS上面的配置文件，下载下来查看是否有错误。 15、Linux用户名和Hadoop的用户名不一致。","@type":"BlogPosting","url":"https://uzzz.org/2019/05/28/788450.html","headline":"大数据学习笔记之Oozie（一）：Oozie入门","dateModified":"2019-05-28T00:00:00+08:00","datePublished":"2019-05-28T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://uzzz.org/2019/05/28/788450.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>大数据学习笔记之Oozie（一）：Oozie入门</h1>
        
        
        <ul style="display: block;">
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
 	    <li><a href="/donate/" style="line-height: unset;" target="_blank"><strong>Donate</strong></a></li>
        </ul>
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
<!-- match content ads -->
	        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
			<ins class="adsbygoogle"
			     style="display:block"
			     data-ad-format="autorelaxed"
			     data-ad-client="ca-pub-8889449066804352"
			     data-ad-slot="1928667997"></ins>
			<script>
			     (adsbygoogle = window.adsbygoogle || []).push({});
			</script>	



        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">  
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div id="content_views" class="markdown_views prism-atom-one-light"> 
  <!-- flowchart 箭头图标 勿删 --> 
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> 
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path> 
  </svg> 
  <p></p>
  <div class="toc">
   <h3>文章目录</h3>
   <ul>
    <li><a href="#1Oozie_2" rel="nofollow">1、Oozie英文翻译</a></li>
    <li><a href="#2Oozie_4" rel="nofollow">2、Oozie简介</a></li>
    <li><a href="#3Oozie_7" rel="nofollow">3、Oozie在集群中扮演的角色</a></li>
    <li><a href="#4Oozie_9" rel="nofollow">4、Oozie的功能模块</a></li>
    <li><a href="#5Oozie_18" rel="nofollow">5、Oozie的节点</a></li>
    <li><a href="#6Oozie_25" rel="nofollow">6、Oozie的安装与部署</a></li>
    <li><a href="#7_160" rel="nofollow">7、案例</a></li>
    <ul>
     <li><a href="#71OozieShell_161" rel="nofollow">7.1、案例一：使用Oozie调度Shell脚本</a></li>
     <li><a href="#72Job_294" rel="nofollow">7.2、案例二：执行多个Job调度</a></li>
     <li><a href="#73MapReduce_377" rel="nofollow">7.3、案例三：调度MapReduce任务</a></li>
     <li><a href="#74Coordinatorstartstop_504" rel="nofollow">7.4、案例四：Coordinator周期性调度任务（这个最后是没有成功的，start和stop配置的格式的问题，不要修改时区试试，毕竟修改时区是为了强迫症患者~）</a></li>
    </ul>
    <li><a href="#__636" rel="nofollow">小问题总结 （排查问题）：</a></li>
   </ul>
  </div>
  <p></p> 
  <h1><a id="1Oozie_2"></a>1、Oozie英文翻译</h1> 
  <p>驯象人</p> 
  <h1><a id="2Oozie_4"></a>2、Oozie简介</h1> 
  <p>一个基于工作流引擎的开源框架，由Cloudera公司贡献给Apache，提供对Hadoop Mapreduce、Pig Jobs的任务调度与协调。<br> Oozie需要部署到Java Servlet容器中运行。</p> 
  <h1><a id="3Oozie_7"></a>3、Oozie在集群中扮演的角色</h1> 
  <p>定时调度任务，多任务可以按照执行的逻辑顺序调度。</p> 
  <h1><a id="4Oozie_9"></a>4、Oozie的功能模块</h1> 
  <p>4.1、Workflow<br> 顺序执行流程节点，支持fork（分支多个节点），join（合并多个节点为一个）<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528063529262.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 4.2、Coordinator<br> 定时触发workflow</p> 
  <p>4.3、Bundle Job<br> 绑定多个Coordinator</p> 
  <h1><a id="5Oozie_18"></a>5、Oozie的节点</h1> 
  <p>5.1、控制流节点（Control Flow Nodes）<br> 控制流节点一般都是定义在工作流开始或者结束的位置，比如start,end,kill等。以及提供工作流的执行路径机制，<br> 如decision,fork,join等。</p> 
  <p>5.2、动作节点（Action Nodes）<br> 就是执行具体任务动作的节点。</p> 
  <h1><a id="6Oozie_25"></a>6、Oozie的安装与部署</h1> 
  <p>6.1、解压Oozie（有桌面版的有非桌面版的，下面这个是桌面版的，ext-2.2.zip是非桌面版的）<br> $ tar -zxf /opt/softwares/oozie-4.0.0-cdh5.3.6.tar.gz -C /opt/modules/cdh/<br> 6.2、Hadoop配置文件修改，完成后scp到其他机器节点<br> 6.2.1、core-site.xml</p> 
  <pre><code class="prism language-js"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Oozie Server的Hostname <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token comment">//配置中的admin可以改为其他的用户，比如root</span>
<span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
<span class="token comment">//代理的用户是admin</span>
<span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>hadoop<span class="token punctuation">.</span>proxyuser<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>hosts<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>value<span class="token operator">&gt;</span><span class="token operator">*</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 允许被Oozie代理的用户组 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
<span class="token comment">//允许被Oozie代理的用户组是admin所在的组，admin所在的组，都允许被所有的用户代理</span>
<span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>hadoop<span class="token punctuation">.</span>proxyuser<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>groups<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>value<span class="token operator">&gt;</span><span class="token operator">*</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
</code></pre> 
  <p>6.2.2、配置JobHistoryServer服务（必须）<br> mapred-site.xml</p> 
  <pre><code class="prism language-js"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 配置 MapReduce JobHistory Server 地址 ，通信，默认端口<span class="token number">10020</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapreduce<span class="token punctuation">.</span>jobhistory<span class="token punctuation">.</span>address<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>hadoop<span class="token operator">-</span>senior01<span class="token punctuation">.</span>itguigu<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">10020</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 配置 MapReduce JobHistory Server web ui 地址，展示web， 默认端口<span class="token number">19888</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapreduce<span class="token punctuation">.</span>jobhistory<span class="token punctuation">.</span>webapp<span class="token punctuation">.</span>address<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>hadoop<span class="token operator">-</span>senior01<span class="token punctuation">.</span>itguigu<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">19888</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
</code></pre> 
  <p>yarn-site.xml</p> 
  <pre><code class="prism language-js"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 任务历史服务 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>yarn<span class="token punctuation">.</span>log<span class="token punctuation">.</span>server<span class="token punctuation">.</span>url<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>hadoop<span class="token operator">-</span>senior01<span class="token punctuation">.</span>itguigu<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">19888</span><span class="token operator">/</span>jobhistory<span class="token operator">/</span>logs<span class="token operator">/</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span> 
<span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span> 
</code></pre> 
  <p>完成后：记得scp同步到其他机器节点<br> 6.3、开启Hadoop集群<br> $ sh ~/start-cluster.sh（这是之前hive学习的时候的一个脚本：<a href="https://blog.csdn.net/dataiyangu/article/details/90116342#_126%EF%BC%89" rel="nofollow">https://blog.csdn.net/dataiyangu/article/details/90116342#_126）</a><br> 主要是最后一句话，开启JobHistoryServer<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528065815296.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> jps看一下<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528065920427.png" alt="在这里插入图片描述"></p> 
  <p>尖叫提示：需要配合开启JobHistoryServer</p> 
  <p>最好执行一个MR任务进行测试。<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528070759868.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528070804837.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528070811163.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> succeeded说明成功了<br> 6.4、解压hadooplibs<br> $ tar -zxf /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-hadooplibs-4.0.0-cdh5.3.6.tar.gz -C /opt/modules/cdh/<br> 完成后Oozie目录下会出现hadooplibs目录</p> 
  <p>目录结构：<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528071621383.png" alt="在这里插入图片描述"></p> 
  <p>6.5、在Oozie目录下创建libext目录<br> $ mkdir libext/<br> 6.6、拷贝一些依赖的Jar包<br> 6.6.1、将hadooplibs里面的jar包，拷贝到libext目录下<br> $ cp -ra /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/hadooplibs/hadooplib-2.5.0-cdh5.3.6.oozie-4.0.0-cdh5.3.6/* libext/<br> 6.6.2、拷贝Mysql驱动包到libext目录下<br> $ cp -a /opt/softwares/mysql-connector-java-5.1.27/mysql-connector-java-5.1.27-bin.jar /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/libext/<br> 如果不拷贝mysql的驱动包，Oozie会报错<br> 6.7、将ext-2.2.zip拷贝到libext/目录下<br> $ cp /opt/softwares/ext-2.2.zip libext/<br> 6.8、修改Oozie配置文件<br> 6.8.1、oozie-site.xml</p> 
  <pre><code class="prism language-js"><span class="token operator">**</span> <span class="token constant">JDBC</span>驱动
oozie<span class="token punctuation">.</span>service<span class="token punctuation">.</span>JPAService<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>driver
com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>Driver                                           
                                                                
<span class="token operator">**</span> Mysql的oozie数据库的配置                                            
oozie<span class="token punctuation">.</span>service<span class="token punctuation">.</span>JPAService<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>url                               
jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.122</span><span class="token number">.20</span><span class="token punctuation">:</span><span class="token number">3306</span><span class="token operator">/</span>oozie                          
                                                                
<span class="token operator">**</span> 数据库用户名                                                       
oozie<span class="token punctuation">.</span>service<span class="token punctuation">.</span>JPAService<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>username                          
root                                                            
                                                                
<span class="token operator">**</span> 数据库密码                                                        
oozie<span class="token punctuation">.</span>service<span class="token punctuation">.</span>JPAService<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>password                          
<span class="token number">123456</span>                                                          
                                                                
<span class="token operator">**</span> 让Oozie引用Hadoop的配置文件                                          
oozie<span class="token punctuation">.</span>service<span class="token punctuation">.</span>HadoopAccessorService<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>configurations       
真的就是这样：<span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token operator">*=</span><span class="token operator">/</span>opt<span class="token operator">/</span>modules<span class="token operator">/</span>cdh<span class="token operator">/</span>hadoop<span class="token operator">-</span><span class="token number">2.5</span><span class="token number">.0</span><span class="token operator">-</span>cdh5<span class="token punctuation">.</span><span class="token number">3.6</span><span class="token operator">/</span>etc<span class="token operator">/</span>hadoop  						
</code></pre> 
  <p>6.9、在Mysql中创建Oozie的数据库<br> 6.9.1、进入数据库<br> $ mysql -uroot -p123456<br> 6.9.2、创建oozie数据库<br> mysql&gt; create database oozie;<br> 6.10、初始化Oozie的配置<br> 6.10.1、上传Oozie目录下的yarn.tar.gz文件到HDFS（尖叫提示：yarn.tar.gz文件会自行解压）<br> $ bin/oozie-setup.sh sharelib create -fs hdfs://hadoop-senior01.itguigu.com:8020 -locallib oozie-sharelib-4.0.0-cdh5.3.6-yarn.tar.gz</p> 
  <p>执行成功之后，去50070检查对应目录有没有文件生成。<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528072823163.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 6.10.2、创建oozie.sql文件<br> $ bin/oozie-setup.sh db create -run -sqlfile oozie.sql</p> 
  <p>cat oozie.sql<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528073150133.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 里面有很多oozie依赖的表结构<br> 6.10.3、打包项目，生成war包<br> $ bin/oozie-setup.sh prepare-war</p> 
  <p>注意：在打包的过程中oozie线程没有被停掉的话，打包是失败的，如果oozie 的进程停掉了，一定会成功吗？cd oozie-server/temp 有一个safeToDelete.tmp临时文件，如果oozie在没有配置好的情况下，已经不小心的启动了，现在需要停掉重新打包，重新启动，如果有这个过程的话，一定要来temp目录下看一看，有没有.pid结尾的文件，如果有的话就删除掉，当然如果oozie跑着好好的，不要把.pid结尾的文件删除掉，否则就会导致oozie停不掉，只能kill掉</p> 
  <p>启动成功的话如下图：<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528073847554.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 6.11、启动Oozie服务<br> $ bin/oozied.sh start<br> （关闭Oozie服务：$ bin/oozied.sh stop）<br> 6.12、访问Oozie的Web页面<br> <a href="http://hadoop-senior01.itguigu.com:11000/oozie" rel="nofollow">http://hadoop-senior01.itguigu.com:11000/oozie</a><br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528074037995.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> 
  <p>如何查看异常？在logs目录下有catalina.out</p> 
  <h1><a id="7_160"></a>7、案例</h1> 
  <h2><a id="71OozieShell_161"></a>7.1、案例一：使用Oozie调度Shell脚本</h2> 
  <p>7.1.1、解压官方案例模板<br> $ tar -zxf oozie-examples.tar.gz<br> 7.1.2、创建工作目录<br> $ mkdir oozie-apps/<br> 7.1.3、拷贝任务模板到oozie-apps/目录<br> $ cp -r examples/apps/shell/ oozie-apps/<br> 在shell目录下有job.properties（当前任务调度的属性信息） 和 workflow.xml（调度任务的工作流），在oozie进行调度的时候，配置文件必须上传到hdfs系统，所以应该把这两个模板拷贝到自己的文件夹，修改完成之后上传到hdfs<br> 7.1.4、<a href="http://xn--p1-uu2cmgz2or82adzjhh2c11dj21e.sh" rel="nofollow">随意编写一个脚本p1.sh</a><br> $ vi /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps/shell/p1.log<br> 内容如下：<br> #!/bin/bash<br> /usr/sbin/ifconfig &gt; /tmp/p1.log<br> 7.1.5、修改job.properties和workflow.xml文件<br> ** job.properties</p> 
  <pre><code class="prism language-js">#<span class="token constant">HDFS</span>地址
<span class="token comment">//如果是集群的话就不要写8020了，写mycluster</span>
<span class="token comment">//</span>
<span class="token comment">//&lt;!-- 集群中NameNode节点都有哪些 --&gt;</span>
<span class="token comment">// &lt;property&gt;</span>
<span class="token comment">// //这里的mycluster和上面名称一致</span>
<span class="token comment">// &lt;name&gt;dfs.ha.namenodes.mycluster&lt;/name&gt;</span>
<span class="token comment">// &lt;value&gt;nn1,nn2&lt;/value&gt;</span>
<span class="token comment">// &lt;/property&gt;</span>

nameNode<span class="token operator">=</span>hdfs<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>hadoop<span class="token operator">-</span>senior01<span class="token punctuation">.</span>itguigu<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">8020</span>
#ResourceManager地址
jobTracker<span class="token operator">=</span>hadoop<span class="token operator">-</span>senior02<span class="token punctuation">.</span>itguigu<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">8032</span>
#队列名称
<span class="token comment">//oozie在任务调度的时候会产生一个任务队列</span>
queueName<span class="token operator">=</span><span class="token keyword">default</span>
<span class="token comment">//存放job.properties 和 workflow.xml的目录</span>
examplesRoot<span class="token operator">=</span>oozie<span class="token operator">-</span>apps

<span class="token comment">//oozie app的存放路径</span>
oozie<span class="token punctuation">.</span>wf<span class="token punctuation">.</span>application<span class="token punctuation">.</span>path<span class="token operator">=</span>$<span class="token punctuation">{</span>nameNode<span class="token punctuation">}</span><span class="token operator">/</span>user<span class="token operator">/</span>$<span class="token punctuation">{</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span>examplesRoot<span class="token punctuation">}</span><span class="token operator">/</span>shell
<span class="token comment">//如果希望oozie调度某个脚本的话，就将这个脚本赋值给变量EXEC</span>
<span class="token comment">//脚本中的内容任意</span>
<span class="token constant">EXEC</span><span class="token operator">=</span>p1<span class="token punctuation">.</span>sh

</code></pre> 
  <p>p1.sh需要放在和job.properties 和 workflow.xml同目录的文件夹下，</p> 
  <p>** workflow.xml</p> 
  <pre><code class="prism language-js"><span class="token comment">//workflow-app表示是一个workflow的工作调度</span>
<span class="token operator">&lt;</span>workflow<span class="token operator">-</span>app xmlns<span class="token operator">=</span><span class="token string">"uri:oozie:workflow:0.4"</span> name<span class="token operator">=</span><span class="token string">"shell-wf"</span><span class="token operator">&gt;</span>
<span class="token comment">//任务在开始的时候，首先去执行谁</span>
    <span class="token operator">&lt;</span>start to<span class="token operator">=</span><span class="token string">"shell-node"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token comment">//action是一个任务</span>
    <span class="token operator">&lt;</span>action name<span class="token operator">=</span><span class="token string">"shell-node"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>shell xmlns<span class="token operator">=</span><span class="token string">"uri:oozie:shell-action:0.2"</span><span class="token operator">&gt;</span>
        <span class="token comment">//这里的jobTracker、nameNode和queueName是直接引用的 job.properties 里面的内容</span>
            <span class="token operator">&lt;</span>job<span class="token operator">-</span>tracker<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>jobTracker<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>job<span class="token operator">-</span>tracker<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>name<span class="token operator">-</span>node<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>nameNode<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">-</span>node<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>configuration<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapred<span class="token punctuation">.</span>job<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>name<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>queueName<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>
            <span class="token comment">//这里原来是echo 下面 argument中的内容</span>
            <span class="token comment">//这里我们改成执行我们的脚本</span>
            <span class="token operator">&lt;</span>exec<span class="token operator">&gt;</span>$<span class="token punctuation">{</span><span class="token constant">EXEC</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>exec<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token operator">&lt;</span>argument<span class="token operator">&gt;</span>my_output<span class="token operator">=</span>Hello Oozie<span class="token operator">&lt;</span><span class="token operator">/</span>argument<span class="token operator">&gt;</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token comment">//注意后面的${EXEC}#${EXEC}，如果不这样写的话是找不到这个文件的</span>
            <span class="token operator">&lt;</span>file<span class="token operator">&gt;</span><span class="token operator">/</span>user<span class="token operator">/</span>admin<span class="token operator">/</span>oozie<span class="token operator">-</span>apps<span class="token operator">/</span>shell<span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">EXEC</span><span class="token punctuation">}</span>#$<span class="token punctuation">{</span><span class="token constant">EXEC</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>file<span class="token operator">&gt;</span>

            <span class="token operator">&lt;</span>capture<span class="token operator">-</span>output<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>shell<span class="token operator">&gt;</span>
        <span class="token comment">//如果成功的话跳转到end</span>
        <span class="token operator">&lt;</span>ok to<span class="token operator">=</span><span class="token string">"end"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token comment">//如果失败的话跳转到fail</span>
        <span class="token operator">&lt;</span>error to<span class="token operator">=</span><span class="token string">"fail"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>action<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>decision name<span class="token operator">=</span><span class="token string">"check-output"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token keyword">switch</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token keyword">case</span> to<span class="token operator">=</span><span class="token string">"end"</span><span class="token operator">&gt;</span>
                $<span class="token punctuation">{</span>wf<span class="token punctuation">:</span><span class="token function">actionData</span><span class="token punctuation">(</span><span class="token string">'shell-node'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'my_output'</span><span class="token punctuation">]</span> eq <span class="token string">'Hello Oozie'</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">case</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token keyword">default</span> to<span class="token operator">=</span><span class="token string">"fail-output"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">switch</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>decision<span class="token operator">&gt;</span>
   <span class="token comment">//如果失败的话kill掉自己</span>
    <span class="token operator">&lt;</span>kill name<span class="token operator">=</span><span class="token string">"fail"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>message<span class="token operator">&gt;</span>Shell action failed<span class="token punctuation">,</span> error message<span class="token punctuation">[</span>$<span class="token punctuation">{</span>wf<span class="token punctuation">:</span><span class="token function">errorMessage</span><span class="token punctuation">(</span>wf<span class="token punctuation">:</span><span class="token function">lastErrorNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>message<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>kill<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>kill name<span class="token operator">=</span><span class="token string">"fail-output"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>message<span class="token operator">&gt;</span>Incorrect output<span class="token punctuation">,</span> expected <span class="token punctuation">[</span>Hello Oozie<span class="token punctuation">]</span> but was <span class="token punctuation">[</span>$<span class="token punctuation">{</span>wf<span class="token punctuation">:</span><span class="token function">actionData</span><span class="token punctuation">(</span><span class="token string">'shell-node'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'my_output'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>message<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>kill<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>end name<span class="token operator">=</span><span class="token string">"end"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>workflow<span class="token operator">-</span>app<span class="token operator">&gt;</span>
</code></pre> 
  <p>如果需要修改任务，需要kill掉当前的任务，从hdfs上删除原来的配置文件，然后上传新的配置文件，再重新启动。</p> 
  <p>7.1.6、上传任务配置<br> $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/hdfs dfs -put /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps /user/admin<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528082910550.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 7.1.7、执行任务<br> $ bin/oozie job -oozie <a href="http://hadoop-senior01.itguigu.com:11000/oozie" rel="nofollow">http://hadoop-senior01.itguigu.com:11000/oozie</a> -config oozie-apps/shell/job.properties -run</p> 
  <p><a href="http://hadoop-senior01.itguigu.com:11000/oozie" rel="nofollow">http://hadoop-senior01.itguigu.com:11000/oozie</a> oozie的服务器地址 -config oozie-apps/shell/job.properties 是oozie的配置文件<br> 执行完之后会生成一个jobid，用于下面杀死某个任务<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528083206602.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 7.1.8、杀死某个任务<br> $ bin/oozie job -oozie <a href="http://hadoop-senior01.itguigu.com:11000/oozie" rel="nofollow">http://hadoop-senior01.itguigu.com:11000/oozie</a> -kill 0000004-170425105153692-oozie-z-W</p> 
  <p>查看页面：<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528083339178.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 双击打开会有一些任务信息<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528083415914.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> 
  <p>注意：如果某个任务没有成功调度的话，上图中是删除不掉的，也kill不掉，也就是说执行了上面的杀死命令，在这个页面中这个任务也还是存在的，那是不是没有办法了呢？可以进入mysql drop database oozie ; 删除掉oozie这个数据库，或者进入删除具体的某张表的某个数据。强迫症患者~哎，可以再use oozie ; seledt * from WF_ACTIONS里面看到，并删除。</p> 
  <p>如果成功的话在MapReduce中也是有oozie这个任务的，对应于ob.properties中的MapReduce配置<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528083846652.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 执行完了之后<br> all jobs里面刚才的任务没有了，因为到了done jobs里面<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528084003483.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> 
  <p>这个时候到第二台机器查看 ，刚才执行的脚本是将某个日志复制到某个目录 ，发现是没有的<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528084336880.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 因为MapReduce的调度，所以在放到了第三台<br> 到第三台上查看<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528084425640.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 如果希望固定放到某个机器上，可以在脚本里面写 ssh 固定某台机器</p> 
  <h2><a id="72Job_294"></a>7.2、案例二：执行多个Job调度</h2> 
  <p>7.2.1、解压官方案例模板<br> job.properties</p> 
  <pre><code class="prism language-js">nameNode<span class="token operator">=</span>hdfs<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>hadoop<span class="token operator">-</span>senior01<span class="token punctuation">.</span>itguigu<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">8020</span>
        jobTracker<span class="token operator">=</span>hadoop<span class="token operator">-</span>senior02<span class="token punctuation">.</span>itguigu<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">8032</span>
        queueName<span class="token operator">=</span><span class="token keyword">default</span>
        examplesRoot<span class="token operator">=</span>oozie<span class="token operator">-</span>apps

        oozie<span class="token punctuation">.</span>wf<span class="token punctuation">.</span>application<span class="token punctuation">.</span>path<span class="token operator">=</span>$<span class="token punctuation">{</span>nameNode<span class="token punctuation">}</span><span class="token operator">/</span>user<span class="token operator">/</span>$<span class="token punctuation">{</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span>examplesRoot<span class="token punctuation">}</span><span class="token operator">/</span>shell
        <span class="token constant">EXEC1</span><span class="token operator">=</span>p1<span class="token punctuation">.</span>sh
        <span class="token constant">EXEC2</span><span class="token operator">=</span>p2<span class="token punctuation">.</span>sh

        workflow<span class="token punctuation">.</span>xml
<span class="token operator">&lt;</span>workflow<span class="token operator">-</span>app xmlns<span class="token operator">=</span><span class="token string">"uri:oozie:workflow:0.4"</span> name<span class="token operator">=</span><span class="token string">"shell-wf"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>start to<span class="token operator">=</span><span class="token string">"p1-shell-node"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>action name<span class="token operator">=</span><span class="token string">"p1-shell-node"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>shell xmlns<span class="token operator">=</span><span class="token string">"uri:oozie:shell-action:0.2"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>job<span class="token operator">-</span>tracker<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>jobTracker<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>job<span class="token operator">-</span>tracker<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>name<span class="token operator">-</span>node<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>nameNode<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">-</span>node<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>configuration<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapred<span class="token punctuation">.</span>job<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>name<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>queueName<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>exec<span class="token operator">&gt;</span>$<span class="token punctuation">{</span><span class="token constant">EXEC1</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>exec<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>file<span class="token operator">&gt;</span><span class="token operator">/</span>user<span class="token operator">/</span>admin<span class="token operator">/</span>oozie<span class="token operator">-</span>apps<span class="token operator">/</span>shell<span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">EXEC1</span><span class="token punctuation">}</span>#$<span class="token punctuation">{</span><span class="token constant">EXEC1</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>file<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token operator">&lt;</span>argument<span class="token operator">&gt;</span>my_output<span class="token operator">=</span>Hello Oozie<span class="token operator">&lt;</span><span class="token operator">/</span>argument<span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>capture<span class="token operator">-</span>output<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>shell<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ok to<span class="token operator">=</span><span class="token string">"p2-shell-node"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>error to<span class="token operator">=</span><span class="token string">"fail"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>action<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>action name<span class="token operator">=</span><span class="token string">"p2-shell-node"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>shell xmlns<span class="token operator">=</span><span class="token string">"uri:oozie:shell-action:0.2"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>job<span class="token operator">-</span>tracker<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>jobTracker<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>job<span class="token operator">-</span>tracker<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>name<span class="token operator">-</span>node<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>nameNode<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">-</span>node<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>configuration<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapred<span class="token punctuation">.</span>job<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>name<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>queueName<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>exec<span class="token operator">&gt;</span>$<span class="token punctuation">{</span><span class="token constant">EXEC2</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>exec<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>file<span class="token operator">&gt;</span><span class="token operator">/</span>user<span class="token operator">/</span>admin<span class="token operator">/</span>oozie<span class="token operator">-</span>apps<span class="token operator">/</span>shell<span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">EXEC2</span><span class="token punctuation">}</span>#$<span class="token punctuation">{</span><span class="token constant">EXEC2</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>file<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token operator">&lt;</span>argument<span class="token operator">&gt;</span>my_output<span class="token operator">=</span>Hello Oozie<span class="token operator">&lt;</span><span class="token operator">/</span>argument<span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>capture<span class="token operator">-</span>output<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>shell<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ok to<span class="token operator">=</span><span class="token string">"end"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>error to<span class="token operator">=</span><span class="token string">"fail"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>action<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>decision name<span class="token operator">=</span><span class="token string">"check-output"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token keyword">switch</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token keyword">case</span> to<span class="token operator">=</span><span class="token string">"end"</span><span class="token operator">&gt;</span>
                $<span class="token punctuation">{</span>wf<span class="token punctuation">:</span><span class="token function">actionData</span><span class="token punctuation">(</span><span class="token string">'shell-node'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'my_output'</span><span class="token punctuation">]</span> eq <span class="token string">'Hello Oozie'</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">case</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token keyword">default</span> to<span class="token operator">=</span><span class="token string">"fail-output"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">switch</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>decision<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>kill name<span class="token operator">=</span><span class="token string">"fail"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>message<span class="token operator">&gt;</span>Shell action failed<span class="token punctuation">,</span> error message<span class="token punctuation">[</span>$<span class="token punctuation">{</span>wf<span class="token punctuation">:</span><span class="token function">errorMessage</span><span class="token punctuation">(</span>wf<span class="token punctuation">:</span><span class="token function">lastErrorNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>message<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>kill<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>kill name<span class="token operator">=</span><span class="token string">"fail-output"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>message<span class="token operator">&gt;</span>Incorrect output<span class="token punctuation">,</span> expected <span class="token punctuation">[</span>Hello Oozie<span class="token punctuation">]</span> but was <span class="token punctuation">[</span>$<span class="token punctuation">{</span>wf<span class="token punctuation">:</span><span class="token function">actionData</span><span class="token punctuation">(</span><span class="token string">'shell-node'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'my_output'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>message<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>kill<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>end name<span class="token operator">=</span><span class="token string">"end"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>workflow<span class="token operator">-</span>app<span class="token operator">&gt;</span>
</code></pre> 
  <p>上面的配置文件主要是增加了一个actoin，第一个action不是to end 变成了，第二个才是</p> 
  <p>执行之前将之前上传的文件全部删掉，直接删掉原来的oozie-apps目录，然后重新上传、运行<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528123513384.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> 
  <p>测试时需要留意的点：<br> 1、每个脚本是在哪台机器上执行的。<br> 2、脚本的执行时间。<br> 3、发现一个问题：执行任务的时间和本地时间不一致。它的时间是utc的，比北京的时间慢了八个小时。</p> 
  <h2><a id="73MapReduce_377"></a>7.3、案例三：调度MapReduce任务</h2> 
  <p>7.3.1、先编写一个可以运行的MR任务的.jar包<br> 7.3.2、拷贝官方模板到oozie-apps</p> 
  <pre><code class="prism language-js">$ cp <span class="token operator">-</span>r <span class="token operator">/</span>opt<span class="token operator">/</span>modules<span class="token operator">/</span>cdh<span class="token operator">/</span>oozie<span class="token operator">-</span><span class="token number">4.0</span><span class="token number">.0</span><span class="token operator">-</span>cdh5<span class="token punctuation">.</span><span class="token number">3.6</span><span class="token operator">/</span>examples<span class="token operator">/</span>apps<span class="token operator">/</span>map<span class="token operator">-</span>reduce<span class="token operator">/</span> <span class="token operator">/</span>opt<span class="token operator">/</span>modules<span class="token operator">/</span>cdh<span class="token operator">/</span>oozie<span class="token operator">-</span><span class="token number">4.0</span><span class="token number">.0</span><span class="token operator">-</span>cdh5<span class="token punctuation">.</span><span class="token number">3.6</span><span class="token operator">/</span>oozie<span class="token operator">-</span>apps<span class="token operator">/</span>
</code></pre> 
  <p>7.3.3、测试一下wordcount在yarn中的运行<br> $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/yarn jar hadoop-mapreduce-examples-2.5.0-cdh5.3.6.jar wordcount /input/ /output111/</p> 
  <p>为什么要跑这个任务？一会在配置workflow的时候，需要用到MapReduce在运行的过程中出现的各种参数，比如mapclass、reduceclass、输出的类型等，如果代码是自己写的可以直接拷贝，但是如果不是自己写的，需要看代码的内部结构，比较麻烦，所以可以通过页面查看MapReduce的history，查看已经运行好的任务的参数。<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528130631272.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 可以到概览页面，然后点击history，再点击configuration，就能够看到各种参数<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528130823263.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 可以直接搜索找到需要的配置参数。</p> 
  <p>7.3.4、配置map-reduce任务<br> job.properties</p> 
  <pre><code class="prism language-js">nameNode<span class="token operator">=</span>hdfs<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>hadoop<span class="token operator">-</span>senior01<span class="token punctuation">.</span>itguigu<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">8020</span>
jobTracker<span class="token operator">=</span>hadoop<span class="token operator">-</span>senior02<span class="token punctuation">.</span>itguigu<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">8021</span>
queueName<span class="token operator">=</span><span class="token keyword">default</span>
examplesRoot<span class="token operator">=</span>oozie<span class="token operator">-</span>apps
#hdfs<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>hadoop<span class="token operator">-</span>senior01<span class="token punctuation">.</span>itguigu<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">8020</span><span class="token operator">/</span>user<span class="token operator">/</span>admin<span class="token operator">/</span>oozie<span class="token operator">-</span>apps<span class="token operator">/</span>map<span class="token operator">-</span>reduce<span class="token operator">/</span>workflow<span class="token punctuation">.</span>xml
        oozie<span class="token punctuation">.</span>wf<span class="token punctuation">.</span>application<span class="token punctuation">.</span>path<span class="token operator">=</span>$<span class="token punctuation">{</span>nameNode<span class="token punctuation">}</span><span class="token operator">/</span>user<span class="token operator">/</span>$<span class="token punctuation">{</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span>examplesRoot<span class="token punctuation">}</span><span class="token operator">/</span>map<span class="token operator">-</span>reduce<span class="token operator">/</span>workflow<span class="token punctuation">.</span>xml
<span class="token comment">//输出路径可有可无，这里面的参数都是为了在下面的配置文件中进行引用的，可以在这里进行引用，也可以</span>
<span class="token comment">//在下面的配置文件中写死。</span>
outputDir<span class="token operator">=</span>map<span class="token operator">-</span>reduce
</code></pre> 
  <pre><code class="prism language-js">workflow<span class="token punctuation">.</span>xml
<span class="token operator">&lt;</span>workflow<span class="token operator">-</span>app xmlns<span class="token operator">=</span><span class="token string">"uri:oozie:workflow:0.2"</span> name<span class="token operator">=</span><span class="token string">"map-reduce-wf"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>start to<span class="token operator">=</span><span class="token string">"mr-node"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>action name<span class="token operator">=</span><span class="token string">"mr-node"</span><span class="token operator">&gt;</span>
    	<span class="token comment">//下面的configuration中的内容是对map-reduce生效的</span>
        <span class="token operator">&lt;</span>map<span class="token operator">-</span>reduce<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>job<span class="token operator">-</span>tracker<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>jobTracker<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>job<span class="token operator">-</span>tracker<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>name<span class="token operator">-</span>node<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>nameNode<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">-</span>node<span class="token operator">&gt;</span>
            <span class="token comment">//在运行之前可以做一些准备工作</span>
            <span class="token operator">&lt;</span>prepare<span class="token operator">&gt;</span>
            <span class="token comment">//删除output目录</span>
                <span class="token operator">&lt;</span><span class="token keyword">delete</span> path<span class="token operator">=</span><span class="token string">"${nameNode}/output/"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>prepare<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>configuration<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapred<span class="token punctuation">.</span>job<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>name<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>queueName<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 配置调度<span class="token constant">MR</span>任务时，使用新的<span class="token constant">API</span>，即MapReduce，老的是MapRed。改为<span class="token boolean">true</span>即可<span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapred<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token operator">-</span>api<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span><span class="token boolean">true</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapred<span class="token punctuation">.</span>reducer<span class="token punctuation">.</span><span class="token keyword">new</span><span class="token operator">-</span>api<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span><span class="token boolean">true</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 指定Job Key输出类型 <span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>output<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Text<span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 指定Job Value输出类型 <span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>output<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IntWritable<span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 指定输入路径 <span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapred<span class="token punctuation">.</span>input<span class="token punctuation">.</span>dir<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span><span class="token operator">/</span>input<span class="token operator">/</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 指定输出路径 <span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapred<span class="token punctuation">.</span>output<span class="token punctuation">.</span>dir<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span><span class="token operator">/</span>output<span class="token operator">/</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 指定Map类 <span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>examples<span class="token punctuation">.</span>WordCount$TokenizerMapper<span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 指定Reduce类 <span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>reduce<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>examples<span class="token punctuation">.</span>WordCount$IntSumReducer<span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapred<span class="token punctuation">.</span>map<span class="token punctuation">.</span>tasks<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>

            <span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>map<span class="token operator">-</span>reduce<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ok to<span class="token operator">=</span><span class="token string">"end"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>error to<span class="token operator">=</span><span class="token string">"fail"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>action<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>kill name<span class="token operator">=</span><span class="token string">"fail"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>message<span class="token operator">&gt;</span>Map<span class="token operator">/</span>Reduce failed<span class="token punctuation">,</span> error message<span class="token punctuation">[</span>$<span class="token punctuation">{</span>wf<span class="token punctuation">:</span><span class="token function">errorMessage</span><span class="token punctuation">(</span>wf<span class="token punctuation">:</span><span class="token function">lastErrorNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>message<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>kill<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>end name<span class="token operator">=</span><span class="token string">"end"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>workflow<span class="token operator">-</span>app<span class="token operator">&gt;</span>
</code></pre> 
  <p>7.3.5、拷贝待执行的jar包到map-reduce的lib目录下<br> $ cp -a /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/hadoop-mapreduce-examples-2.5.0-cdh5.3.6.jar ./<br> 7.3.6、上传配置好的app文件夹到HDFS<br> $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/hdfs dfs -put map-reduce/ /user/admin/oozie-apps</p> 
  <p><img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528132455401.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 是可以看到刚才上传的jar包的oozie提供的官方的jar没用，上传上来也不会坏了一锅汤<br> 7.3.7、执行任务<br> $ bin/oozie job -oozie <a href="http://hadoop-senior01.itguigu.com:11000/oozie" rel="nofollow">http://hadoop-senior01.itguigu.com:11000/oozie</a> -config oozie-apps/map-reduce/job.properties -run</p> 
  <p>查看任务情况<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528133014690.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> 
  <h2><a id="74Coordinatorstartstop_504"></a>7.4、案例四：Coordinator周期性调度任务（这个最后是没有成功的，start和stop配置的格式的问题，不要修改时区试试，毕竟修改时区是为了强迫症患者~）</h2> 
  <p>7.4.1、配置Linux时区<br> 详见Hive第一天Word文档<br> 7.4.2、修改oozie-default.xml文件，涉及属性：<br> ** 修改oozie的时区<br> oozie.processing.timezone<br> GMT+0800（默认是UTC的）<br> 7.4.3、修改js框架中的关于时间设置的代码<br> $ vi /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-server/webapps/oozie/oozie-console.js</p> 
  <p>修改如下：<br> function getTimeZone() {<br> Ext.state.Manager.setProvider(new Ext.state.CookieProvider());<br> return Ext.state.Manager.get(“TimezoneId”,“GMT+0800”);<br> }<br> 7.4.4、重启oozie服务，并重启浏览器（一定要注意清除缓存）<br> $ bin/oozied.sh stop<br> $ bin/oozied.sh start<br> 然后重新查看时间<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190528133612590.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> 7.4.5、拷贝官方模板配置定时任务<br> $ cp -r /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/examples/apps/cron/ /opt/modules/cdh/oozie-4.0.0-cdh5.3.6/oozie-apps/<br> 7.4.6、修改模板<br> job.properties</p> 
  <pre><code class="prism language-js">nameNode<span class="token operator">=</span>hdfs<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>hadoop<span class="token operator">-</span>senior01<span class="token punctuation">.</span>itguigu<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">8020</span>
jobTracker<span class="token operator">=</span>hadoop<span class="token operator">-</span>senior02<span class="token punctuation">.</span>itguigu<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">8032</span>
queueName<span class="token operator">=</span><span class="token keyword">default</span>
examplesRoot<span class="token operator">=</span>oozie<span class="token operator">-</span>apps

        oozie<span class="token punctuation">.</span>coord<span class="token punctuation">.</span>application<span class="token punctuation">.</span>path<span class="token operator">=</span>$<span class="token punctuation">{</span>nameNode<span class="token punctuation">}</span><span class="token operator">/</span>user<span class="token operator">/</span>$<span class="token punctuation">{</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span>examplesRoot<span class="token punctuation">}</span><span class="token operator">/</span>apps<span class="token operator">/</span>cron
#start：必须设置为未来时间，否则任务失败，一次都不会执行
start<span class="token operator">=</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">29</span>T17<span class="token punctuation">:</span><span class="token number">00</span><span class="token operator">+</span><span class="token number">0800</span>
end<span class="token operator">=</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">30</span>T17<span class="token punctuation">:</span><span class="token number">00</span><span class="token operator">+</span><span class="token number">0800</span>
workflowAppUri<span class="token operator">=</span>$<span class="token punctuation">{</span>nameNode<span class="token punctuation">}</span><span class="token operator">/</span>user<span class="token operator">/</span>$<span class="token punctuation">{</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span>examplesRoot<span class="token punctuation">}</span><span class="token operator">/</span>cron

<span class="token constant">EXEC1</span><span class="token operator">=</span>p1<span class="token punctuation">.</span>sh
<span class="token constant">EXEC2</span><span class="token operator">=</span>p2<span class="token punctuation">.</span>sh
</code></pre> 
  <p>coordinator.xml</p> 
  <pre><code class="prism language-js"><span class="token comment">//frequency频率的意思，这里是每十分钟执行一次</span>
<span class="token comment">//start 开始时间 引用前面的配置文件 end 结束时间 timezone时区</span>
<span class="token operator">&lt;</span>coordinator<span class="token operator">-</span>app name<span class="token operator">=</span><span class="token string">"cron-coord"</span> frequency<span class="token operator">=</span><span class="token string">"${coord:minutes(10)}"</span> start<span class="token operator">=</span><span class="token string">"${start}"</span> end<span class="token operator">=</span><span class="token string">"${end}"</span> timezone<span class="token operator">=</span><span class="token string">"GMT+0800"</span> xmlns<span class="token operator">=</span><span class="token string">"uri:oozie:coordinator:0.2"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>action<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>workflow<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>app<span class="token operator">-</span>path<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>workflowAppUri<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>app<span class="token operator">-</span>path<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>configuration<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>jobTracker<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>jobTracker<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>nameNode<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>nameNode<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>queueName<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>queueName<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>workflow<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>action<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>coordinator<span class="token operator">-</span>app<span class="token operator">&gt;</span>
</code></pre> 
  <p>workflow.xml</p> 
  <pre><code class="prism language-js"><span class="token operator">&lt;</span>workflow<span class="token operator">-</span>app xmlns<span class="token operator">=</span><span class="token string">"uri:oozie:workflow:0.5"</span> name<span class="token operator">=</span><span class="token string">"one-op-wf"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>start to<span class="token operator">=</span><span class="token string">"p1-shell-node"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>action name<span class="token operator">=</span><span class="token string">"p1-shell-node"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>shell xmlns<span class="token operator">=</span><span class="token string">"uri:oozie:shell-action:0.2"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>job<span class="token operator">-</span>tracker<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>jobTracker<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>job<span class="token operator">-</span>tracker<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>name<span class="token operator">-</span>node<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>nameNode<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">-</span>node<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>configuration<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapred<span class="token punctuation">.</span>job<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>name<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>queueName<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>exec<span class="token operator">&gt;</span>$<span class="token punctuation">{</span><span class="token constant">EXEC1</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>exec<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>file<span class="token operator">&gt;</span><span class="token operator">/</span>user<span class="token operator">/</span>admin<span class="token operator">/</span>oozie<span class="token operator">-</span>apps<span class="token operator">/</span>shell<span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">EXEC1</span><span class="token punctuation">}</span>#$<span class="token punctuation">{</span><span class="token constant">EXEC1</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>file<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token operator">&lt;</span>argument<span class="token operator">&gt;</span>my_output<span class="token operator">=</span>Hello Oozie<span class="token operator">&lt;</span><span class="token operator">/</span>argument<span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>capture<span class="token operator">-</span>output<span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>shell<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ok to<span class="token operator">=</span><span class="token string">"p2-shell-node"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>error to<span class="token operator">=</span><span class="token string">"fail"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>action<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>action name<span class="token operator">=</span><span class="token string">"p2-shell-node"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>shell xmlns<span class="token operator">=</span><span class="token string">"uri:oozie:shell-action:0.2"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>job<span class="token operator">-</span>tracker<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>jobTracker<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>job<span class="token operator">-</span>tracker<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>name<span class="token operator">-</span>node<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>nameNode<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">-</span>node<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>configuration<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>mapred<span class="token punctuation">.</span>job<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>name<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>$<span class="token punctuation">{</span>queueName<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>value<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>exec<span class="token operator">&gt;</span>$<span class="token punctuation">{</span><span class="token constant">EXEC2</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>exec<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>file<span class="token operator">&gt;</span><span class="token operator">/</span>user<span class="token operator">/</span>admin<span class="token operator">/</span>oozie<span class="token operator">-</span>apps<span class="token operator">/</span>shell<span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">EXEC2</span><span class="token punctuation">}</span>#$<span class="token punctuation">{</span><span class="token constant">EXEC2</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>file<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token operator">&lt;</span>argument<span class="token operator">&gt;</span>my_output<span class="token operator">=</span>Hello Oozie<span class="token operator">&lt;</span><span class="token operator">/</span>argument<span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>capture<span class="token operator">-</span>output<span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>shell<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ok to<span class="token operator">=</span><span class="token string">"end"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>error to<span class="token operator">=</span><span class="token string">"fail"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>action<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>decision name<span class="token operator">=</span><span class="token string">"check-output"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">switch</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token keyword">case</span> to<span class="token operator">=</span><span class="token string">"end"</span><span class="token operator">&gt;</span>
            $<span class="token punctuation">{</span>wf<span class="token punctuation">:</span><span class="token function">actionData</span><span class="token punctuation">(</span><span class="token string">'shell-node'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'my_output'</span><span class="token punctuation">]</span> eq <span class="token string">'Hello Oozie'</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">case</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token keyword">default</span> to<span class="token operator">=</span><span class="token string">"fail-output"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">switch</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>decision<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>kill name<span class="token operator">=</span><span class="token string">"fail"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>message<span class="token operator">&gt;</span>Shell action failed<span class="token punctuation">,</span> error message<span class="token punctuation">[</span>$<span class="token punctuation">{</span>wf<span class="token punctuation">:</span><span class="token function">errorMessage</span><span class="token punctuation">(</span>wf<span class="token punctuation">:</span><span class="token function">lastErrorNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>message<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>kill<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>kill name<span class="token operator">=</span><span class="token string">"fail-output"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>message<span class="token operator">&gt;</span>Incorrect output<span class="token punctuation">,</span> expected <span class="token punctuation">[</span>Hello Oozie<span class="token punctuation">]</span> but was <span class="token punctuation">[</span>$<span class="token punctuation">{</span>wf<span class="token punctuation">:</span><span class="token function">actionData</span><span class="token punctuation">(</span><span class="token string">'shell-node'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'my_output'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>message<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>kill<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>end name<span class="token operator">=</span><span class="token string">"end"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>workflow<span class="token operator">-</span>app<span class="token operator">&gt;</span>
</code></pre> 
  <p>7.4.7、上传配置，启动任务<br> $ /opt/modules/cdh/hadoop-2.5.0-cdh5.3.6/bin/hdfs dfs -put oozie-apps/cron/ /user/admin/oozie-apps<br> $ bin/oozie job -oozie <a href="http://hadoop-senior01.itguigu.com:11000/oozie" rel="nofollow">http://hadoop-senior01.itguigu.com:11000/oozie</a> -config oozie-apps/cron/job.properties -run<br> (尖叫提示：oozie允许的最小执行任务的频率是5分钟)</p> 
  <h1><a id="__636"></a>小问题总结 （排查问题）：</h1> 
  <pre><code>1、Mysql权限配置
2、workflow.xml配置的时候不要忽略file属性
3、jps查看进程时，注意有没有bootstrap
4、关闭oozie
	** bin/oozied.sh stop）如果无法关闭，则可以使用kill
	** kill -9 11111
		kill之后oozie-server/temp/xxx.pid文件一定要删除
5、Oozie重新打包时，一定要注意先关闭进程，删除对应文件夹下面的pid文件。（可以参考第4条目）
6、配置文件一定要生效
	** 起始标签和结束标签无对应则不生效
	** 配置文件的属性写错了，那么则执行默认的属性。
7、libext下边的jar存放于某个文件夹中，导致share/lib创建不成功
8、-rmr share/lib这样是不行的。 rm -rmr /user/admin这样删除是错误的。
9、调度任务时，找不到指定的脚本，可能是oozie-site.xml里面的Hadoop配置文件没有关联上
10、修改Hadoop配置文件，需要重启集群。一定要记得scp到其他节点
11、JobHistoryServer必须开启，集群要重启的。
12、Mysql配置如果没有生效的话，默认使用derby数据库
13、在本地修改完成的job配置，必须重新上传到HDFS
14、将HDFS上面的配置文件，下载下来查看是否有错误。
15、Linux用户名和Hadoop的用户名不一致。
</code></pre> 
 </div> 
 <link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-258a4616f7.css" rel="stylesheet"> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d293c49e1e4bfe8f276695a5aa953300";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
