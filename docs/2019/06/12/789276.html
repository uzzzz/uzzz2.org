<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>yolov3学习笔记系列一、计算map | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="yolov3学习笔记系列一、计算map" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="一、使用valid批处理输出检测结果文本 运行指令 ./darknet detector valid cfg/voc.data cfg/yolo-voc.cfg backup/yolo-voc_final.weights 在darknet中执行以上代码，yolo将把检测结果输出保存darknet/result 目录下。 二、使用voc_eval.py计算mAP # -------------------------------------------------------- # Fast/er R-CNN # Licensed under The MIT License [see LICENSE for details] # Written by Bharath Hariharan # -------------------------------------------------------- import xml.etree.ElementTree as ET import os import cPickle import numpy as np def parse_rec(filename): #通过ET解析xml后返回一个obj &quot;&quot;&quot; Parse a PASCAL VOC xml file &quot;&quot;&quot; tree = ET.parse(filename) objects = [] for obj in tree.findall(&#39;object&#39;): obj_struct = {} obj_struct[&#39;name&#39;] = obj.find(&#39;name&#39;).text obj_struct[&#39;pose&#39;] = obj.find(&#39;pose&#39;).text obj_struct[&#39;truncated&#39;] = int(obj.find(&#39;truncated&#39;).text) obj_struct[&#39;difficult&#39;] = int(obj.find(&#39;difficult&#39;).text) bbox = obj.find(&#39;bndbox&#39;) obj_struct[&#39;bbox&#39;] = [int(bbox.find(&#39;xmin&#39;).text), int(bbox.find(&#39;ymin&#39;).text), int(bbox.find(&#39;xmax&#39;).text), int(bbox.find(&#39;ymax&#39;).text)] objects.append(obj_struct) #objects格式为 [{&#39;name&#39;:egret,&#39;pose&#39;:Unspecifie等},{&#39;name&#39;:egret,&#39;pose&#39;:Unspecifie等}] return objects def voc_ap(rec, prec, use_07_metric=False): &quot;&quot;&quot; ap = voc_ap(rec, prec, [use_07_metric]) Compute VOC AP given precision and recall. If use_07_metric is true, uses the VOC 07 11 point method (default:False). &quot;&quot;&quot; if use_07_metric: # 11 point metric ap = 0. for t in np.arange(0., 1.1, 0.1): if np.sum(rec &gt;= t) == 0: p = 0 else: p = np.max(prec[rec &gt;= t]) ap = ap + p / 11. else: # correct AP calculation # first append sentinel values at the end mrec = np.concatenate(([0.], rec, [1.])) mpre = np.concatenate(([0.], prec, [0.])) # compute the precision envelope for i in range(mpre.size - 1, 0, -1): mpre[i - 1] = np.maximum(mpre[i - 1], mpre[i]) # to calculate area under PR curve, look for points # where X axis (recall) changes value i = np.where(mrec[1:] != mrec[:-1])[0] # and sum (\Delta recall) * prec ap = np.sum((mrec[i + 1] - mrec[i]) * mpre[i + 1]) return ap def voc_eval(detpath, annopath, imagesetfile, classname, cachedir, ovthresh=0.5, use_07_metric=False): &quot;&quot;&quot;rec, prec, ap = voc_eval(detpath, annopath, imagesetfile, classname, [ovthresh], [use_07_metric]) Top level function that does the PASCAL VOC evaluation. detpath: Path to detections detpath.format(classname) should produce the detection results file. annopath: Path to annotations annopath.format(imagename) should be the xml annotations file. imagesetfile: Text file containing the list of images, one image per line. classname: Category name (duh) cachedir: Directory for caching the annotations [ovthresh]: Overlap threshold (default = 0.5) [use_07_metric]: Whether to use VOC07&#39;s 11 point AP computation (default False) &quot;&quot;&quot; # assumes detections are in detpath.format(classname) # assumes annotations are in annopath.format(imagename) # assumes imagesetfile is a text file with each line an image name 默认txt中是无后缀imgName # cachedir caches the annotations in a pickle file # first load gt if not os.path.isdir(cachedir): os.mkdir(cachedir) #若无pkl文件的路径，生成cachedir路径 cachefile = os.path.join(cachedir, &#39;annots.pkl&#39;) # read list of images with open(imagesetfile, &#39;r&#39;) as f: lines = f.readlines() imagenames = [x.strip() for x in lines] #imagenames为所有imgName的list if not os.path.isfile(cachefile): #cache路径下无pkl # load annots recs = {} #recs是一个dict，以imagename为key，解析xml后的obj为value，详情见下两句 for i, imagename in enumerate(imagenames): recs[imagename] = parse_rec(annopath.format(imagename)) #依次写入format上imagename的xml路径到resc列表 if i % 100 == 0: print (&#39;Reading annotation for {:d}/{:d}&#39;.format( i + 1, len(imagenames))) # 显示进程 # save print (&#39;Saving cached annotations to {:s}&#39;.format(cachefile)) with open(cachefile, &#39;w&#39;) as f: cPickle.dump(recs, f) #将resc列表中的内容写入pkl else: # load with open(cachefile, &#39;r&#39;) as f: recs = cPickle.load(f) #若存在pkl，直接load到recs # extract gt objects for this class class_recs = {} npos = 0 for imagename in imagenames: R = [obj for obj in recs[imagename] if obj[&#39;name&#39;] == classname] #除去recs中其他类别 bbox = np.array([x[&#39;bbox&#39;] for x in R]) difficult = np.array([x[&#39;difficult&#39;] for x in R]).astype(np.bool) det = [False] * len(R) npos = npos + sum(~difficult) class_recs[imagename] = {&#39;bbox&#39;: bbox, &#39;difficult&#39;: difficult, &#39;det&#39;: det} # read dets detfile = detpath.format(classname) with open(detfile, &#39;r&#39;) as f: #读批量验证的结果txt文件 lines = f.readlines() splitlines = [x.strip().split(&#39; &#39;) for x in lines] #split对txt每一行的数据做分割 image_ids = [x[0] for x in splitlines] confidence = np.array([float(x[1]) for x in splitlines]) BB = np.array([[float(z) for z in x[2:]] for x in splitlines]) # sort by confidence sorted_ind = np.argsort(-confidence) sorted_scores = np.sort(-confidence) BB = BB[sorted_ind, :] image_ids = [image_ids[x] for x in sorted_ind] # go down dets and mark TPs and FPs 以下为计算对比各参数 nd = len(image_ids) tp = np.zeros(nd) fp = np.zeros(nd) for d in range(nd): R = class_recs[image_ids[d]] bb = BB[d, :].astype(float) ovmax = -np.inf BBGT = R[&#39;bbox&#39;].astype(float) if BBGT.size &gt; 0: # compute overlaps # intersection ixmin = np.maximum(BBGT[:, 0], bb[0]) iymin = np.maximum(BBGT[:, 1], bb[1]) ixmax = np.minimum(BBGT[:, 2], bb[2]) iymax = np.minimum(BBGT[:, 3], bb[3]) iw = np.maximum(ixmax - ixmin + 1., 0.) ih = np.maximum(iymax - iymin + 1., 0.) inters = iw * ih # union uni = ((bb[2] - bb[0] + 1.) * (bb[3] - bb[1] + 1.) + (BBGT[:, 2] - BBGT[:, 0] + 1.) * (BBGT[:, 3] - BBGT[:, 1] + 1.) - inters) overlaps = inters / uni ovmax = np.max(overlaps) jmax = np.argmax(overlaps) if ovmax &gt; ovthresh: if not R[&#39;difficult&#39;][jmax]: if not R[&#39;det&#39;][jmax]: tp[d] = 1. R[&#39;det&#39;][jmax] = 1 else: fp[d] = 1. else: fp[d] = 1. # compute precision recall fp = np.cumsum(fp) tp = np.cumsum(tp) rec = tp / float(npos) # avoid divide by zero in case the first detection matches a difficult # ground truth prec = tp / np.maximum(tp + fp, np.finfo(np.float64).eps) ap = voc_ap(rec, prec, use_07_metric) return rec, prec, ap 新建compute_mAP.py 文件 from voc_eval import voc_eval print &quot;RSI:&quot;,voc_eval(&#39;/data/gary/darknet/results/{}.txt&#39;, &#39;/data/gary/VOC2007/Annotations/{}.xml&#39;, &#39;/data/gary/VOC2007/ImageSets/Main/test.txt&#39;, &#39;RSI&#39;, &#39;.&#39;) 运行python compute_mAP.py得到检测结果 运行前删除**./annots.pkl**文件，结果如下： 其中第三个值为AP，因为本例只求单类ap，即得出mAP。 参考：https://blog.csdn.net/qq_34806812/article/details/81747494" />
<meta property="og:description" content="一、使用valid批处理输出检测结果文本 运行指令 ./darknet detector valid cfg/voc.data cfg/yolo-voc.cfg backup/yolo-voc_final.weights 在darknet中执行以上代码，yolo将把检测结果输出保存darknet/result 目录下。 二、使用voc_eval.py计算mAP # -------------------------------------------------------- # Fast/er R-CNN # Licensed under The MIT License [see LICENSE for details] # Written by Bharath Hariharan # -------------------------------------------------------- import xml.etree.ElementTree as ET import os import cPickle import numpy as np def parse_rec(filename): #通过ET解析xml后返回一个obj &quot;&quot;&quot; Parse a PASCAL VOC xml file &quot;&quot;&quot; tree = ET.parse(filename) objects = [] for obj in tree.findall(&#39;object&#39;): obj_struct = {} obj_struct[&#39;name&#39;] = obj.find(&#39;name&#39;).text obj_struct[&#39;pose&#39;] = obj.find(&#39;pose&#39;).text obj_struct[&#39;truncated&#39;] = int(obj.find(&#39;truncated&#39;).text) obj_struct[&#39;difficult&#39;] = int(obj.find(&#39;difficult&#39;).text) bbox = obj.find(&#39;bndbox&#39;) obj_struct[&#39;bbox&#39;] = [int(bbox.find(&#39;xmin&#39;).text), int(bbox.find(&#39;ymin&#39;).text), int(bbox.find(&#39;xmax&#39;).text), int(bbox.find(&#39;ymax&#39;).text)] objects.append(obj_struct) #objects格式为 [{&#39;name&#39;:egret,&#39;pose&#39;:Unspecifie等},{&#39;name&#39;:egret,&#39;pose&#39;:Unspecifie等}] return objects def voc_ap(rec, prec, use_07_metric=False): &quot;&quot;&quot; ap = voc_ap(rec, prec, [use_07_metric]) Compute VOC AP given precision and recall. If use_07_metric is true, uses the VOC 07 11 point method (default:False). &quot;&quot;&quot; if use_07_metric: # 11 point metric ap = 0. for t in np.arange(0., 1.1, 0.1): if np.sum(rec &gt;= t) == 0: p = 0 else: p = np.max(prec[rec &gt;= t]) ap = ap + p / 11. else: # correct AP calculation # first append sentinel values at the end mrec = np.concatenate(([0.], rec, [1.])) mpre = np.concatenate(([0.], prec, [0.])) # compute the precision envelope for i in range(mpre.size - 1, 0, -1): mpre[i - 1] = np.maximum(mpre[i - 1], mpre[i]) # to calculate area under PR curve, look for points # where X axis (recall) changes value i = np.where(mrec[1:] != mrec[:-1])[0] # and sum (\Delta recall) * prec ap = np.sum((mrec[i + 1] - mrec[i]) * mpre[i + 1]) return ap def voc_eval(detpath, annopath, imagesetfile, classname, cachedir, ovthresh=0.5, use_07_metric=False): &quot;&quot;&quot;rec, prec, ap = voc_eval(detpath, annopath, imagesetfile, classname, [ovthresh], [use_07_metric]) Top level function that does the PASCAL VOC evaluation. detpath: Path to detections detpath.format(classname) should produce the detection results file. annopath: Path to annotations annopath.format(imagename) should be the xml annotations file. imagesetfile: Text file containing the list of images, one image per line. classname: Category name (duh) cachedir: Directory for caching the annotations [ovthresh]: Overlap threshold (default = 0.5) [use_07_metric]: Whether to use VOC07&#39;s 11 point AP computation (default False) &quot;&quot;&quot; # assumes detections are in detpath.format(classname) # assumes annotations are in annopath.format(imagename) # assumes imagesetfile is a text file with each line an image name 默认txt中是无后缀imgName # cachedir caches the annotations in a pickle file # first load gt if not os.path.isdir(cachedir): os.mkdir(cachedir) #若无pkl文件的路径，生成cachedir路径 cachefile = os.path.join(cachedir, &#39;annots.pkl&#39;) # read list of images with open(imagesetfile, &#39;r&#39;) as f: lines = f.readlines() imagenames = [x.strip() for x in lines] #imagenames为所有imgName的list if not os.path.isfile(cachefile): #cache路径下无pkl # load annots recs = {} #recs是一个dict，以imagename为key，解析xml后的obj为value，详情见下两句 for i, imagename in enumerate(imagenames): recs[imagename] = parse_rec(annopath.format(imagename)) #依次写入format上imagename的xml路径到resc列表 if i % 100 == 0: print (&#39;Reading annotation for {:d}/{:d}&#39;.format( i + 1, len(imagenames))) # 显示进程 # save print (&#39;Saving cached annotations to {:s}&#39;.format(cachefile)) with open(cachefile, &#39;w&#39;) as f: cPickle.dump(recs, f) #将resc列表中的内容写入pkl else: # load with open(cachefile, &#39;r&#39;) as f: recs = cPickle.load(f) #若存在pkl，直接load到recs # extract gt objects for this class class_recs = {} npos = 0 for imagename in imagenames: R = [obj for obj in recs[imagename] if obj[&#39;name&#39;] == classname] #除去recs中其他类别 bbox = np.array([x[&#39;bbox&#39;] for x in R]) difficult = np.array([x[&#39;difficult&#39;] for x in R]).astype(np.bool) det = [False] * len(R) npos = npos + sum(~difficult) class_recs[imagename] = {&#39;bbox&#39;: bbox, &#39;difficult&#39;: difficult, &#39;det&#39;: det} # read dets detfile = detpath.format(classname) with open(detfile, &#39;r&#39;) as f: #读批量验证的结果txt文件 lines = f.readlines() splitlines = [x.strip().split(&#39; &#39;) for x in lines] #split对txt每一行的数据做分割 image_ids = [x[0] for x in splitlines] confidence = np.array([float(x[1]) for x in splitlines]) BB = np.array([[float(z) for z in x[2:]] for x in splitlines]) # sort by confidence sorted_ind = np.argsort(-confidence) sorted_scores = np.sort(-confidence) BB = BB[sorted_ind, :] image_ids = [image_ids[x] for x in sorted_ind] # go down dets and mark TPs and FPs 以下为计算对比各参数 nd = len(image_ids) tp = np.zeros(nd) fp = np.zeros(nd) for d in range(nd): R = class_recs[image_ids[d]] bb = BB[d, :].astype(float) ovmax = -np.inf BBGT = R[&#39;bbox&#39;].astype(float) if BBGT.size &gt; 0: # compute overlaps # intersection ixmin = np.maximum(BBGT[:, 0], bb[0]) iymin = np.maximum(BBGT[:, 1], bb[1]) ixmax = np.minimum(BBGT[:, 2], bb[2]) iymax = np.minimum(BBGT[:, 3], bb[3]) iw = np.maximum(ixmax - ixmin + 1., 0.) ih = np.maximum(iymax - iymin + 1., 0.) inters = iw * ih # union uni = ((bb[2] - bb[0] + 1.) * (bb[3] - bb[1] + 1.) + (BBGT[:, 2] - BBGT[:, 0] + 1.) * (BBGT[:, 3] - BBGT[:, 1] + 1.) - inters) overlaps = inters / uni ovmax = np.max(overlaps) jmax = np.argmax(overlaps) if ovmax &gt; ovthresh: if not R[&#39;difficult&#39;][jmax]: if not R[&#39;det&#39;][jmax]: tp[d] = 1. R[&#39;det&#39;][jmax] = 1 else: fp[d] = 1. else: fp[d] = 1. # compute precision recall fp = np.cumsum(fp) tp = np.cumsum(tp) rec = tp / float(npos) # avoid divide by zero in case the first detection matches a difficult # ground truth prec = tp / np.maximum(tp + fp, np.finfo(np.float64).eps) ap = voc_ap(rec, prec, use_07_metric) return rec, prec, ap 新建compute_mAP.py 文件 from voc_eval import voc_eval print &quot;RSI:&quot;,voc_eval(&#39;/data/gary/darknet/results/{}.txt&#39;, &#39;/data/gary/VOC2007/Annotations/{}.xml&#39;, &#39;/data/gary/VOC2007/ImageSets/Main/test.txt&#39;, &#39;RSI&#39;, &#39;.&#39;) 运行python compute_mAP.py得到检测结果 运行前删除**./annots.pkl**文件，结果如下： 其中第三个值为AP，因为本例只求单类ap，即得出mAP。 参考：https://blog.csdn.net/qq_34806812/article/details/81747494" />
<link rel="canonical" href="https://uzzz.org/2019/06/12/789276.html" />
<meta property="og:url" content="https://uzzz.org/2019/06/12/789276.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-06-12T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"一、使用valid批处理输出检测结果文本 运行指令 ./darknet detector valid cfg/voc.data cfg/yolo-voc.cfg backup/yolo-voc_final.weights 在darknet中执行以上代码，yolo将把检测结果输出保存darknet/result 目录下。 二、使用voc_eval.py计算mAP # -------------------------------------------------------- # Fast/er R-CNN # Licensed under The MIT License [see LICENSE for details] # Written by Bharath Hariharan # -------------------------------------------------------- import xml.etree.ElementTree as ET import os import cPickle import numpy as np def parse_rec(filename): #通过ET解析xml后返回一个obj &quot;&quot;&quot; Parse a PASCAL VOC xml file &quot;&quot;&quot; tree = ET.parse(filename) objects = [] for obj in tree.findall(&#39;object&#39;): obj_struct = {} obj_struct[&#39;name&#39;] = obj.find(&#39;name&#39;).text obj_struct[&#39;pose&#39;] = obj.find(&#39;pose&#39;).text obj_struct[&#39;truncated&#39;] = int(obj.find(&#39;truncated&#39;).text) obj_struct[&#39;difficult&#39;] = int(obj.find(&#39;difficult&#39;).text) bbox = obj.find(&#39;bndbox&#39;) obj_struct[&#39;bbox&#39;] = [int(bbox.find(&#39;xmin&#39;).text), int(bbox.find(&#39;ymin&#39;).text), int(bbox.find(&#39;xmax&#39;).text), int(bbox.find(&#39;ymax&#39;).text)] objects.append(obj_struct) #objects格式为 [{&#39;name&#39;:egret,&#39;pose&#39;:Unspecifie等},{&#39;name&#39;:egret,&#39;pose&#39;:Unspecifie等}] return objects def voc_ap(rec, prec, use_07_metric=False): &quot;&quot;&quot; ap = voc_ap(rec, prec, [use_07_metric]) Compute VOC AP given precision and recall. If use_07_metric is true, uses the VOC 07 11 point method (default:False). &quot;&quot;&quot; if use_07_metric: # 11 point metric ap = 0. for t in np.arange(0., 1.1, 0.1): if np.sum(rec &gt;= t) == 0: p = 0 else: p = np.max(prec[rec &gt;= t]) ap = ap + p / 11. else: # correct AP calculation # first append sentinel values at the end mrec = np.concatenate(([0.], rec, [1.])) mpre = np.concatenate(([0.], prec, [0.])) # compute the precision envelope for i in range(mpre.size - 1, 0, -1): mpre[i - 1] = np.maximum(mpre[i - 1], mpre[i]) # to calculate area under PR curve, look for points # where X axis (recall) changes value i = np.where(mrec[1:] != mrec[:-1])[0] # and sum (\\Delta recall) * prec ap = np.sum((mrec[i + 1] - mrec[i]) * mpre[i + 1]) return ap def voc_eval(detpath, annopath, imagesetfile, classname, cachedir, ovthresh=0.5, use_07_metric=False): &quot;&quot;&quot;rec, prec, ap = voc_eval(detpath, annopath, imagesetfile, classname, [ovthresh], [use_07_metric]) Top level function that does the PASCAL VOC evaluation. detpath: Path to detections detpath.format(classname) should produce the detection results file. annopath: Path to annotations annopath.format(imagename) should be the xml annotations file. imagesetfile: Text file containing the list of images, one image per line. classname: Category name (duh) cachedir: Directory for caching the annotations [ovthresh]: Overlap threshold (default = 0.5) [use_07_metric]: Whether to use VOC07&#39;s 11 point AP computation (default False) &quot;&quot;&quot; # assumes detections are in detpath.format(classname) # assumes annotations are in annopath.format(imagename) # assumes imagesetfile is a text file with each line an image name 默认txt中是无后缀imgName # cachedir caches the annotations in a pickle file # first load gt if not os.path.isdir(cachedir): os.mkdir(cachedir) #若无pkl文件的路径，生成cachedir路径 cachefile = os.path.join(cachedir, &#39;annots.pkl&#39;) # read list of images with open(imagesetfile, &#39;r&#39;) as f: lines = f.readlines() imagenames = [x.strip() for x in lines] #imagenames为所有imgName的list if not os.path.isfile(cachefile): #cache路径下无pkl # load annots recs = {} #recs是一个dict，以imagename为key，解析xml后的obj为value，详情见下两句 for i, imagename in enumerate(imagenames): recs[imagename] = parse_rec(annopath.format(imagename)) #依次写入format上imagename的xml路径到resc列表 if i % 100 == 0: print (&#39;Reading annotation for {:d}/{:d}&#39;.format( i + 1, len(imagenames))) # 显示进程 # save print (&#39;Saving cached annotations to {:s}&#39;.format(cachefile)) with open(cachefile, &#39;w&#39;) as f: cPickle.dump(recs, f) #将resc列表中的内容写入pkl else: # load with open(cachefile, &#39;r&#39;) as f: recs = cPickle.load(f) #若存在pkl，直接load到recs # extract gt objects for this class class_recs = {} npos = 0 for imagename in imagenames: R = [obj for obj in recs[imagename] if obj[&#39;name&#39;] == classname] #除去recs中其他类别 bbox = np.array([x[&#39;bbox&#39;] for x in R]) difficult = np.array([x[&#39;difficult&#39;] for x in R]).astype(np.bool) det = [False] * len(R) npos = npos + sum(~difficult) class_recs[imagename] = {&#39;bbox&#39;: bbox, &#39;difficult&#39;: difficult, &#39;det&#39;: det} # read dets detfile = detpath.format(classname) with open(detfile, &#39;r&#39;) as f: #读批量验证的结果txt文件 lines = f.readlines() splitlines = [x.strip().split(&#39; &#39;) for x in lines] #split对txt每一行的数据做分割 image_ids = [x[0] for x in splitlines] confidence = np.array([float(x[1]) for x in splitlines]) BB = np.array([[float(z) for z in x[2:]] for x in splitlines]) # sort by confidence sorted_ind = np.argsort(-confidence) sorted_scores = np.sort(-confidence) BB = BB[sorted_ind, :] image_ids = [image_ids[x] for x in sorted_ind] # go down dets and mark TPs and FPs 以下为计算对比各参数 nd = len(image_ids) tp = np.zeros(nd) fp = np.zeros(nd) for d in range(nd): R = class_recs[image_ids[d]] bb = BB[d, :].astype(float) ovmax = -np.inf BBGT = R[&#39;bbox&#39;].astype(float) if BBGT.size &gt; 0: # compute overlaps # intersection ixmin = np.maximum(BBGT[:, 0], bb[0]) iymin = np.maximum(BBGT[:, 1], bb[1]) ixmax = np.minimum(BBGT[:, 2], bb[2]) iymax = np.minimum(BBGT[:, 3], bb[3]) iw = np.maximum(ixmax - ixmin + 1., 0.) ih = np.maximum(iymax - iymin + 1., 0.) inters = iw * ih # union uni = ((bb[2] - bb[0] + 1.) * (bb[3] - bb[1] + 1.) + (BBGT[:, 2] - BBGT[:, 0] + 1.) * (BBGT[:, 3] - BBGT[:, 1] + 1.) - inters) overlaps = inters / uni ovmax = np.max(overlaps) jmax = np.argmax(overlaps) if ovmax &gt; ovthresh: if not R[&#39;difficult&#39;][jmax]: if not R[&#39;det&#39;][jmax]: tp[d] = 1. R[&#39;det&#39;][jmax] = 1 else: fp[d] = 1. else: fp[d] = 1. # compute precision recall fp = np.cumsum(fp) tp = np.cumsum(tp) rec = tp / float(npos) # avoid divide by zero in case the first detection matches a difficult # ground truth prec = tp / np.maximum(tp + fp, np.finfo(np.float64).eps) ap = voc_ap(rec, prec, use_07_metric) return rec, prec, ap 新建compute_mAP.py 文件 from voc_eval import voc_eval print &quot;RSI:&quot;,voc_eval(&#39;/data/gary/darknet/results/{}.txt&#39;, &#39;/data/gary/VOC2007/Annotations/{}.xml&#39;, &#39;/data/gary/VOC2007/ImageSets/Main/test.txt&#39;, &#39;RSI&#39;, &#39;.&#39;) 运行python compute_mAP.py得到检测结果 运行前删除**./annots.pkl**文件，结果如下： 其中第三个值为AP，因为本例只求单类ap，即得出mAP。 参考：https://blog.csdn.net/qq_34806812/article/details/81747494","@type":"BlogPosting","url":"https://uzzz.org/2019/06/12/789276.html","headline":"yolov3学习笔记系列一、计算map","dateModified":"2019-06-12T00:00:00+08:00","datePublished":"2019-06-12T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://uzzz.org/2019/06/12/789276.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>yolov3学习笔记系列一、计算map</h1>
        
        
        <ul style="display: block;">
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
 	    <li><a href="/donate/" style="line-height: unset;" target="_blank"><strong>Donate</strong></a></li>
        </ul>
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
<!-- match content ads -->
	        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
			<ins class="adsbygoogle"
			     style="display:block"
			     data-ad-format="autorelaxed"
			     data-ad-client="ca-pub-8889449066804352"
			     data-ad-slot="1928667997"></ins>
			<script>
			     (adsbygoogle = window.adsbygoogle || []).push({});
			</script>	



        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-cd6c485e8b.css"> 
 <div id="content_views" class="markdown_views prism-atom-one-dark"> 
  <!-- flowchart 箭头图标 勿删 --> 
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> 
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path> 
  </svg> 
  <h1><a id="valid_1"></a>一、使用valid批处理输出检测结果文本</h1> 
  <h2><a id="_3"></a>运行指令</h2> 
  <pre><code class="prism language-javascript"><span class="token punctuation">.</span><span class="token operator">/</span>darknet detector valid cfg<span class="token operator">/</span>voc<span class="token punctuation">.</span>data cfg<span class="token operator">/</span>yolo<span class="token operator">-</span>voc<span class="token punctuation">.</span>cfg backup<span class="token operator">/</span>yolo<span class="token operator">-</span>voc_final<span class="token punctuation">.</span>weights
</code></pre> 
  <p>在<kbd>darknet</kbd>中执行以上代码，yolo将把检测结果输出保存<kbd>darknet/result </kbd>目录下。<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190612203201641.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM1ODkyMjg3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> 
  <h2><a id="voc_evalpymAP_9"></a>二、使用voc_eval.py计算mAP</h2> 
  <pre><code class="prism language-javascript"># <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
# Fast<span class="token operator">/</span>er <span class="token constant">R</span><span class="token operator">-</span><span class="token constant">CNN</span>
# Licensed under The <span class="token constant">MIT</span> License <span class="token punctuation">[</span>see <span class="token constant">LICENSE</span> <span class="token keyword">for</span> details<span class="token punctuation">]</span>
# Written by Bharath Hariharan
# <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
 
<span class="token keyword">import</span> xml<span class="token punctuation">.</span>etree<span class="token punctuation">.</span>ElementTree <span class="token keyword">as</span> <span class="token constant">ET</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> cPickle
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
 
def <span class="token function">parse_rec</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>    #通过<span class="token constant">ET</span>解析xml后返回一个obj
    <span class="token string">""</span><span class="token string">" Parse a PASCAL VOC xml file "</span><span class="token string">""</span>
    tree <span class="token operator">=</span> <span class="token constant">ET</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    objects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> obj <span class="token keyword">in</span> tree<span class="token punctuation">.</span><span class="token function">findall</span><span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        obj_struct <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        obj_struct<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        obj_struct<span class="token punctuation">[</span><span class="token string">'pose'</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'pose'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        obj_struct<span class="token punctuation">[</span><span class="token string">'truncated'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'truncated'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        obj_struct<span class="token punctuation">[</span><span class="token string">'difficult'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'difficult'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        bbox <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'bndbox'</span><span class="token punctuation">)</span>
        obj_struct<span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'xmin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token function">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'ymin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token function">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'xmax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token function">int</span><span class="token punctuation">(</span>bbox<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'ymax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">]</span>
        objects<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>obj_struct<span class="token punctuation">)</span>  #objects格式为 <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span>egret<span class="token punctuation">,</span><span class="token string">'pose'</span><span class="token punctuation">:</span>Unspecifie等<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span>egret<span class="token punctuation">,</span><span class="token string">'pose'</span><span class="token punctuation">:</span>Unspecifie等<span class="token punctuation">}</span><span class="token punctuation">]</span>
 
    <span class="token keyword">return</span> objects
 
def <span class="token function">voc_ap</span><span class="token punctuation">(</span>rec<span class="token punctuation">,</span> prec<span class="token punctuation">,</span> use_07_metric<span class="token operator">=</span>False<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span>" ap <span class="token operator">=</span> <span class="token function">voc_ap</span><span class="token punctuation">(</span>rec<span class="token punctuation">,</span> prec<span class="token punctuation">,</span> <span class="token punctuation">[</span>use_07_metric<span class="token punctuation">]</span><span class="token punctuation">)</span>
    Compute <span class="token constant">VOC</span> <span class="token constant">AP</span> given precision and recall<span class="token punctuation">.</span>
    If use_07_metric is <span class="token boolean">true</span><span class="token punctuation">,</span> uses the
    <span class="token constant">VOC</span> <span class="token number">07</span> <span class="token number">11</span> point <span class="token function">method</span> <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">:</span>False<span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token string">""</span>"
    <span class="token keyword">if</span> use_07_metric<span class="token punctuation">:</span>
        # <span class="token number">11</span> point metric
        ap <span class="token operator">=</span> <span class="token number">0.</span>
        <span class="token keyword">for</span> t <span class="token keyword">in</span> np<span class="token punctuation">.</span><span class="token function">arange</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> np<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span>rec <span class="token operator">&gt;=</span> t<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                p <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                p <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>prec<span class="token punctuation">[</span>rec <span class="token operator">&gt;=</span> t<span class="token punctuation">]</span><span class="token punctuation">)</span>
            ap <span class="token operator">=</span> ap <span class="token operator">+</span> p <span class="token operator">/</span> <span class="token number">11.</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        # correct <span class="token constant">AP</span> calculation
        # first append sentinel values at the end
        mrec <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">concatenate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rec<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1.</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        mpre <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">concatenate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.</span><span class="token punctuation">]</span><span class="token punctuation">,</span> prec<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 
        # compute the precision envelope
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token function">range</span><span class="token punctuation">(</span>mpre<span class="token punctuation">.</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            mpre<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">maximum</span><span class="token punctuation">(</span>mpre<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mpre<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
 
        # to calculate area under <span class="token constant">PR</span> curve<span class="token punctuation">,</span> look <span class="token keyword">for</span> points
        # where <span class="token constant">X</span> <span class="token function">axis</span> <span class="token punctuation">(</span>recall<span class="token punctuation">)</span> changes value
        i <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>mrec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">!=</span> mrec<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
 
        # and <span class="token function">sum</span> <span class="token punctuation">(</span>\Delta recall<span class="token punctuation">)</span> <span class="token operator">*</span> prec
        ap <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mrec<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> mrec<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> mpre<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ap
 
def <span class="token function">voc_eval</span><span class="token punctuation">(</span>detpath<span class="token punctuation">,</span>
             annopath<span class="token punctuation">,</span>
             imagesetfile<span class="token punctuation">,</span>
             classname<span class="token punctuation">,</span>
             cachedir<span class="token punctuation">,</span>
             ovthresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
             use_07_metric<span class="token operator">=</span>False<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span>"rec<span class="token punctuation">,</span> prec<span class="token punctuation">,</span> ap <span class="token operator">=</span> <span class="token function">voc_eval</span><span class="token punctuation">(</span>detpath<span class="token punctuation">,</span>
                                annopath<span class="token punctuation">,</span>
                                imagesetfile<span class="token punctuation">,</span>
                                classname<span class="token punctuation">,</span>
                                <span class="token punctuation">[</span>ovthresh<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                <span class="token punctuation">[</span>use_07_metric<span class="token punctuation">]</span><span class="token punctuation">)</span>
    Top level <span class="token keyword">function</span> that does the <span class="token constant">PASCAL</span> <span class="token constant">VOC</span> evaluation<span class="token punctuation">.</span>
    detpath<span class="token punctuation">:</span> Path to detections
        detpath<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>classname<span class="token punctuation">)</span> should produce the detection results file<span class="token punctuation">.</span>
    annopath<span class="token punctuation">:</span> Path to annotations
        annopath<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>imagename<span class="token punctuation">)</span> should be the xml annotations file<span class="token punctuation">.</span>
    imagesetfile<span class="token punctuation">:</span> Text file containing the list <span class="token keyword">of</span> images<span class="token punctuation">,</span> one image per line<span class="token punctuation">.</span>
    classname<span class="token punctuation">:</span> Category <span class="token function">name</span> <span class="token punctuation">(</span>duh<span class="token punctuation">)</span>
    cachedir<span class="token punctuation">:</span> Directory <span class="token keyword">for</span> caching the annotations
    <span class="token punctuation">[</span>ovthresh<span class="token punctuation">]</span><span class="token punctuation">:</span> Overlap <span class="token function">threshold</span> <span class="token punctuation">(</span><span class="token keyword">default</span> <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
    <span class="token punctuation">[</span>use_07_metric<span class="token punctuation">]</span><span class="token punctuation">:</span> Whether to use <span class="token constant">VOC07</span>'s <span class="token number">11</span> point <span class="token constant">AP</span> <span class="token function">computation</span>
        <span class="token punctuation">(</span><span class="token keyword">default</span> False<span class="token punctuation">)</span>
    <span class="token string">""</span>"
    # assumes detections are <span class="token keyword">in</span> detpath<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>classname<span class="token punctuation">)</span>
    # assumes annotations are <span class="token keyword">in</span> annopath<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>imagename<span class="token punctuation">)</span>
    # assumes imagesetfile is a text file <span class="token keyword">with</span> each line an image name 默认txt中是无后缀imgName
    # cachedir caches the annotations <span class="token keyword">in</span> a pickle file
 
    # first load gt
    <span class="token keyword">if</span> not os<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">isdir</span><span class="token punctuation">(</span>cachedir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>cachedir<span class="token punctuation">)</span>  #若无pkl文件的路径，生成cachedir路径
    cachefile <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cachedir<span class="token punctuation">,</span> <span class="token string">'annots.pkl'</span><span class="token punctuation">)</span>    
    # read list <span class="token keyword">of</span> images
    <span class="token keyword">with</span> <span class="token function">open</span><span class="token punctuation">(</span>imagesetfile<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        lines <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">readlines</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    imagenames <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span><span class="token function">strip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> lines<span class="token punctuation">]</span> #imagenames为所有imgName的list
 
    <span class="token keyword">if</span> not os<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">isfile</span><span class="token punctuation">(</span>cachefile<span class="token punctuation">)</span><span class="token punctuation">:</span>   #cache路径下无pkl
        # load annots
        recs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>   #recs是一个dict，以imagename为key，解析xml后的obj为value，详情见下两句
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> imagename <span class="token keyword">in</span> <span class="token function">enumerate</span><span class="token punctuation">(</span>imagenames<span class="token punctuation">)</span><span class="token punctuation">:</span>
            recs<span class="token punctuation">[</span>imagename<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">parse_rec</span><span class="token punctuation">(</span>annopath<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>imagename<span class="token punctuation">)</span><span class="token punctuation">)</span> #依次写入format上imagename的xml路径到resc列表
            <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token function">print</span> <span class="token punctuation">(</span><span class="token string">'Reading annotation for {:d}/{:d}'</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
                    i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>imagenames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> #   显示进程
        # save
        <span class="token function">print</span> <span class="token punctuation">(</span><span class="token string">'Saving cached annotations to {:s}'</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>cachefile<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token function">open</span><span class="token punctuation">(</span>cachefile<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            cPickle<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>recs<span class="token punctuation">,</span> f<span class="token punctuation">)</span>   #将resc列表中的内容写入pkl
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        # load
        <span class="token keyword">with</span> <span class="token function">open</span><span class="token punctuation">(</span>cachefile<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            recs <span class="token operator">=</span> cPickle<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>  #若存在pkl，直接load到recs
 
    # extract gt objects <span class="token keyword">for</span> <span class="token keyword">this</span> <span class="token keyword">class</span>
    <span class="token class-name">class_recs</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    npos <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> imagename <span class="token keyword">in</span> imagenames<span class="token punctuation">:</span>
        <span class="token constant">R</span> <span class="token operator">=</span> <span class="token punctuation">[</span>obj <span class="token keyword">for</span> obj <span class="token keyword">in</span> recs<span class="token punctuation">[</span>imagename<span class="token punctuation">]</span> <span class="token keyword">if</span> obj<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">==</span> classname<span class="token punctuation">]</span>    #除去recs中其他类别
        bbox <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token constant">R</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        difficult <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token string">'difficult'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token constant">R</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">astype</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>bool<span class="token punctuation">)</span>
        det <span class="token operator">=</span> <span class="token punctuation">[</span>False<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token constant">R</span><span class="token punctuation">)</span>
        npos <span class="token operator">=</span> npos <span class="token operator">+</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token operator">~</span>difficult<span class="token punctuation">)</span>
        class_recs<span class="token punctuation">[</span>imagename<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'bbox'</span><span class="token punctuation">:</span> bbox<span class="token punctuation">,</span>
                                 <span class="token string">'difficult'</span><span class="token punctuation">:</span> difficult<span class="token punctuation">,</span>
                                 <span class="token string">'det'</span><span class="token punctuation">:</span> det<span class="token punctuation">}</span>
 
    # read dets
    detfile <span class="token operator">=</span> detpath<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>classname<span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token function">open</span><span class="token punctuation">(</span>detfile<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>   #读批量验证的结果txt文件
        lines <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">readlines</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
    splitlines <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span><span class="token function">strip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> lines<span class="token punctuation">]</span>  #split对txt每一行的数据做分割
    image_ids <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> splitlines<span class="token punctuation">]</span>
    confidence <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">float</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> splitlines<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token constant">BB</span> <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token function">float</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span> <span class="token keyword">for</span> z <span class="token keyword">in</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> splitlines<span class="token punctuation">]</span><span class="token punctuation">)</span>
 
    # sort by confidence
    sorted_ind <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">argsort</span><span class="token punctuation">(</span><span class="token operator">-</span>confidence<span class="token punctuation">)</span>
    sorted_scores <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token operator">-</span>confidence<span class="token punctuation">)</span>
    <span class="token constant">BB</span> <span class="token operator">=</span> <span class="token constant">BB</span><span class="token punctuation">[</span>sorted_ind<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
    image_ids <span class="token operator">=</span> <span class="token punctuation">[</span>image_ids<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> sorted_ind<span class="token punctuation">]</span>
 
    # go down dets and mark TPs and FPs 以下为计算对比各参数
    nd <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>image_ids<span class="token punctuation">)</span>
    tp <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">zeros</span><span class="token punctuation">(</span>nd<span class="token punctuation">)</span>
    fp <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">zeros</span><span class="token punctuation">(</span>nd<span class="token punctuation">)</span>
    <span class="token keyword">for</span> d <span class="token keyword">in</span> <span class="token function">range</span><span class="token punctuation">(</span>nd<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token constant">R</span> <span class="token operator">=</span> class_recs<span class="token punctuation">[</span>image_ids<span class="token punctuation">[</span>d<span class="token punctuation">]</span><span class="token punctuation">]</span>
        bb <span class="token operator">=</span> <span class="token constant">BB</span><span class="token punctuation">[</span>d<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">astype</span><span class="token punctuation">(</span>float<span class="token punctuation">)</span>
        ovmax <span class="token operator">=</span> <span class="token operator">-</span>np<span class="token punctuation">.</span>inf
        <span class="token constant">BBGT</span> <span class="token operator">=</span> <span class="token constant">R</span><span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">astype</span><span class="token punctuation">(</span>float<span class="token punctuation">)</span>
 
        <span class="token keyword">if</span> <span class="token constant">BBGT</span><span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            # compute overlaps
            # intersection
            ixmin <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">maximum</span><span class="token punctuation">(</span><span class="token constant">BBGT</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            iymin <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">maximum</span><span class="token punctuation">(</span><span class="token constant">BBGT</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            ixmax <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">minimum</span><span class="token punctuation">(</span><span class="token constant">BBGT</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            iymax <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">minimum</span><span class="token punctuation">(</span><span class="token constant">BBGT</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bb<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            iw <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">maximum</span><span class="token punctuation">(</span>ixmax <span class="token operator">-</span> ixmin <span class="token operator">+</span> <span class="token number">1.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">)</span>
            ih <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">maximum</span><span class="token punctuation">(</span>iymax <span class="token operator">-</span> iymin <span class="token operator">+</span> <span class="token number">1.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">)</span>
            inters <span class="token operator">=</span> iw <span class="token operator">*</span> ih
 
            # union
            uni <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> bb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>bb<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> bb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                   <span class="token punctuation">(</span><span class="token constant">BBGT</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token constant">BBGT</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">*</span>
                   <span class="token punctuation">(</span><span class="token constant">BBGT</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token constant">BBGT</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">-</span> inters<span class="token punctuation">)</span>
 
            overlaps <span class="token operator">=</span> inters <span class="token operator">/</span> uni
            ovmax <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>overlaps<span class="token punctuation">)</span>
            jmax <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">argmax</span><span class="token punctuation">(</span>overlaps<span class="token punctuation">)</span>
 
        <span class="token keyword">if</span> ovmax <span class="token operator">&gt;</span> ovthresh<span class="token punctuation">:</span>
            <span class="token keyword">if</span> not <span class="token constant">R</span><span class="token punctuation">[</span><span class="token string">'difficult'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>jmax<span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> not <span class="token constant">R</span><span class="token punctuation">[</span><span class="token string">'det'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>jmax<span class="token punctuation">]</span><span class="token punctuation">:</span>
                    tp<span class="token punctuation">[</span>d<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.</span>
                    <span class="token constant">R</span><span class="token punctuation">[</span><span class="token string">'det'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>jmax<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    fp<span class="token punctuation">[</span>d<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            fp<span class="token punctuation">[</span>d<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.</span>
 
    # compute precision recall
    fp <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">cumsum</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span>
    tp <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">cumsum</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span>
    rec <span class="token operator">=</span> tp <span class="token operator">/</span> <span class="token function">float</span><span class="token punctuation">(</span>npos<span class="token punctuation">)</span>
    # avoid divide by zero <span class="token keyword">in</span> <span class="token keyword">case</span> the first detection matches a difficult
    # ground truth
    prec <span class="token operator">=</span> tp <span class="token operator">/</span> np<span class="token punctuation">.</span><span class="token function">maximum</span><span class="token punctuation">(</span>tp <span class="token operator">+</span> fp<span class="token punctuation">,</span> np<span class="token punctuation">.</span><span class="token function">finfo</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>float64<span class="token punctuation">)</span><span class="token punctuation">.</span>eps<span class="token punctuation">)</span>
    ap <span class="token operator">=</span> <span class="token function">voc_ap</span><span class="token punctuation">(</span>rec<span class="token punctuation">,</span> prec<span class="token punctuation">,</span> use_07_metric<span class="token punctuation">)</span>
 
    <span class="token keyword">return</span> rec<span class="token punctuation">,</span> prec<span class="token punctuation">,</span> ap
</code></pre> 
  <h2><a id="compute_mAPpy__211"></a>新建compute_mAP.py 文件</h2> 
  <pre><code class="prism language-javascript"><span class="token keyword">from</span> voc_eval <span class="token keyword">import</span> voc_eval
print <span class="token string">"RSI:"</span><span class="token punctuation">,</span><span class="token function">voc_eval</span><span class="token punctuation">(</span><span class="token string">'/data/gary/darknet/results/{}.txt'</span><span class="token punctuation">,</span> <span class="token string">'/data/gary/VOC2007/Annotations/{}.xml'</span><span class="token punctuation">,</span> <span class="token string">'/data/gary/VOC2007/ImageSets/Main/test.txt'</span><span class="token punctuation">,</span> <span class="token string">'RSI'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span>
</code></pre> 
  <h2><a id="python_compute_mAPpy_216"></a>运行<strong>python compute_mAP.py</strong>得到检测结果</h2> 
  <p>运行前删除**./annots.pkl**文件，结果如下：<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190612204348307.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM1ODkyMjg3,size_16,color_FFFFFF,t_70" alt="python compute_mAP.py"><br> 其中第三个值为AP，因为本例只求单类ap，即得出mAP。<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190612204820906.png" alt="在这里插入图片描述"><br> 参考：<a href="https://blog.csdn.net/qq_34806812/article/details/81747494" rel="nofollow">https://blog.csdn.net/qq_34806812/article/details/81747494</a></p> 
 </div> 
 <link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-e44c3c0e64.css" rel="stylesheet"> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d293c49e1e4bfe8f276695a5aa953300";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
