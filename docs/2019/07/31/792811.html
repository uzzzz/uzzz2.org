<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>从400+节点ElasticSearch集群的运维中，我们总结了这些经验 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="从400+节点ElasticSearch集群的运维中，我们总结了这些经验" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="原文链接： http://underthehood.meltwater.com/blog/2018/02/06/running-a-400+-node-es-cluster/ 墨墨导读：国外一家舆情监控公司Meltwater每天处理的数据非常庞大——在高峰期需要索引大约300多万社论文章，和近1亿条社交帖子数据。其中社论数据长期保存以供检索（可回溯到2009年），社交帖子数据保存近15个月的。当前的主分片数据使用了大约200 TB的磁盘空间，副本数据大约600 TB。 本文是Meltwater的工程师结合工作中实践，分享了Elasticsearch调优秘笈，以及要绕过的一些陷阱。 Meltwater每天要处理数百万量级的帖子数据，因此需要一种能处理该量级数据的存储和检索技术。 从0.11.X 版本开始我们就已经是Elasticsearch的忠实用户了。在经历了一些波折之后，最终我们认为做出了正确的技术选型。 Elasticsearch用于支持我们的主要媒体监控应用，客户通过该应用可以检索和分析媒体数据，比如新闻文章、（公开的）Facebook帖子、Instagram帖子、博客和微博。我们通过使用一个混合API来收集这些内容，并爬取和稍作加工，使得它们可被Elasticsearch检索到。 本文将分享我们所学到的经验、如何调优Elasticsearch，以及要绕过的一些陷阱。 数据量 每天都有数量相当庞大的新闻和微博产生；在高峰期需要索引大约300多万社论文章，和近1亿条社交帖子数据。其中社论数据长期保存以供检索（可回溯到2009年），社交帖子数据保存近15个月的。当前的主分片数据使用了大约200 TB的磁盘空间，副本数据大约600 TB。 我们的业务每分钟有3千次请求。所有的请求通过一个叫做“search-service”的服务，该服务会依次完成所有与Elasticsearch集群的交互。大部分检索规则比较复杂，包括在面板和新闻流中。比如，一个客户可能对Tesla和Elon Musk感兴趣，但希望排除所有关于SpaceX或PayPal的信息。用户可以使用一种与Lucene查询语法类似的灵活语法，如下： Tesla AND &quot;Elon Musk&quot; NOT (SpaceX OR PayPal) 我们最长的此类查询有60多页。重点是：除了每分钟3千次请求以外，没有一个查询是像在Google里查询“Barack Obama”这么简单的；这简直就是可怕的野兽，但ES节点必须努力找出一个匹配的文档集。 版本 我们运行的是一个基于Elasticsearch 1.7.6的定制版本。该版本与1.7.6 主干版本的唯一区别是，我们向后移植（backport）了roaring bitsets/bitmaps（http://suo.im/5bE6od）&nbsp;作为缓存。该功能是从Lucene 5移植到Lucene 4的，对应移植到了ES 1.X版本。Elasticsearch 1.X中使用默认的bitset作为缓存，对于稀疏结果来说开销非常大，不过在Elasticsearch 2.X中已经做了优化。 为何不使用较新版本的Elasticsearch呢？主要原因是升级困难。在主版本间滚动升级只适用于从ES 5到6（从ES 2到5应该也支持滚动升级，但没有试过）。因此，我们只能通过重启整个集群来升级。宕机对我们来说几乎不可接受，但或许可以应对一次重启所带来的大约30-60分钟宕机时间；而真正令人担心的，是一旦发生故障并没有真正的回滚过程。 截止目前我们选择了不升级集群。当然我们希望可以升级，但目前有更为紧迫的任务。实际上该如何实施升级尚未有定论，很可能选择创建另一个新的集群，而不是升级现有的。 节点配置 我们自2017年6月开始在AWS上运行主集群，使用i3.2xlarge实例作为数据节点。之前我们在COLO（Co-located Data Center）里运行集群，但后续迁移到了AWS云，以便在新机器宕机时能赢得时间，使得我们在扩容和缩容时更加弹性。 我们在不同的可用区运行3个候选master节点，并设置discovery.zen.minimum_master_nodes为2。这是避免脑裂问题 split-brain problem （https://qbox.io/blog/split-brain-problem-elasticsearch）非常通用的策略。 我们的数据集在存储方面，要求80%容量和3个以上的副本，这使得我们运行了430个数据节点。起初打算使用不同层级的数据，在较慢的磁盘上存储较旧的数据，但是由于我们只有相关的较低量级旧于15个月的数据（只有编辑数据，因为我们丢弃了旧的社交数据），然而这并未奏效。每个月的硬件开销远大于运行在COLO中，但是云服务支持扩容集群到2倍，而几乎不用花费多少时间。 你可能会问，为何选择自己管理维护ES集群。其实我们考虑过托管方案，但最后还是选择自己安装，理由是：AWS Elasticsearch Service （http://suo.im/4PLuXa）暴露给用户的可控性太差了， Elastic Cloud（https://www.elastic.co/cn/cloud）的成本比直接在EC2上运行集群要高2-3倍。 为了在某个可用区宕机时保护我们自身，节点分散于eu-west-1的所有3个可用区。我们使用AWS plugin（http://suo.im/5qFQEP）来完成该项配置。它提供了一个叫做aws_availability_zone的节点属性，我们把 cluster.routing.allocation.awareness.attributes 设置为aws_availability_zone。这保证了ES的副本尽可能地存储在不同的可用区，而查询尽可能被路由到相同可用区的节点。 这些实例运行的是Amazon Linux，临时挂载为ext4，有约64GB的内存。我们分配了26GB用于ES节点的堆内存，剩下的用于磁盘缓存。为何是26GB？因为JVM是在一个黑魔法之上构建的（https://www.elastic.co/blog/a-heap-of-trouble）。 我们同时使用Terraform （https://www.terraform.io/）自动扩容组来提供实例，并使用Puppet（https://puppet.com/）完成一切安装配置。 索引结构 因为我们的数据和查询都是基于时间序列的，所以使用了 time-based indexing（http://suo.im/547GbE）， 类似于ELK（elasticsearch、logstash、kibana） stack（https://www.elastic.co/elk-stack）。同时也让不同类型的数据保存在不同的索引库中，以便诸如社论文档和社交文档类数据最终位于不同的每日索引库中。这样可以在需要的时候只丢弃社交索引，并增加一些查询优化。每个日索引运行在两个分片中的一个。 该项设置产生了大量的分片（接近40k）。有了这么多的分片和节点，集群操作有时变得更特殊。比如，删除索引似乎成为集群master的能力瓶颈，它需要把集群状态信息推送给所有节点。我们的集群状态数据约100 MB，但通过TCP压缩可减少到3 MB （可以通过curl localhost:9200/_cluster/state/_all&nbsp;查看你自己集群的状态数据）。Master节点仍然需要在每次变更时推送1.3 GB数据（430 节点 x 3 MB 状态大小）。除了这1.3 GB数据外，还有约860 MB必须在可用区（比如 最基本的通过公共互联网）之间传输。这会比较耗时，尤其是在删除数百个索引时。我们希望新版本的Elasticsearch能优化这一点，首先从ES 2.0支持仅发送集群状态的差分数据(http://suo.im/547UyM)这一特性开始。 ElasticSearch性能 如前所述，我们的ES集群为了满足客户的检索需求，需要处理一些非常复杂的查询。 为应对查询负载，过去几年我们在性能方面做了大量的工作。我们必须尝试公平分享ES集群的性能测试，从下列引文就可以看出。 不幸的是，当集群宕机的时候，不到三分之一的查询能成功完成。我们相信测试本身导致了集群宕机。&nbsp; —— 摘录自使用真实查询在新ES集群平台上的第一次性能测试 为了控制查询执行过程，我们开发了一个插件，实现了一系列自定义查询类型。通过使用这些查询类型来提供Elasticsearch官方版本不支持的功能和性能优化。比如，我们实现了phrases中的wildcard查询，支持在SpanNear查询中执行；另一个优化是支持“*”代替match-all-query；还有其他一系列特性。 Elasticsearch和Lucene的性能高度依赖于具体的查询和数据，没有银弹。即便如此，仍可给出一些从基础到进阶的参考： 限制你的检索范围，仅涉及相关数据。比如，对于每日索引库，只按相关日期范围检索。对于检索范围中间的索引，避免使用范围查询/过滤器。 使用wildcards时忽略前缀wildcards&nbsp;- 除非你能对term建立倒排索引。双端wildcards难以优化。 关注资源消耗的相关迹象，数据节点的CPU占用持续飙高吗？IQ等待走高吗？看看GC统计。这些可以从profilers工具或者通过JMX代理获得。如果ParNewGC消耗了超过15%的时间，去检查下内存日志。如果有任何的SerialGC停顿，你可能真的遇到问题了。不太了解这些内容？没关系，这个系列博文很好地介绍了JVM性能（http://suo.im/4AJgps）&nbsp;。记住，ES和G1垃圾回收器一起并非最佳（http://suo.im/4WBTA5）。 如果遇到垃圾回收问题，请不要尝试调整GC设置。这一点经常发生，因为默认设置已经很合理了。相反，应该聚焦在减少内存分配上。具体怎么做？参考下文。 如果遇到内存问题，但没有时间解决，可考虑查询Azul Zing。这是一个很贵的产品，但仅仅使用它们的JVM就可以提升2倍的吞吐量。不过最终我们并没有使用它，因为我们无法证明物有所值。 考虑使用缓存，包括Elasticsearch外缓存和Lucene级别的缓存。在Elasticsearch 1.X中可以通过使用filter来控制缓存。之后的版本中看起来更难一些，但貌似可以实现自己用于缓存的查询类型。我们在未来升级到2.X的时候可能会做类似的工作。 查看是否有热点数据（比如某个节点承担了所有的负载）。可以尝试均衡负载，使用分片分配过滤策略shard allocation filtering（http://suo.im/4IfruL），或者尝试通过集群重新路由cluster rerouting（http://suo.im/5ja7cU）来自行迁移分片。我们已经使用线性优化自动重新路由，但使用简单的自动化策略也大有帮助。 搭建测试环境（我更喜欢笔记本）可从线上环境加载一部分代表性的数据（建议至少有一个分片）。使用线上的查询回放加压（较难）。使用本地设置来测试请求的资源消耗。 综合以上各点，在Elasticsearch进程上启用一个profiler。这是本列表中最重要的一条。我们同时通过Java Mission Control&nbsp;（http://suo.im/4zYEsP）和 VisualVM&nbsp;（http://suo.im/4AJeIM）使用飞行记录器。在性能问题上尝试投机（包括付费顾问/技术支持）的人是在浪费他们（以及你自己）的时间。排查下JVM哪部分消耗了时间和内存，然后探索下Elasticsearch/Lucene源代码，检查是哪部分代码在执行或者分配内存。 一旦搞清楚是请求的哪一部分导致了响应变慢，你就可以通过尝试修改请求来优化（比如，修改term聚合的执行提示（http://suo.im/4WBUJx），或者切换查询类型）。修改查询类型或者查询顺序，可以有较大影响。如果不凑效，还可以尝试优化ES/Lucene代码。这看起来太夸张，却可以为我们降低3到4倍的CPU消耗和4到8倍的内存使用。某些修改很细微（比如 indices query&nbsp;（http://suo.im/4WBUR7）），但其他人可能要求我们完全重写查询执行。最终的代码严重依赖于我们的查询模式，所以可能适合也可能不适合他人使用。因此目前为止我们并没有开源这部分代码。不过这可能是下一篇博文的好素材。 图表说明：响应时间。有/没有 重写Lucene查询执行。同时也表明不再有节点每天多次发生内存不足。 顺便说明下，因为我知道会面临一个问题：从上一次性能测试我们知道通过升级到ES 2.X能小幅提升性能，但是并不能改变什么。话虽如此，但如果你已经从ES 1.X集群迁移到了ES 2.X，我们很乐意听取关于你如何完成迁移的实践经验。 如果读到了这里，说明你对Elasticsearch是真爱啊（或者至少你是真的需要它）。我们很乐意学习你的经验，以及任何可以分享的内容。欢迎在评论区分享你的反馈和问题。 作者：Anton Hägerstrand 翻译：杨振涛 扩展阅读 Elasticsearch如何做到亿级数据查询毫秒级返回？ 从 Elasticsearch 来看分布式系统架构设计 超详细的Elasticsearch高性能优化实践 MySQL从零到一解读增量同步数据到elasticsearch canal adapter方式(binlog)实现 墙裂推荐 | 漫画解读Elasticsearch原理，看完你就懂 有多少漏洞都会重来:从ElasticSearch到MongoDB和Redis 数据和云 ID：OraNews 如有收获，请划至底部，点击“在看”，谢谢！ 公司简介&nbsp;&nbsp;|&nbsp;招聘&nbsp;|&nbsp;DTCC&nbsp;|&nbsp;数据技术嘉年华&nbsp;|&nbsp;免费课程&nbsp;|&nbsp;入驻华为严选商城&nbsp;&nbsp; zCloud&nbsp;|&nbsp;SQM&nbsp;|&nbsp;Bethune Pro2&nbsp;|&nbsp;zData一体机&nbsp;|&nbsp;MyData一体机&nbsp;|&nbsp;ZDBM 备份一体机 Oracle技术架构&nbsp;|&nbsp;免费课程&nbsp;|&nbsp;数据库排行榜&nbsp;|&nbsp;DBASK问题集萃&nbsp;|&nbsp;技术通讯&nbsp; 升级迁移&nbsp;|&nbsp;性能优化&nbsp;|&nbsp;智能整合&nbsp;|&nbsp;安全保障&nbsp;|&nbsp;&nbsp;架构设计&nbsp;|&nbsp;SQL审核&nbsp;|&nbsp;分布式架构&nbsp;|&nbsp;高可用容灾&nbsp;|&nbsp;运维代维 云和恩墨大讲堂 |&nbsp;一个分享交流的地方 长按，识别二维码，加入万人交流社群 请备注：云和恩墨大讲堂" />
<meta property="og:description" content="原文链接： http://underthehood.meltwater.com/blog/2018/02/06/running-a-400+-node-es-cluster/ 墨墨导读：国外一家舆情监控公司Meltwater每天处理的数据非常庞大——在高峰期需要索引大约300多万社论文章，和近1亿条社交帖子数据。其中社论数据长期保存以供检索（可回溯到2009年），社交帖子数据保存近15个月的。当前的主分片数据使用了大约200 TB的磁盘空间，副本数据大约600 TB。 本文是Meltwater的工程师结合工作中实践，分享了Elasticsearch调优秘笈，以及要绕过的一些陷阱。 Meltwater每天要处理数百万量级的帖子数据，因此需要一种能处理该量级数据的存储和检索技术。 从0.11.X 版本开始我们就已经是Elasticsearch的忠实用户了。在经历了一些波折之后，最终我们认为做出了正确的技术选型。 Elasticsearch用于支持我们的主要媒体监控应用，客户通过该应用可以检索和分析媒体数据，比如新闻文章、（公开的）Facebook帖子、Instagram帖子、博客和微博。我们通过使用一个混合API来收集这些内容，并爬取和稍作加工，使得它们可被Elasticsearch检索到。 本文将分享我们所学到的经验、如何调优Elasticsearch，以及要绕过的一些陷阱。 数据量 每天都有数量相当庞大的新闻和微博产生；在高峰期需要索引大约300多万社论文章，和近1亿条社交帖子数据。其中社论数据长期保存以供检索（可回溯到2009年），社交帖子数据保存近15个月的。当前的主分片数据使用了大约200 TB的磁盘空间，副本数据大约600 TB。 我们的业务每分钟有3千次请求。所有的请求通过一个叫做“search-service”的服务，该服务会依次完成所有与Elasticsearch集群的交互。大部分检索规则比较复杂，包括在面板和新闻流中。比如，一个客户可能对Tesla和Elon Musk感兴趣，但希望排除所有关于SpaceX或PayPal的信息。用户可以使用一种与Lucene查询语法类似的灵活语法，如下： Tesla AND &quot;Elon Musk&quot; NOT (SpaceX OR PayPal) 我们最长的此类查询有60多页。重点是：除了每分钟3千次请求以外，没有一个查询是像在Google里查询“Barack Obama”这么简单的；这简直就是可怕的野兽，但ES节点必须努力找出一个匹配的文档集。 版本 我们运行的是一个基于Elasticsearch 1.7.6的定制版本。该版本与1.7.6 主干版本的唯一区别是，我们向后移植（backport）了roaring bitsets/bitmaps（http://suo.im/5bE6od）&nbsp;作为缓存。该功能是从Lucene 5移植到Lucene 4的，对应移植到了ES 1.X版本。Elasticsearch 1.X中使用默认的bitset作为缓存，对于稀疏结果来说开销非常大，不过在Elasticsearch 2.X中已经做了优化。 为何不使用较新版本的Elasticsearch呢？主要原因是升级困难。在主版本间滚动升级只适用于从ES 5到6（从ES 2到5应该也支持滚动升级，但没有试过）。因此，我们只能通过重启整个集群来升级。宕机对我们来说几乎不可接受，但或许可以应对一次重启所带来的大约30-60分钟宕机时间；而真正令人担心的，是一旦发生故障并没有真正的回滚过程。 截止目前我们选择了不升级集群。当然我们希望可以升级，但目前有更为紧迫的任务。实际上该如何实施升级尚未有定论，很可能选择创建另一个新的集群，而不是升级现有的。 节点配置 我们自2017年6月开始在AWS上运行主集群，使用i3.2xlarge实例作为数据节点。之前我们在COLO（Co-located Data Center）里运行集群，但后续迁移到了AWS云，以便在新机器宕机时能赢得时间，使得我们在扩容和缩容时更加弹性。 我们在不同的可用区运行3个候选master节点，并设置discovery.zen.minimum_master_nodes为2。这是避免脑裂问题 split-brain problem （https://qbox.io/blog/split-brain-problem-elasticsearch）非常通用的策略。 我们的数据集在存储方面，要求80%容量和3个以上的副本，这使得我们运行了430个数据节点。起初打算使用不同层级的数据，在较慢的磁盘上存储较旧的数据，但是由于我们只有相关的较低量级旧于15个月的数据（只有编辑数据，因为我们丢弃了旧的社交数据），然而这并未奏效。每个月的硬件开销远大于运行在COLO中，但是云服务支持扩容集群到2倍，而几乎不用花费多少时间。 你可能会问，为何选择自己管理维护ES集群。其实我们考虑过托管方案，但最后还是选择自己安装，理由是：AWS Elasticsearch Service （http://suo.im/4PLuXa）暴露给用户的可控性太差了， Elastic Cloud（https://www.elastic.co/cn/cloud）的成本比直接在EC2上运行集群要高2-3倍。 为了在某个可用区宕机时保护我们自身，节点分散于eu-west-1的所有3个可用区。我们使用AWS plugin（http://suo.im/5qFQEP）来完成该项配置。它提供了一个叫做aws_availability_zone的节点属性，我们把 cluster.routing.allocation.awareness.attributes 设置为aws_availability_zone。这保证了ES的副本尽可能地存储在不同的可用区，而查询尽可能被路由到相同可用区的节点。 这些实例运行的是Amazon Linux，临时挂载为ext4，有约64GB的内存。我们分配了26GB用于ES节点的堆内存，剩下的用于磁盘缓存。为何是26GB？因为JVM是在一个黑魔法之上构建的（https://www.elastic.co/blog/a-heap-of-trouble）。 我们同时使用Terraform （https://www.terraform.io/）自动扩容组来提供实例，并使用Puppet（https://puppet.com/）完成一切安装配置。 索引结构 因为我们的数据和查询都是基于时间序列的，所以使用了 time-based indexing（http://suo.im/547GbE）， 类似于ELK（elasticsearch、logstash、kibana） stack（https://www.elastic.co/elk-stack）。同时也让不同类型的数据保存在不同的索引库中，以便诸如社论文档和社交文档类数据最终位于不同的每日索引库中。这样可以在需要的时候只丢弃社交索引，并增加一些查询优化。每个日索引运行在两个分片中的一个。 该项设置产生了大量的分片（接近40k）。有了这么多的分片和节点，集群操作有时变得更特殊。比如，删除索引似乎成为集群master的能力瓶颈，它需要把集群状态信息推送给所有节点。我们的集群状态数据约100 MB，但通过TCP压缩可减少到3 MB （可以通过curl localhost:9200/_cluster/state/_all&nbsp;查看你自己集群的状态数据）。Master节点仍然需要在每次变更时推送1.3 GB数据（430 节点 x 3 MB 状态大小）。除了这1.3 GB数据外，还有约860 MB必须在可用区（比如 最基本的通过公共互联网）之间传输。这会比较耗时，尤其是在删除数百个索引时。我们希望新版本的Elasticsearch能优化这一点，首先从ES 2.0支持仅发送集群状态的差分数据(http://suo.im/547UyM)这一特性开始。 ElasticSearch性能 如前所述，我们的ES集群为了满足客户的检索需求，需要处理一些非常复杂的查询。 为应对查询负载，过去几年我们在性能方面做了大量的工作。我们必须尝试公平分享ES集群的性能测试，从下列引文就可以看出。 不幸的是，当集群宕机的时候，不到三分之一的查询能成功完成。我们相信测试本身导致了集群宕机。&nbsp; —— 摘录自使用真实查询在新ES集群平台上的第一次性能测试 为了控制查询执行过程，我们开发了一个插件，实现了一系列自定义查询类型。通过使用这些查询类型来提供Elasticsearch官方版本不支持的功能和性能优化。比如，我们实现了phrases中的wildcard查询，支持在SpanNear查询中执行；另一个优化是支持“*”代替match-all-query；还有其他一系列特性。 Elasticsearch和Lucene的性能高度依赖于具体的查询和数据，没有银弹。即便如此，仍可给出一些从基础到进阶的参考： 限制你的检索范围，仅涉及相关数据。比如，对于每日索引库，只按相关日期范围检索。对于检索范围中间的索引，避免使用范围查询/过滤器。 使用wildcards时忽略前缀wildcards&nbsp;- 除非你能对term建立倒排索引。双端wildcards难以优化。 关注资源消耗的相关迹象，数据节点的CPU占用持续飙高吗？IQ等待走高吗？看看GC统计。这些可以从profilers工具或者通过JMX代理获得。如果ParNewGC消耗了超过15%的时间，去检查下内存日志。如果有任何的SerialGC停顿，你可能真的遇到问题了。不太了解这些内容？没关系，这个系列博文很好地介绍了JVM性能（http://suo.im/4AJgps）&nbsp;。记住，ES和G1垃圾回收器一起并非最佳（http://suo.im/4WBTA5）。 如果遇到垃圾回收问题，请不要尝试调整GC设置。这一点经常发生，因为默认设置已经很合理了。相反，应该聚焦在减少内存分配上。具体怎么做？参考下文。 如果遇到内存问题，但没有时间解决，可考虑查询Azul Zing。这是一个很贵的产品，但仅仅使用它们的JVM就可以提升2倍的吞吐量。不过最终我们并没有使用它，因为我们无法证明物有所值。 考虑使用缓存，包括Elasticsearch外缓存和Lucene级别的缓存。在Elasticsearch 1.X中可以通过使用filter来控制缓存。之后的版本中看起来更难一些，但貌似可以实现自己用于缓存的查询类型。我们在未来升级到2.X的时候可能会做类似的工作。 查看是否有热点数据（比如某个节点承担了所有的负载）。可以尝试均衡负载，使用分片分配过滤策略shard allocation filtering（http://suo.im/4IfruL），或者尝试通过集群重新路由cluster rerouting（http://suo.im/5ja7cU）来自行迁移分片。我们已经使用线性优化自动重新路由，但使用简单的自动化策略也大有帮助。 搭建测试环境（我更喜欢笔记本）可从线上环境加载一部分代表性的数据（建议至少有一个分片）。使用线上的查询回放加压（较难）。使用本地设置来测试请求的资源消耗。 综合以上各点，在Elasticsearch进程上启用一个profiler。这是本列表中最重要的一条。我们同时通过Java Mission Control&nbsp;（http://suo.im/4zYEsP）和 VisualVM&nbsp;（http://suo.im/4AJeIM）使用飞行记录器。在性能问题上尝试投机（包括付费顾问/技术支持）的人是在浪费他们（以及你自己）的时间。排查下JVM哪部分消耗了时间和内存，然后探索下Elasticsearch/Lucene源代码，检查是哪部分代码在执行或者分配内存。 一旦搞清楚是请求的哪一部分导致了响应变慢，你就可以通过尝试修改请求来优化（比如，修改term聚合的执行提示（http://suo.im/4WBUJx），或者切换查询类型）。修改查询类型或者查询顺序，可以有较大影响。如果不凑效，还可以尝试优化ES/Lucene代码。这看起来太夸张，却可以为我们降低3到4倍的CPU消耗和4到8倍的内存使用。某些修改很细微（比如 indices query&nbsp;（http://suo.im/4WBUR7）），但其他人可能要求我们完全重写查询执行。最终的代码严重依赖于我们的查询模式，所以可能适合也可能不适合他人使用。因此目前为止我们并没有开源这部分代码。不过这可能是下一篇博文的好素材。 图表说明：响应时间。有/没有 重写Lucene查询执行。同时也表明不再有节点每天多次发生内存不足。 顺便说明下，因为我知道会面临一个问题：从上一次性能测试我们知道通过升级到ES 2.X能小幅提升性能，但是并不能改变什么。话虽如此，但如果你已经从ES 1.X集群迁移到了ES 2.X，我们很乐意听取关于你如何完成迁移的实践经验。 如果读到了这里，说明你对Elasticsearch是真爱啊（或者至少你是真的需要它）。我们很乐意学习你的经验，以及任何可以分享的内容。欢迎在评论区分享你的反馈和问题。 作者：Anton Hägerstrand 翻译：杨振涛 扩展阅读 Elasticsearch如何做到亿级数据查询毫秒级返回？ 从 Elasticsearch 来看分布式系统架构设计 超详细的Elasticsearch高性能优化实践 MySQL从零到一解读增量同步数据到elasticsearch canal adapter方式(binlog)实现 墙裂推荐 | 漫画解读Elasticsearch原理，看完你就懂 有多少漏洞都会重来:从ElasticSearch到MongoDB和Redis 数据和云 ID：OraNews 如有收获，请划至底部，点击“在看”，谢谢！ 公司简介&nbsp;&nbsp;|&nbsp;招聘&nbsp;|&nbsp;DTCC&nbsp;|&nbsp;数据技术嘉年华&nbsp;|&nbsp;免费课程&nbsp;|&nbsp;入驻华为严选商城&nbsp;&nbsp; zCloud&nbsp;|&nbsp;SQM&nbsp;|&nbsp;Bethune Pro2&nbsp;|&nbsp;zData一体机&nbsp;|&nbsp;MyData一体机&nbsp;|&nbsp;ZDBM 备份一体机 Oracle技术架构&nbsp;|&nbsp;免费课程&nbsp;|&nbsp;数据库排行榜&nbsp;|&nbsp;DBASK问题集萃&nbsp;|&nbsp;技术通讯&nbsp; 升级迁移&nbsp;|&nbsp;性能优化&nbsp;|&nbsp;智能整合&nbsp;|&nbsp;安全保障&nbsp;|&nbsp;&nbsp;架构设计&nbsp;|&nbsp;SQL审核&nbsp;|&nbsp;分布式架构&nbsp;|&nbsp;高可用容灾&nbsp;|&nbsp;运维代维 云和恩墨大讲堂 |&nbsp;一个分享交流的地方 长按，识别二维码，加入万人交流社群 请备注：云和恩墨大讲堂" />
<link rel="canonical" href="https://uzzz.org/2019/07/31/792811.html" />
<meta property="og:url" content="https://uzzz.org/2019/07/31/792811.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-07-31T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"原文链接： http://underthehood.meltwater.com/blog/2018/02/06/running-a-400+-node-es-cluster/ 墨墨导读：国外一家舆情监控公司Meltwater每天处理的数据非常庞大——在高峰期需要索引大约300多万社论文章，和近1亿条社交帖子数据。其中社论数据长期保存以供检索（可回溯到2009年），社交帖子数据保存近15个月的。当前的主分片数据使用了大约200 TB的磁盘空间，副本数据大约600 TB。 本文是Meltwater的工程师结合工作中实践，分享了Elasticsearch调优秘笈，以及要绕过的一些陷阱。 Meltwater每天要处理数百万量级的帖子数据，因此需要一种能处理该量级数据的存储和检索技术。 从0.11.X 版本开始我们就已经是Elasticsearch的忠实用户了。在经历了一些波折之后，最终我们认为做出了正确的技术选型。 Elasticsearch用于支持我们的主要媒体监控应用，客户通过该应用可以检索和分析媒体数据，比如新闻文章、（公开的）Facebook帖子、Instagram帖子、博客和微博。我们通过使用一个混合API来收集这些内容，并爬取和稍作加工，使得它们可被Elasticsearch检索到。 本文将分享我们所学到的经验、如何调优Elasticsearch，以及要绕过的一些陷阱。 数据量 每天都有数量相当庞大的新闻和微博产生；在高峰期需要索引大约300多万社论文章，和近1亿条社交帖子数据。其中社论数据长期保存以供检索（可回溯到2009年），社交帖子数据保存近15个月的。当前的主分片数据使用了大约200 TB的磁盘空间，副本数据大约600 TB。 我们的业务每分钟有3千次请求。所有的请求通过一个叫做“search-service”的服务，该服务会依次完成所有与Elasticsearch集群的交互。大部分检索规则比较复杂，包括在面板和新闻流中。比如，一个客户可能对Tesla和Elon Musk感兴趣，但希望排除所有关于SpaceX或PayPal的信息。用户可以使用一种与Lucene查询语法类似的灵活语法，如下： Tesla AND &quot;Elon Musk&quot; NOT (SpaceX OR PayPal) 我们最长的此类查询有60多页。重点是：除了每分钟3千次请求以外，没有一个查询是像在Google里查询“Barack Obama”这么简单的；这简直就是可怕的野兽，但ES节点必须努力找出一个匹配的文档集。 版本 我们运行的是一个基于Elasticsearch 1.7.6的定制版本。该版本与1.7.6 主干版本的唯一区别是，我们向后移植（backport）了roaring bitsets/bitmaps（http://suo.im/5bE6od）&nbsp;作为缓存。该功能是从Lucene 5移植到Lucene 4的，对应移植到了ES 1.X版本。Elasticsearch 1.X中使用默认的bitset作为缓存，对于稀疏结果来说开销非常大，不过在Elasticsearch 2.X中已经做了优化。 为何不使用较新版本的Elasticsearch呢？主要原因是升级困难。在主版本间滚动升级只适用于从ES 5到6（从ES 2到5应该也支持滚动升级，但没有试过）。因此，我们只能通过重启整个集群来升级。宕机对我们来说几乎不可接受，但或许可以应对一次重启所带来的大约30-60分钟宕机时间；而真正令人担心的，是一旦发生故障并没有真正的回滚过程。 截止目前我们选择了不升级集群。当然我们希望可以升级，但目前有更为紧迫的任务。实际上该如何实施升级尚未有定论，很可能选择创建另一个新的集群，而不是升级现有的。 节点配置 我们自2017年6月开始在AWS上运行主集群，使用i3.2xlarge实例作为数据节点。之前我们在COLO（Co-located Data Center）里运行集群，但后续迁移到了AWS云，以便在新机器宕机时能赢得时间，使得我们在扩容和缩容时更加弹性。 我们在不同的可用区运行3个候选master节点，并设置discovery.zen.minimum_master_nodes为2。这是避免脑裂问题 split-brain problem （https://qbox.io/blog/split-brain-problem-elasticsearch）非常通用的策略。 我们的数据集在存储方面，要求80%容量和3个以上的副本，这使得我们运行了430个数据节点。起初打算使用不同层级的数据，在较慢的磁盘上存储较旧的数据，但是由于我们只有相关的较低量级旧于15个月的数据（只有编辑数据，因为我们丢弃了旧的社交数据），然而这并未奏效。每个月的硬件开销远大于运行在COLO中，但是云服务支持扩容集群到2倍，而几乎不用花费多少时间。 你可能会问，为何选择自己管理维护ES集群。其实我们考虑过托管方案，但最后还是选择自己安装，理由是：AWS Elasticsearch Service （http://suo.im/4PLuXa）暴露给用户的可控性太差了， Elastic Cloud（https://www.elastic.co/cn/cloud）的成本比直接在EC2上运行集群要高2-3倍。 为了在某个可用区宕机时保护我们自身，节点分散于eu-west-1的所有3个可用区。我们使用AWS plugin（http://suo.im/5qFQEP）来完成该项配置。它提供了一个叫做aws_availability_zone的节点属性，我们把 cluster.routing.allocation.awareness.attributes 设置为aws_availability_zone。这保证了ES的副本尽可能地存储在不同的可用区，而查询尽可能被路由到相同可用区的节点。 这些实例运行的是Amazon Linux，临时挂载为ext4，有约64GB的内存。我们分配了26GB用于ES节点的堆内存，剩下的用于磁盘缓存。为何是26GB？因为JVM是在一个黑魔法之上构建的（https://www.elastic.co/blog/a-heap-of-trouble）。 我们同时使用Terraform （https://www.terraform.io/）自动扩容组来提供实例，并使用Puppet（https://puppet.com/）完成一切安装配置。 索引结构 因为我们的数据和查询都是基于时间序列的，所以使用了 time-based indexing（http://suo.im/547GbE）， 类似于ELK（elasticsearch、logstash、kibana） stack（https://www.elastic.co/elk-stack）。同时也让不同类型的数据保存在不同的索引库中，以便诸如社论文档和社交文档类数据最终位于不同的每日索引库中。这样可以在需要的时候只丢弃社交索引，并增加一些查询优化。每个日索引运行在两个分片中的一个。 该项设置产生了大量的分片（接近40k）。有了这么多的分片和节点，集群操作有时变得更特殊。比如，删除索引似乎成为集群master的能力瓶颈，它需要把集群状态信息推送给所有节点。我们的集群状态数据约100 MB，但通过TCP压缩可减少到3 MB （可以通过curl localhost:9200/_cluster/state/_all&nbsp;查看你自己集群的状态数据）。Master节点仍然需要在每次变更时推送1.3 GB数据（430 节点 x 3 MB 状态大小）。除了这1.3 GB数据外，还有约860 MB必须在可用区（比如 最基本的通过公共互联网）之间传输。这会比较耗时，尤其是在删除数百个索引时。我们希望新版本的Elasticsearch能优化这一点，首先从ES 2.0支持仅发送集群状态的差分数据(http://suo.im/547UyM)这一特性开始。 ElasticSearch性能 如前所述，我们的ES集群为了满足客户的检索需求，需要处理一些非常复杂的查询。 为应对查询负载，过去几年我们在性能方面做了大量的工作。我们必须尝试公平分享ES集群的性能测试，从下列引文就可以看出。 不幸的是，当集群宕机的时候，不到三分之一的查询能成功完成。我们相信测试本身导致了集群宕机。&nbsp; —— 摘录自使用真实查询在新ES集群平台上的第一次性能测试 为了控制查询执行过程，我们开发了一个插件，实现了一系列自定义查询类型。通过使用这些查询类型来提供Elasticsearch官方版本不支持的功能和性能优化。比如，我们实现了phrases中的wildcard查询，支持在SpanNear查询中执行；另一个优化是支持“*”代替match-all-query；还有其他一系列特性。 Elasticsearch和Lucene的性能高度依赖于具体的查询和数据，没有银弹。即便如此，仍可给出一些从基础到进阶的参考： 限制你的检索范围，仅涉及相关数据。比如，对于每日索引库，只按相关日期范围检索。对于检索范围中间的索引，避免使用范围查询/过滤器。 使用wildcards时忽略前缀wildcards&nbsp;- 除非你能对term建立倒排索引。双端wildcards难以优化。 关注资源消耗的相关迹象，数据节点的CPU占用持续飙高吗？IQ等待走高吗？看看GC统计。这些可以从profilers工具或者通过JMX代理获得。如果ParNewGC消耗了超过15%的时间，去检查下内存日志。如果有任何的SerialGC停顿，你可能真的遇到问题了。不太了解这些内容？没关系，这个系列博文很好地介绍了JVM性能（http://suo.im/4AJgps）&nbsp;。记住，ES和G1垃圾回收器一起并非最佳（http://suo.im/4WBTA5）。 如果遇到垃圾回收问题，请不要尝试调整GC设置。这一点经常发生，因为默认设置已经很合理了。相反，应该聚焦在减少内存分配上。具体怎么做？参考下文。 如果遇到内存问题，但没有时间解决，可考虑查询Azul Zing。这是一个很贵的产品，但仅仅使用它们的JVM就可以提升2倍的吞吐量。不过最终我们并没有使用它，因为我们无法证明物有所值。 考虑使用缓存，包括Elasticsearch外缓存和Lucene级别的缓存。在Elasticsearch 1.X中可以通过使用filter来控制缓存。之后的版本中看起来更难一些，但貌似可以实现自己用于缓存的查询类型。我们在未来升级到2.X的时候可能会做类似的工作。 查看是否有热点数据（比如某个节点承担了所有的负载）。可以尝试均衡负载，使用分片分配过滤策略shard allocation filtering（http://suo.im/4IfruL），或者尝试通过集群重新路由cluster rerouting（http://suo.im/5ja7cU）来自行迁移分片。我们已经使用线性优化自动重新路由，但使用简单的自动化策略也大有帮助。 搭建测试环境（我更喜欢笔记本）可从线上环境加载一部分代表性的数据（建议至少有一个分片）。使用线上的查询回放加压（较难）。使用本地设置来测试请求的资源消耗。 综合以上各点，在Elasticsearch进程上启用一个profiler。这是本列表中最重要的一条。我们同时通过Java Mission Control&nbsp;（http://suo.im/4zYEsP）和 VisualVM&nbsp;（http://suo.im/4AJeIM）使用飞行记录器。在性能问题上尝试投机（包括付费顾问/技术支持）的人是在浪费他们（以及你自己）的时间。排查下JVM哪部分消耗了时间和内存，然后探索下Elasticsearch/Lucene源代码，检查是哪部分代码在执行或者分配内存。 一旦搞清楚是请求的哪一部分导致了响应变慢，你就可以通过尝试修改请求来优化（比如，修改term聚合的执行提示（http://suo.im/4WBUJx），或者切换查询类型）。修改查询类型或者查询顺序，可以有较大影响。如果不凑效，还可以尝试优化ES/Lucene代码。这看起来太夸张，却可以为我们降低3到4倍的CPU消耗和4到8倍的内存使用。某些修改很细微（比如 indices query&nbsp;（http://suo.im/4WBUR7）），但其他人可能要求我们完全重写查询执行。最终的代码严重依赖于我们的查询模式，所以可能适合也可能不适合他人使用。因此目前为止我们并没有开源这部分代码。不过这可能是下一篇博文的好素材。 图表说明：响应时间。有/没有 重写Lucene查询执行。同时也表明不再有节点每天多次发生内存不足。 顺便说明下，因为我知道会面临一个问题：从上一次性能测试我们知道通过升级到ES 2.X能小幅提升性能，但是并不能改变什么。话虽如此，但如果你已经从ES 1.X集群迁移到了ES 2.X，我们很乐意听取关于你如何完成迁移的实践经验。 如果读到了这里，说明你对Elasticsearch是真爱啊（或者至少你是真的需要它）。我们很乐意学习你的经验，以及任何可以分享的内容。欢迎在评论区分享你的反馈和问题。 作者：Anton Hägerstrand 翻译：杨振涛 扩展阅读 Elasticsearch如何做到亿级数据查询毫秒级返回？ 从 Elasticsearch 来看分布式系统架构设计 超详细的Elasticsearch高性能优化实践 MySQL从零到一解读增量同步数据到elasticsearch canal adapter方式(binlog)实现 墙裂推荐 | 漫画解读Elasticsearch原理，看完你就懂 有多少漏洞都会重来:从ElasticSearch到MongoDB和Redis 数据和云 ID：OraNews 如有收获，请划至底部，点击“在看”，谢谢！ 公司简介&nbsp;&nbsp;|&nbsp;招聘&nbsp;|&nbsp;DTCC&nbsp;|&nbsp;数据技术嘉年华&nbsp;|&nbsp;免费课程&nbsp;|&nbsp;入驻华为严选商城&nbsp;&nbsp; zCloud&nbsp;|&nbsp;SQM&nbsp;|&nbsp;Bethune Pro2&nbsp;|&nbsp;zData一体机&nbsp;|&nbsp;MyData一体机&nbsp;|&nbsp;ZDBM 备份一体机 Oracle技术架构&nbsp;|&nbsp;免费课程&nbsp;|&nbsp;数据库排行榜&nbsp;|&nbsp;DBASK问题集萃&nbsp;|&nbsp;技术通讯&nbsp; 升级迁移&nbsp;|&nbsp;性能优化&nbsp;|&nbsp;智能整合&nbsp;|&nbsp;安全保障&nbsp;|&nbsp;&nbsp;架构设计&nbsp;|&nbsp;SQL审核&nbsp;|&nbsp;分布式架构&nbsp;|&nbsp;高可用容灾&nbsp;|&nbsp;运维代维 云和恩墨大讲堂 |&nbsp;一个分享交流的地方 长按，识别二维码，加入万人交流社群 请备注：云和恩墨大讲堂","@type":"BlogPosting","url":"https://uzzz.org/2019/07/31/792811.html","headline":"从400+节点ElasticSearch集群的运维中，我们总结了这些经验","dateModified":"2019-07-31T00:00:00+08:00","datePublished":"2019-07-31T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://uzzz.org/2019/07/31/792811.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>从400+节点ElasticSearch集群的运维中，我们总结了这些经验</h1>
        
        
        <ul style="display: block;">
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
 	    <li><a href="/donate/" style="line-height: unset;" target="_blank"><strong>Donate</strong></a></li>
        </ul>
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
<!-- match content ads -->
	        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
			<ins class="adsbygoogle"
			     style="display:block"
			     data-ad-format="autorelaxed"
			     data-ad-client="ca-pub-8889449066804352"
			     data-ad-slot="1928667997"></ins>
			<script>
			     (adsbygoogle = window.adsbygoogle || []).push({});
			</script>	



        <div id="article_content" class="article_content clearfix"> 
 <div class="article-source-link">
   原文链接：
  <a href="http://underthehood.meltwater.com/blog/2018/02/06/running-a-400+-node-es-cluster/" target="_blank">http://underthehood.meltwater.com/blog/2018/02/06/running-a-400+-node-es-cluster/</a> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-3019150162.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-3019150162.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="rich_media_content" id="js_content"> 
   <p><strong><span style="font-size:15px;">墨墨导读：</span></strong><span style="font-size:15px;">国外一家舆情监控公司Meltwater每天处理的数据非常庞大——在高峰期需要索引大约300多万社论文章，和近1亿条社交帖子数据。其中社论数据长期保存以供检索（可回溯到2009年），社交帖子数据保存近15个月的。当前的主分片数据使用了大约200 TB的磁盘空间，副本数据大约600 TB。<br></span></p>
   <p><span style="font-size:15px;"><br></span></p>
   <p><span style="font-size:15px;">本文是<span style="font-size:15px;">Meltwater</span>的工程师结合工作中实践，分享了Elasticsearch<span style="font-size:15px;">调优秘笈</span>，以及要绕过的一些陷阱。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-weight:normal;letter-spacing:.544px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p><span style="font-size:12px;color:rgb(136,136,136);"></span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2000007629395px;text-indent:0px;text-transform:none;word-spacing:0px;text-align:left;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">Meltwater每天要处理数百万量级的帖子数据，因此需要一种能处理该量级数据的存储和检索技术。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2000007629395px;text-indent:0px;text-transform:none;word-spacing:0px;text-align:left;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;"><br></span></p>
   <img style="width:320px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/4g5IMGibSxt4MGPACk84mvUwtWy1xia7wuXntIXBtf6h6MiaQC8Rg6eI1S5m1ibibIXTa8a61xbNO7uEOaoibkxICCmA/640?wx_fmt=png" alt="640?wx_fmt=png">
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2px;text-align:left;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">从0.11.X 版本开始我们就已经是Elasticsearch的忠实用户了。在经历了一些波折之后，最终我们认为做出了正确的技术选型。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">Elasticsearch用于支持我们的主要媒体监控应用，客户通过该应用可以检索和分析媒体数据，比如新闻文章、（公开的）Facebook帖子、Instagram帖子、博客和微博。我们通过使用一个混合API来收集这些内容，并爬取和稍作加工，使得它们可被Elasticsearch检索到。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">本文将分享我们所学到的经验、如何调优Elasticsearch，以及要绕过的一些陷阱。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p><strong><span style="color:rgb(0,122,170);">数据量<br></span></strong></p>
   <hr style="border-style:solid;border-width:1px 0 0;border-color:rgba(0,0,0,.1);">
   <p><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">每天都有数量相当庞大的新闻和微博产生；在高峰期需要索引大约300多万社论文章，和近1亿条社交帖子数据。其中社论数据长期保存以供检索（可回溯到2009年），社交帖子数据保存近15个月的。当前的主分片数据使用了大约200 TB的磁盘空间，副本数据大约600 TB。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">我们的业务每分钟有3千次请求。所有的请求通过一个叫做“search-service”的服务，该服务会依次完成所有与Elasticsearch集群的交互。大部分检索规则比较复杂，包括在面板和新闻流中。比如，一个客户可能对Tesla和Elon Musk感兴趣，但希望排除所有关于SpaceX或PayPal的信息。用户可以使用一种与Lucene查询语法类似的灵活语法，如下：</span></p>
   <ul class="code-snippet__line-index code-snippet__js">
    <li></li>
   </ul>
   <pre class="code-snippet__js"><code><span class="code-snippet_outer">Tesla <span class="code-snippet__keyword">AND</span> <span class="code-snippet__string">"Elon Musk"</span> NOT (SpaceX <span class="code-snippet__keyword">OR</span> PayPal)</span></code></pre>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;"></span><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">我们最长的此类查询有60多页。重点是：除了每分钟3千次请求以外，没有一个查询是像在Google里查询“Barack Obama”这么简单的；这简直就是可怕的野兽，但ES节点必须努力找出一个匹配的文档集。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/4g5IMGibSxt4MGPACk84mvUwtWy1xia7wuXb9Aje158TbXum9I6G7o0Xa79rhKjpxDJzJ1dnGo8GgLJD5LRbDLFg/640?wx_fmt=png" alt="640?wx_fmt=png">
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p><strong><span style="color:rgb(0,122,170);font-size:16px;">版本</span></strong></p>
   <hr style="border-style:solid;border-width:1px 0 0;border-color:rgba(0,0,0,.1);">
   <p><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2px;text-align:left;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">我们运行的是一个基于Elasticsearch 1.7.6的定制版本。该版本与1.7.6 主干版本的唯一区别是，我们向后移植（backport）了roaring bitsets/bitmaps</span><span style="font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;color:rgb(136,136,136);font-size:12px;">（http://suo.im/5bE6od）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;"><span class="Apple-converted-space">&nbsp;</span>作为缓存。该功能是从Lucene 5移植到Lucene 4的，对应移植到了ES 1.X版本。Elasticsearch 1.X中使用默认的bitset作为缓存，对于稀疏结果来说开销非常大，不过在Elasticsearch 2.X中已经做了优化。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">为何不使用较新版本的Elasticsearch呢？主要原因是升级困难。在主版本间滚动升级只适用于从ES 5到6（从ES 2到5应该也支持滚动升级，但没有试过）。因此，我们只能通过重启整个集群来升级。宕机对我们来说几乎不可接受，但或许可以应对一次重启所带来的大约30-60分钟宕机时间；而真正令人担心的，是一旦发生故障并没有真正的回滚过程。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">截止目前我们选择了不升级集群。当然我们希望可以升级，但目前有更为紧迫的任务。实际上该如何实施升级尚未有定论，很可能选择创建另一个新的集群，而不是升级现有的。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;"><strong><span style="color:rgb(0,122,170);">节点配置<br></span></strong></p>
   <hr style="border-style:solid;border-width:1px 0 0;border-color:rgba(0,0,0,.1);">
   <p><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">我们自2017年6月开始在AWS上运行主集群，使用i3.2xlarge实例作为数据节点。之前我们在COLO（Co-located Data Center）里运行集群，但后续迁移到了AWS云，以便在新机器宕机时能赢得时间，使得我们在扩容和缩容时更加弹性。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">我们在不同的可用区运行3个候选master节点，并设置discovery.zen.minimum_master_nodes为2。这是避免脑裂问题</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2px;text-align:left;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">split-brain problem</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;color:rgb(136,136,136);font-size:12px;">（https://qbox.io/blog/split-brain-problem-elasticsearch）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">非常通用的策略。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">我们的数据集在存储方面，要求80%容量和3个以上的副本，这使得我们运行了430个数据节点。起初打算使用不同层级的数据，在较慢的磁盘上存储较旧的数据，但是由于我们只有相关的较低量级旧于15个月的数据（只有编辑数据，因为我们丢弃了旧的社交数据），然而这并未奏效。每个月的硬件开销远大于运行在COLO中，但是云服务支持扩容集群到2倍，而几乎不用花费多少时间。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">你可能会问，为何选择自己管理维护ES集群。其实我们考虑过托管方案，但最后还是选择自己安装，理由是：AWS Elasticsearch Service</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;color:rgb(136,136,136);font-size:12px;">（http://suo.im/4PLuXa）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">暴露给用户的可控性太差了，</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">Elastic Cloud</span><span style="font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;color:rgb(136,136,136);font-size:12px;">（https://www.elastic.co/cn/cloud）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">的成本比直接在EC2上运行集群要高2-3倍。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2px;text-align:left;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">为了在某个可用区宕机时保护我们自身，节点分散于eu-west-1的所有3个可用区。我们使用AWS plugin</span><span style="font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;color:rgb(136,136,136);font-size:12px;">（http://suo.im/5qFQEP）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">来完成该项配置。它提供了一个叫做aws_availability_zone的节点属性，我们把</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2px;text-align:left;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">cluster.routing.allocation.awareness.attributes</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2px;text-align:left;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">设置为aws_availability_zone。这保证了ES的副本尽可能地存储在不同的可用区，而查询尽可能被路由到相同可用区的节点。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">这些实例运行的是Amazon Linux，临时挂载为ext4，有约64GB的内存。我们分配了26GB用于ES节点的堆内存，剩下的用于磁盘缓存。为何是26GB？因为JVM是在一个黑魔法之上构建的</span><span style="font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;color:rgb(136,136,136);font-size:12px;">（https://www.elastic.co/blog/a-heap-of-trouble）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">我们同时使用Terraform</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;color:rgb(136,136,136);font-size:12px;">（https://www.terraform.io/）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">自动扩容组来提供实例，并使用Puppet</span><span style="font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;color:rgb(136,136,136);font-size:12px;">（https://puppet.com/）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">完成一切安装配置。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;"><br></span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><strong><span style="font-size:16px;font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;color:rgb(0,122,170);">索引结构</span></strong></p>
   <hr style="border-style:solid;border-width:1px 0 0;border-color:rgba(0,0,0,.1);">
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><strong><span style="font-size:16px;font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;color:rgb(0,122,170);"></span></strong></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">因为我们的数据和查询都是基于时间序列的，所以使用了</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">time-based indexing</span><span style="font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;color:rgb(136,136,136);font-size:12px;">（http://suo.im/547GbE）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">，</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">类似于ELK（elasticsearch、logstash、kibana） stack</span><span style="font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;color:rgb(136,136,136);font-size:12px;">（https://www.elastic.co/elk-stack）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">。同时也让不同类型的数据保存在不同的索引库中，以便诸如社论文档和社交文档类数据最终位于不同的每日索引库中。这样可以在需要的时候只丢弃社交索引，并增加一些查询优化。每个日索引运行在两个分片中的一个。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">该项设置产生了大量的分片（接近40k）。有了这么多的分片和节点，集群操作有时变得更特殊。比如，删除索引似乎成为集群master的能力瓶颈，它需要把集群状态信息推送给所有节点。我们的集群状态数据约100 MB，但通过TCP压缩可减少到3 MB</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">（可以通过</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;font-size:12px;">curl localhost:9200/_cluster/state/_all</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;"><span class="Apple-converted-space">&nbsp;</span>查看你自己集群的状态数据）。Master节点仍然需要在每次变更时推送1.3 GB数据（430 节点 x 3 MB 状态大小）。除了这1.3 GB数据外，还有约860 MB必须在可用区（比如 最基本的通过公共互联网）之间传输。这会比较耗时，尤其是在删除数百个索引时。我们希望新版本的Elasticsearch能优化这一点，首先从ES 2.0支持仅发送集群状态的差分数据</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;font-size:12px;">(http://suo.im/547UyM)</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">这一特性开始。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><strong><span style="color:rgb(0,122,170);font-size:16px;">ElasticSearch性能</span></strong></p>
   <hr style="border-style:solid;border-width:1px 0 0;border-color:rgba(0,0,0,.1);">
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">如前所述，我们的ES集群为了满足客户的检索需求，需要处理一些非常复杂的查询。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">为应对查询负载，过去几年我们在性能方面做了大量的工作。我们必须尝试公平分享ES集群的性能测试，从下列引文就可以看出。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <blockquote style="border-left-width:3px;border-left-style:solid;border-left-color:rgb(219,219,219);color:rgba(0,0,0,.498039);font-size:15px;font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;">
    <p style="clear:both;min-height:1em;"><span style="font-size:14px;color:rgb(136,136,136);">不幸的是，当集群宕机的时候，不到三分之一的查询能成功完成。我们相信测试本身导致了集群宕机。&nbsp;</span></p>
    <p style="clear:both;min-height:1em;"><span style="font-size:14px;color:rgb(136,136,136);">—— 摘录自使用真实查询在新ES集群平台上的第一次性能测试</span></p>
   </blockquote>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">为了控制查询执行过程，我们开发了一个插件，实现了一系列自定义查询类型。通过使用这些查询类型来提供Elasticsearch官方版本不支持的功能和性能优化。比如，我们实现了phrases中的wildcard查询，支持在SpanNear查询中执行；另一个优化是支持“*”代替match-all-query；还有其他一系列特性。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">Elasticsearch和Lucene的性能高度依赖于具体的查询和数据，没有银弹。即便如此，仍可给出一些从基础到进阶的参考：</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="font-size:14px;"><br></span></p>
   <ul class="list-paddingleft-2" style="list-style-type:disc;margin-left:0px;">
    <li><p style="clear:both;min-height:1em;"><strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">限制你的检索范围，仅涉及相关数据。</span></strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">比如，对于每日索引库，只按相关日期范围检索。对于检索范围中间的索引，避免使用范围查询/过滤器。</span></p></li>
    <li><p style="clear:both;min-height:1em;"><strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">使用wildcards时忽略前缀wildcards</span></strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;"><span class="Apple-converted-space">&nbsp;</span>- 除非你能对term建立倒排索引。双端wildcards难以优化。</span></p></li>
    <li><p style="clear:both;min-height:1em;"><strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">关注资源消耗的相关迹象</span></strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;"><span class="Apple-converted-space">，</span>数据节点的CPU占用持续飙高吗？IQ等待走高吗？看看GC统计。这些可以从profilers工具或者通过JMX代理获得。如果ParNewGC消耗了超过15%的时间，去检查下内存日志。如果有任何的SerialGC停顿，你可能真的遇到问题了。不太了解这些内容？</span></p><p style="clear:both;min-height:1em;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">没关系，这个系列博文很好地介绍了JVM性能</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;font-size:12px;">（http://suo.im/4AJgps）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;"><span style="font-family:'等线';font-size:14px;letter-spacing:.544px;text-align:justify;">&nbsp;</span>。</span></p><p style="clear:both;min-height:1em;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">记住，ES和G1垃圾回收器一起并非最佳</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;font-size:12px;">（http://suo.im/4WBTA5）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">。</span></p></li>
    <li><p style="clear:both;min-height:1em;"><strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">如果遇到垃圾回收问题，请不要尝试调整GC设置。</span></strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">这一点经常发生，因为默认设置已经很合理了。相反，应该聚焦在减少内存分配上。具体怎么做？参考下文。</span></p></li>
    <li><p style="clear:both;min-height:1em;"><strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">如果遇到内存问题，但没有时间解决，可考虑查询Azul Zing。</span></strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">这是一个很贵的产品，但仅仅使用它们的JVM就可以提升2倍的吞吐量。不过最终我们并没有使用它，因为我们无法证明物有所值。</span></p></li>
    <li><p style="clear:both;min-height:1em;"><strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">考虑使用缓存，包括Elasticsearch外缓存和Lucene级别的缓存。</span></strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">在Elasticsearch 1.X中可以通过使用filter来控制缓存。之后的版本中看起来更难一些，但貌似可以实现自己用于缓存的查询类型。我们在未来升级到2.X的时候可能会做类似的工作。</span></p></li>
    <li><p style="clear:both;min-height:1em;"><strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">查看是否有热点数据</span></strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">（比如某个节点承担了所有的负载）。可以尝试均衡负载，使用分片分配过滤策略</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;font-size:12px;">shard allocation filtering</span></p><p style="clear:both;min-height:1em;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;font-size:12px;">（http://suo.im/4IfruL）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">，或者尝试通过集群重新路由</span></p><p style="clear:both;min-height:1em;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;font-size:12px;">cluster rerouting（http://suo.im/5ja7cU）</span></p><p style="clear:both;min-height:1em;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">来自行迁移分片。我们已经使用线性优化自动重新路由，但使用简单的自动化策略也大有帮助。</span></p></li>
    <li><p style="clear:both;min-height:1em;"><strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">搭建测试环境</span></strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">（我更喜欢笔记本）<strong>可从线上环境加载一部分代表性的数据</strong>（建议至少有一个分片）。使用线上的查询回放加压（较难）。使用本地设置来测试请求的资源消耗。</span></p></li>
    <li><p style="clear:both;min-height:1em;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;"><span>综合以上各点，在</span><strong style="font-size:14px;">Elasticsearch进程上启用一个profiler。这是本列表中最重要的一条。</strong></span></p><p style="clear:both;min-height:1em;text-align:left;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;">我们同时通过</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;font-size:12px;">Java Mission Control<span style="letter-spacing:.544px;text-align:justify;font-family:'等线';">&nbsp;</span></span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;"><span style="font-size:12px;">（http://suo.im/4zYEsP）</span><span>和 VisualVM</span><span style="font-family:'等线';">&nbsp;</span><span style="font-size:12px;">（http://suo.im/4AJeIM）</span></span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">使用飞行记录器。在性能问题上尝试投机（包括付费顾问/技术支持）的人是在浪费他们（以及你自己）的时间。排查下JVM哪部分消耗了时间和内存，然后探索下Elasticsearch/Lucene源代码，检查是哪部分代码在执行或者分配内存。</span></p></li>
    <li><p style="clear:both;min-height:1em;"><strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">一旦搞清楚是请求的哪一部分导致了响应变慢，你就可以通过尝试修改请求来优化</span></strong><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">（比如，修改term聚合的执行提示</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;font-size:12px;">（http://suo.im/4WBUJx）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">，或者切换查询类型）。修改查询类型或者查询顺序，可以有较大影响。如果不凑效，还可以尝试优化ES/Lucene代码。这看起来太夸张，却可以为我们降低3到4倍的CPU消耗和4到8倍的内存使用。某些修改很细微（比如 indices query</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;text-align:justify;font-size:12px;">&nbsp;（http://suo.im/4WBUR7）</span><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">），但其他人可能要求我们完全重写查询执行。最终的代码严重依赖于我们的查询模式，所以可能适合也可能不适合他人使用。因此目前为止我们并没有开源这部分代码。不过这可能是下一篇博文的好素材。</span></p></li>
   </ul>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="font-size:14px;"><br></span></p>
   <img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/4g5IMGibSxt4MGPACk84mvUwtWy1xia7wu1H1v1DJWP7VsG73BibdzCE2sUSkNQr2Oib22FYftu4lteCZl9lFJGGPQ/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg">
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="font-size:14px;"><br></span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">图表说明：<strong>响应时间</strong>。有/没有 重写Lucene查询执行。同时也表明不再有节点每天多次发生内存不足。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">顺便说明下，因为我知道会面临一个问题：从上一次性能测试我们知道通过升级到ES 2.X能小幅提升性能，但是并不能改变什么。话虽如此，但如果你已经从ES 1.X集群迁移到了ES 2.X，我们很乐意听取关于你如何完成迁移的实践经验。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><br></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;letter-spacing:.544px;text-align:justify;">如果读到了这里，说明你对Elasticsearch是真爱啊（或者至少你是真的需要它）。我们很乐意学习你的经验，以及任何可以分享的内容。欢迎在评论区分享你的反馈和问题。</span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="font-size:14px;"><br></span></p>
   <p style="clear:both;min-height:1em;"><span style="font-size:12px;color:rgb(136,136,136);">作者：Anton Hägerstrand</span></p>
   <p><span style="font-size:12px;color:rgb(136,136,136);">翻译：杨振涛<br></span></p>
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;"><span style="font-size:14px;"></span><br></p>
   <p style="text-align:left;"><strong><span style="font-size:16px;color:rgb(0,122,170);">扩展阅读</span></strong></p>
   <hr style="border-style:solid;border-width:1px 0 0;border-color:rgba(0,0,0,.1);">
   <p style="text-align:left;"><strong><span style="font-size:16px;color:rgb(0,122,170);"><br></span></strong></p>
   <ol style="list-style-type:decimal;" class="list-paddingleft-2">
    <li><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650281555&amp;idx=2&amp;sn=d324dadbaba6811a4a19084c7ad5de08&amp;chksm=be478e4589300753609aed2bd1c3a0c039ac160612ff444010379b67e1bfb00479991b080a6f&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;" data-token="020f5b4853db709aef90150b13a619fe"><span style="font-size:15px;">Elasticsearch如何做到亿级数据查询毫秒级返回？</span></a></p></li>
    <li><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650278209&amp;idx=1&amp;sn=1f0ab49778079709d6098296bec10413&amp;chksm=be47915789301841abe06973efb0beb59614b5f606690cb5ced696ee8f122fdfdbe247ffcb81&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;" data-token="170e0a567e4979a17c9855e7b2f2d69b"><span style="font-size:15px;">从 Elasticsearch 来看分布式系统架构设计</span></a></p></li>
    <li><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650281507&amp;idx=1&amp;sn=696c1ab80ddb06b9b5a79f2211110cb7&amp;chksm=be478e3589300723f50f1fa04d89c2f06accaa49bda60759eee89e24d4230e5b3d97bd433cf7&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;" data-token="6bfa454d465d24e4e04da55ed822ca2d"><span style="font-size:15px;">超详细的Elasticsearch高性能优化实践</span></a></p></li>
    <li><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650281371&amp;idx=2&amp;sn=9f62a9f2d639a6ca4e51f39037d5e386&amp;chksm=be478d8d8930049b7b5f5593acdaeeb29908f287596b1702a6b9ed5514be79dfed800c6be4cb&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;" data-token="7d28f912cca957408b7dfcbca74b2412"><span style="font-size:15px;">MySQL从零到一解读增量同步数据到elasticsearch canal adapter方式(binlog)实现</span></a></p></li>
    <li><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650281239&amp;idx=1&amp;sn=5a6d0c929af968c2d5b35fc6d7574c9a&amp;chksm=be478d018930041779e26c549805eff203146c9a94a9806f95c6e619eebb134151eb394e47f1&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;" data-token="07a40646106c48910f1a3a7b979a22a3"><span style="font-size:15px;">墙裂推荐 | 漫画解读Elasticsearch原理，看完你就懂</span></a></p></li>
    <li><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650280665&amp;idx=1&amp;sn=2191096f914610e340c26e86aa91e8bc&amp;chksm=be478acf893003d93f7d28880d92a3470ba3b26e3f7654fe5f76c14640535d8b182aff337d7a&amp;scene=21#wechat_redirect" rel="nofollow" style="font-size:15px;text-decoration:underline;" data-token="368757703f13f664d727557bb00d87e4"><span style="font-size:15px;">有多少漏洞都会重来:从ElasticSearch到MongoDB和Redis</span></a><br></p></li>
   </ol>
   <p style="text-align:center;"><br></p>
   <img style="width:190px;margin-left:auto;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWgrROticJ29kqjZicMFskI3WfZxbRorYgxoNEHwGiaMll7WyzNia5Q1tSARXL2ajJ8nt36dGNZ2BMgaOw/640?wx_fmt=png" alt="640?wx_fmt=png">
   <p style="text-align:center;"><strong><span style="font-size:15px;">数据和云</span></strong></p>
   <p style="text-align:center;"><strong><span style="font-size:15px;">ID：OraNews</span></strong></p>
   <p style="text-align:center;"><strong><span style="font-size:15px;">如有收获，请划至底部，点击“<span style="font-size:15px;color:#007aaa;">在看</span>”，谢谢！</span></strong></p>
   <p style="text-align:center;line-height:normal;"><strong><span style="font-size:15px;"><br></span></strong></p>
   <p style="text-align:center;line-height:normal;"><br></p>
   <p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650606539&amp;idx=1&amp;sn=134dafd5fb9ce3db71e76effd0d84397&amp;chksm=be95a0b589e229a375484ab05507d1c3af138956d41fdd3b12c383b4d0f6da98eae300d9a8da&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:12px;" data-token="c70a8a74afae58126c30cc4128f3b42d">公司简介</a><span style="font-size:12px;">&nbsp;&nbsp;|&nbsp;</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650606795&amp;idx=2&amp;sn=bb9544642faa52b4835718eb8479032e&amp;chksm=be95a7b589e22ea3f22adce976e4c0a3da68754c1132e79cb06ea1c97276863af36c5ab6bfde&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:12px;" data-token="603a32e64c9b6c1c6dc301288cbf98d0">招聘</a><span style="font-size:12px;">&nbsp;|&nbsp;</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650605815&amp;idx=1&amp;sn=96f5e15c7d1f7e1ae1e314dbe02b43b2&amp;chksm=be95a38989e22a9fb5ac4329a1cf0beb14878f0b2e6fc8ea3ed7bb0daebbb601acd84bacd2ef&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;" data-token="866f1c18070c44bb6a8a624fc3b6144f"><span style="font-size:12px;">DTCC</span></a><span style="font-size:12px;">&nbsp;|<span>&nbsp;</span></span><span style="font-size:12px;text-decoration:underline;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650606300&amp;idx=1&amp;sn=2bed577bbd2785ed15ed6fa30d0bf5b8&amp;chksm=be95a1a289e228b4558498e0c28389e864858d1be334204365c10c2bbdc7ac1d68747cbca542&amp;scene=21#wechat_redirect" rel="nofollow" data-token="069ac0860dbfd32554b923538d29217d">数据技术嘉年华</a></span><span style="font-size:12px;">&nbsp;|&nbsp;</span><span style="font-size:12px;text-decoration:underline;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650281343&amp;idx=1&amp;sn=668e2c93f551141a416eb16f3eade76f&amp;chksm=be478d698930047f0fb674ef05a7cbaff4e5f3991d0e0b998f37c06ca1eafc44b6c30ecfb6c8&amp;scene=21#wechat_redirect" rel="nofollow" data-token="9da6e3f2e75e844c6e82df25fe306ad8">免费课程</a></span><span style="font-size:12px;">&nbsp;|&nbsp;</span><span style="font-size:12px;text-decoration:underline;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650606949&amp;idx=1&amp;sn=f63ecdd4a5b21ef1104b4626ba29350b&amp;chksm=be95a61b89e22f0da76d3b7005cddf376405df2e91ff9fb9ebfc091b2de72d6901813f819332&amp;scene=21#wechat_redirect" rel="nofollow" data-token="9a60af2835a4a4eddce72bdbd3b5189c">入驻华为严选商城</a></span></p>&nbsp;&nbsp;
   <img style="width:60px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/hUPnvEAd0LUUBAJOlz8CcqEOPa1ldXU3ibRAFVNDK5LeF9aC9xY7qztxG3VyROib1QrADiabUWPVlslTN2fdGDuPQ/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg">
   <p style="text-align:left;"><a href="https://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650606558&amp;idx=1&amp;sn=d727f762e155ba9eebf0301a49b3815d&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:12px;" data-token="255baa50c95952f4b5f02838ad12ded4">zCloud</a><span style="font-size:12px;">&nbsp;|&nbsp;</span><span style="font-size:12px;text-decoration:underline;"><a href="https://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650606400&amp;idx=1&amp;sn=fda7dfd82768bbd8f890a0ab9250b9e6&amp;scene=21#wechat_redirect" rel="nofollow" data-token="bdd056e9299b257b69ca412fd0a725ed">SQM</a></span><span style="font-size:12px;">&nbsp;|&nbsp;</span><a href="https://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650606558&amp;idx=2&amp;sn=06ca69294cebd30f5f710a322fb98b2c&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:12px;" data-token="5034e3f2e75b712290221f6eec096b4b">Bethune Pro2</a>&nbsp;<span style="font-size:12px;">|&nbsp;</span><a href="https://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650606577&amp;idx=1&amp;sn=30025f8250b8c50663d3a591fe3de257&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:12px;" data-token="f33124592958b9285e72bd8c00976341">zData一体机</a><span style="font-size:12px;">&nbsp;|&nbsp;</span><a href="https://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650606261&amp;idx=1&amp;sn=15ab8b32d85c885427c355f95026029d&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:12px;" data-token="7be9ca805a77c5b4197bd7e29a434fae">MyData一体机</a>&nbsp;|&nbsp;<a href="https://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650606518&amp;idx=1&amp;sn=00f2f4a54a37cbc7d1e6fb517b529859&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:12px;" data-token="ef6c901226a94b814ea5dfe9bbc8c853">ZDBM 备份一体机</a></p>
   <img style="width:52px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/hUPnvEAd0LUUBAJOlz8CcqEOPa1ldXU3mTOEfnaMaBWJPOOXcozJEKWtutDLicX9YMNhgzycyxNHUdqeuAjUyvA/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg">
   <p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650281215&amp;idx=1&amp;sn=30d52b07763b6d7ba4cb15b79de29564&amp;chksm=be478ce9893005ff93809c1d88eda7066b98f560001b5b324be4a8e9ebc10bcafce2267c619d&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:12px;" data-token="be12bdaf55ca61b4b57ab047ecfdddc8">Oracle技术架构</a><span style="font-size:12px;">&nbsp;|&nbsp;</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650281343&amp;idx=1&amp;sn=668e2c93f551141a416eb16f3eade76f&amp;chksm=be478d698930047f0fb674ef05a7cbaff4e5f3991d0e0b998f37c06ca1eafc44b6c30ecfb6c8&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:12px;" data-token="9da6e3f2e75e844c6e82df25fe306ad8">免费课程</a><span style="font-size:12px;">&nbsp;|&nbsp;</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650281350&amp;idx=1&amp;sn=26b13e3f181a5d6e831c021b7426e6c4&amp;chksm=be478d9089300486d05476098e1b3cfee5b2eb94365cf614e24d21d1eb58451e6ed16c601d00&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:12px;" data-token="38668be4b00eca2b58c4e2b222a17783">数据库排行榜</a><span style="font-size:12px;">&nbsp;|&nbsp;</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650281239&amp;idx=2&amp;sn=e72ce90ab0bd2e8375b709644c7f8b54&amp;chksm=be478d01893004170db34db767a38b234606e9dd0eaca08a35c313fa474263bcf23871bebe46&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:12px;" data-token="94342897ba181385fc0ec36858af7cda">DBASK问题集萃</a><span style="font-size:12px;">&nbsp;|&nbsp;</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650281286&amp;idx=1&amp;sn=48099b54f34f91687ccbf7afec9e7c65&amp;chksm=be478d50893004463678b48c0eb73f5741f06a6b1bea5502517f9801b0bde84e50c20502811d&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:12px;" data-token="75dd957adee90bb09f244efc328f8a51">技术通讯</a><span style="font-size:12px;">&nbsp;</span></p>
   <img style="width:60px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/hUPnvEAd0LUUBAJOlz8CcqEOPa1ldXU30DVZ9aCJfsArKCAhqbDR3AT9icAzDHeWPvRl8R6NnskotytVDGuiaXuQ/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg">
   <p><span style="font-size:12px;text-decoration:underline;"><a href="https://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650605932&amp;idx=1&amp;sn=429bc42915a11a929d8e8d98fa94d627&amp;scene=21#wechat_redirect" rel="nofollow" data-token="35592e6e22ca982bd91b565a62bd4176">升级迁移</a></span><span style="font-size:12px;">&nbsp;|&nbsp;</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650606850&amp;idx=1&amp;sn=cc081d93c4a267fcc3b1a99792ec22c9&amp;chksm=be95a67c89e22f6a113affd2d918d82f8139b638ec9a4b5201d0ee030033fd969a49a3b2f4f3&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;" data-token="f0da1990479a174a118c227b88fa0806"><span style="font-size:12px;">性能优化</span></a><span style="font-size:12px;">&nbsp;|&nbsp;</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650605700&amp;idx=1&amp;sn=051812f07add697e78e3f3e7a82564e5&amp;chksm=be95a3fa89e22aecb2c4bdb22b303a77e5c4b19e8ff6de2c62624e1161b8ebd4396b28940ddc&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;" data-token="6ec9bad4b53e4135126dfe3431e0b442"><span style="font-size:12px;">智能整合</span></a><span style="font-size:12px;text-decoration:underline;">&nbsp;</span><span style="font-size:12px;">|&nbsp;</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650603337&amp;idx=2&amp;sn=1aa0d1664bb04d8f9dd9c22e60887ba2&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;" data-token="e0c1f1ac2d81eb7631082ed18a1cfd37"><span style="font-size:12px;">安全保障</span></a><span style="font-size:12px;">&nbsp;|&nbsp;<span style="font-family:'微软雅黑';font-size:12px;letter-spacing:1px;line-height:26.25px;">&nbsp;</span><span style="font-family:'微软雅黑';font-size:12px;letter-spacing:1px;line-height:26.25px;text-decoration:underline;"><a href="https://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650605243&amp;idx=1&amp;sn=83d34ae3e3b33ad55dad215665556dde&amp;scene=21#wechat_redirect" rel="nofollow" data-token="ca5e11eee0aea1b518a0b04c9b75227c">架构设计</a></span><span style="font-family:'微软雅黑';font-size:12px;letter-spacing:1px;line-height:26.25px;">&nbsp;|&nbsp;</span><span style="font-family:'微软雅黑';font-size:12px;letter-spacing:1px;line-height:26.25px;text-decoration:underline;"><a href="https://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=401725923&amp;idx=1&amp;sn=b5c396e5563e0836c9fd40a481ac42db&amp;scene=21#wechat_redirect" rel="nofollow" data-token="8739943819b66ef56d9f6a0ad65b9c8a">SQL审核</a></span><span style="font-family:'微软雅黑';font-size:12px;letter-spacing:1px;line-height:26.25px;">&nbsp;|&nbsp;</span><span style="font-family:'微软雅黑';font-size:12px;letter-spacing:1px;line-height:26.25px;text-decoration:underline;"><a href="https://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650274082&amp;idx=2&amp;sn=729a68af1b7f0266683da44cfd227e32&amp;scene=21#wechat_redirect" rel="nofollow" data-token="d22d555dc53479c912fdad647c833381">分布式架构</a></span><span style="font-family:'微软雅黑';font-size:12px;letter-spacing:1px;line-height:26.25px;">&nbsp;|&nbsp;</span><span style="font-family:'微软雅黑';font-size:12px;letter-spacing:1px;line-height:26.25px;text-decoration:underline;"><a href="https://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650606414&amp;idx=1&amp;sn=e952cc631c64da59b204ed513425eea0&amp;scene=21#wechat_redirect" rel="nofollow" data-token="4b901d252999c4edd5ff14517ce3f5f6">高可用容灾</a></span><span style="font-family:'微软雅黑';font-size:12px;letter-spacing:1px;line-height:26.25px;">&nbsp;|&nbsp;</span><span style="font-family:'微软雅黑';font-size:12px;letter-spacing:1px;line-height:26.25px;text-decoration:underline;"><a href="https://mp.weixin.qq.com/s?__biz=MjM5MzExMTU2OQ==&amp;mid=2650603030&amp;idx=1&amp;sn=726b20fde867db768585fe605cbc5fe2&amp;scene=21#wechat_redirect" rel="nofollow" data-token="ac858a18a171b8197bc90fdd4cd61f74">运维代维</a></span></span><br></p>
   <p><strong><span style="font-size:16px;color:rgb(141,203,191);">云和恩墨大讲堂 |&nbsp;</span></strong><span style="font-size:16px;color:rgb(141,203,191);">一个分享交流的地方</span></p>
   <p style="min-height:1em;"><span style="font-size:14px;color:rgb(141,203,191);">长按，识别二维码，加入<strong>万人</strong>交流社群</span></p>
   <p style="min-height:1em;"><br></p>
   <strong><img style="border-width:1px;border-style:dashed;border-color:rgb(168,164,171);" border="0" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/bURPjgFpGMSLia51VIoGv8GNktatN3DiamicGBJkEXibzoGaI0WFTwcD5MT8kzcUlaL1zUEXhewkEHIhRKRTLDq3mw/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"></strong>
   <p style="color:rgb(35,21,10);font-size:medium;min-height:1em;"><span style="font-size:12px;"><strong><span style="color:rgb(141,203,191);">请备注：云和恩墨大讲堂</span></strong></span></p>
  </div> 
 </div> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d293c49e1e4bfe8f276695a5aa953300";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
