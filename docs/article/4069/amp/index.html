<!DOCTYPE html>
<html amp lang="en-US" i-amphtml-layout="" i-amphtml-no-boilerplate="" transformed="self;v=1">
<head><meta charset="utf-8"><style amp-runtime="" i-amphtml-version="012111242025001">html{overflow-x:hidden!important}html.i-amphtml-fie{height:100%!important;width:100%!important}html:not([amp4ads]),html:not([amp4ads]) body{height:auto!important}html:not([amp4ads]) body{margin:0!important}body{-webkit-text-size-adjust:100%;-moz-text-size-adjust:100%;-ms-text-size-adjust:100%;text-size-adjust:100%}html.i-amphtml-singledoc.i-amphtml-embedded{-ms-touch-action:pan-y pinch-zoom;touch-action:pan-y pinch-zoom}html.i-amphtml-fie>body,html.i-amphtml-singledoc>body{overflow:visible!important}html.i-amphtml-fie:not(.i-amphtml-inabox)>body,html.i-amphtml-singledoc:not(.i-amphtml-inabox)>body{position:relative!important}html.i-amphtml-ios-embed-legacy>body{overflow-x:hidden!important;overflow-y:auto!important;position:absolute!important}html.i-amphtml-ios-embed{overflow-y:auto!important;position:static}#i-amphtml-wrapper{overflow-x:hidden!important;overflow-y:auto!important;position:absolute!important;top:0!important;left:0!important;right:0!important;bottom:0!important;margin:0!important;display:block!important}html.i-amphtml-ios-embed.i-amphtml-ios-overscroll,html.i-amphtml-ios-embed.i-amphtml-ios-overscroll>#i-amphtml-wrapper{-webkit-overflow-scrolling:touch!important}#i-amphtml-wrapper>body{position:relative!important;border-top:1px solid transparent!important}#i-amphtml-wrapper+body{visibility:visible}#i-amphtml-wrapper+body .i-amphtml-lightbox-element,#i-amphtml-wrapper+body[i-amphtml-lightbox]{visibility:hidden}#i-amphtml-wrapper+body[i-amphtml-lightbox] .i-amphtml-lightbox-element{visibility:visible}#i-amphtml-wrapper.i-amphtml-scroll-disabled,.i-amphtml-scroll-disabled{overflow-x:hidden!important;overflow-y:hidden!important}amp-instagram{padding:54px 0px 0px!important;background-color:#fff}amp-iframe iframe{box-sizing:border-box!important}[amp-access][amp-access-hide]{display:none}[subscriptions-dialog],body:not(.i-amphtml-subs-ready) [subscriptions-action],body:not(.i-amphtml-subs-ready) [subscriptions-section]{display:none!important}amp-experiment,amp-live-list>[update]{display:none}amp-list[resizable-children]>.i-amphtml-loading-container.amp-hidden{display:none!important}amp-list [fetch-error],amp-list[load-more] [load-more-button],amp-list[load-more] [load-more-end],amp-list[load-more] [load-more-failed],amp-list[load-more] [load-more-loading]{display:none}amp-list[diffable] div[role=list]{display:block}amp-story-page,amp-story[standalone]{min-height:1px!important;display:block!important;height:100%!important;margin:0!important;padding:0!important;overflow:hidden!important;width:100%!important}amp-story[standalone]{background-color:#000!important;position:relative!important}amp-story-page{background-color:#757575}amp-story .amp-active>div,amp-story .i-amphtml-loader-background{display:none!important}amp-story-page:not(:first-of-type):not([distance]):not([active]){transform:translateY(1000vh)!important}amp-autocomplete{position:relative!important;display:inline-block!important}amp-autocomplete>input,amp-autocomplete>textarea{padding:0.5rem;border:1px solid rgba(0,0,0,0.33)}.i-amphtml-autocomplete-results,amp-autocomplete>input,amp-autocomplete>textarea{font-size:1rem;line-height:1.5rem}[amp-fx^=fly-in]{visibility:hidden}amp-script[nodom],amp-script[sandboxed]{position:fixed!important;top:0!important;width:1px!important;height:1px!important;overflow:hidden!important;visibility:hidden}
/*# sourceURL=/css/ampdoc.css*/[hidden]{display:none!important}.i-amphtml-element{display:inline-block}.i-amphtml-blurry-placeholder{transition:opacity 0.3s cubic-bezier(0.0,0.0,0.2,1)!important;pointer-events:none}[layout=nodisplay]:not(.i-amphtml-element){display:none!important}.i-amphtml-layout-fixed,[layout=fixed][width][height]:not(.i-amphtml-layout-fixed){display:inline-block;position:relative}.i-amphtml-layout-responsive,[layout=responsive][width][height]:not(.i-amphtml-layout-responsive),[width][height][heights]:not([layout]):not(.i-amphtml-layout-responsive),[width][height][sizes]:not(img):not([layout]):not(.i-amphtml-layout-responsive){display:block;position:relative}.i-amphtml-layout-intrinsic,[layout=intrinsic][width][height]:not(.i-amphtml-layout-intrinsic){display:inline-block;position:relative;max-width:100%}.i-amphtml-layout-intrinsic .i-amphtml-sizer{max-width:100%}.i-amphtml-intrinsic-sizer{max-width:100%;display:block!important}.i-amphtml-layout-container,.i-amphtml-layout-fixed-height,[layout=container],[layout=fixed-height][height]:not(.i-amphtml-layout-fixed-height){display:block;position:relative}.i-amphtml-layout-fill,.i-amphtml-layout-fill.i-amphtml-notbuilt,[layout=fill]:not(.i-amphtml-layout-fill),body noscript>*{display:block;overflow:hidden!important;position:absolute;top:0;left:0;bottom:0;right:0}body noscript>*{position:absolute!important;width:100%;height:100%;z-index:2}body noscript{display:inline!important}.i-amphtml-layout-flex-item,[layout=flex-item]:not(.i-amphtml-layout-flex-item){display:block;position:relative;-ms-flex:1 1 auto;flex:1 1 auto}.i-amphtml-layout-fluid{position:relative}.i-amphtml-layout-size-defined{overflow:hidden!important}.i-amphtml-layout-awaiting-size{position:absolute!important;top:auto!important;bottom:auto!important}i-amphtml-sizer{display:block!important}@supports (aspect-ratio:1/1){i-amphtml-sizer.i-amphtml-disable-ar{display:none!important}}.i-amphtml-blurry-placeholder,.i-amphtml-fill-content{display:block;height:0;max-height:100%;max-width:100%;min-height:100%;min-width:100%;width:0;margin:auto}.i-amphtml-layout-size-defined .i-amphtml-fill-content{position:absolute;top:0;left:0;bottom:0;right:0}.i-amphtml-replaced-content,.i-amphtml-screen-reader{padding:0!important;border:none!important}.i-amphtml-screen-reader{position:fixed!important;top:0px!important;left:0px!important;width:4px!important;height:4px!important;opacity:0!important;overflow:hidden!important;margin:0!important;display:block!important;visibility:visible!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:8px!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:12px!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:16px!important}.i-amphtml-unresolved{position:relative;overflow:hidden!important}.i-amphtml-select-disabled{-webkit-user-select:none!important;-ms-user-select:none!important;user-select:none!important}.i-amphtml-notbuilt,[layout]:not(.i-amphtml-element),[width][height][heights]:not([layout]):not(.i-amphtml-element),[width][height][sizes]:not(img):not([layout]):not(.i-amphtml-element){position:relative;overflow:hidden!important;color:transparent!important}.i-amphtml-notbuilt:not(.i-amphtml-layout-container)>*,[layout]:not([layout=container]):not(.i-amphtml-element)>*,[width][height][heights]:not([layout]):not(.i-amphtml-element)>*,[width][height][sizes]:not([layout]):not(.i-amphtml-element)>*{display:none}amp-img:not(.i-amphtml-element)[i-amphtml-ssr]>img.i-amphtml-fill-content{display:block}.i-amphtml-notbuilt:not(.i-amphtml-layout-container),[layout]:not([layout=container]):not(.i-amphtml-element),[width][height][heights]:not([layout]):not(.i-amphtml-element),[width][height][sizes]:not(img):not([layout]):not(.i-amphtml-element){color:transparent!important;line-height:0!important}.i-amphtml-ghost{visibility:hidden!important}.i-amphtml-element>[placeholder],[layout]:not(.i-amphtml-element)>[placeholder],[width][height][heights]:not([layout]):not(.i-amphtml-element)>[placeholder],[width][height][sizes]:not([layout]):not(.i-amphtml-element)>[placeholder]{display:block;line-height:normal}.i-amphtml-element>[placeholder].amp-hidden,.i-amphtml-element>[placeholder].hidden{visibility:hidden}.i-amphtml-element:not(.amp-notsupported)>[fallback],.i-amphtml-layout-container>[placeholder].amp-hidden,.i-amphtml-layout-container>[placeholder].hidden{display:none}.i-amphtml-layout-size-defined>[fallback],.i-amphtml-layout-size-defined>[placeholder]{position:absolute!important;top:0!important;left:0!important;right:0!important;bottom:0!important;z-index:1}amp-img[i-amphtml-ssr]:not(.i-amphtml-element)>[placeholder]{z-index:auto}.i-amphtml-notbuilt>[placeholder]{display:block!important}.i-amphtml-hidden-by-media-query{display:none!important}.i-amphtml-element-error{background:red!important;color:#fff!important;position:relative!important}.i-amphtml-element-error:before{content:attr(error-message)}i-amp-scroll-container,i-amphtml-scroll-container{position:absolute;top:0;left:0;right:0;bottom:0;display:block}i-amp-scroll-container.amp-active,i-amphtml-scroll-container.amp-active{overflow:auto;-webkit-overflow-scrolling:touch}.i-amphtml-loading-container{display:block!important;pointer-events:none;z-index:1}.i-amphtml-notbuilt>.i-amphtml-loading-container{display:block!important}.i-amphtml-loading-container.amp-hidden{visibility:hidden}.i-amphtml-element>[overflow]{cursor:pointer;position:relative;z-index:2;visibility:hidden;display:initial;line-height:normal}.i-amphtml-layout-size-defined>[overflow]{position:absolute}.i-amphtml-element>[overflow].amp-visible{visibility:visible}template{display:none!important}.amp-border-box,.amp-border-box *,.amp-border-box :after,.amp-border-box :before{box-sizing:border-box}amp-pixel{display:none!important}amp-analytics,amp-auto-ads,amp-story-auto-ads{position:fixed!important;top:0!important;width:1px!important;height:1px!important;overflow:hidden!important;visibility:hidden}html.i-amphtml-fie>amp-analytics{position:initial!important}[visible-when-invalid]:not(.visible),form [submit-error],form [submit-success],form [submitting]{display:none}amp-accordion{display:block!important}@media (min-width:1px){:where(amp-accordion>section)>:first-child{margin:0;background-color:#efefef;padding-right:20px;border:1px solid #dfdfdf}:where(amp-accordion>section)>:last-child{margin:0}}amp-accordion>section{float:none!important}amp-accordion>section>*{float:none!important;display:block!important;overflow:hidden!important;position:relative!important}amp-accordion,amp-accordion>section{margin:0}amp-accordion:not(.i-amphtml-built)>section>:last-child{display:none!important}amp-accordion:not(.i-amphtml-built)>section[expanded]>:last-child{display:block!important}
/*# sourceURL=/css/ampshared.css*/</style><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1"><title>学习 koa 源码的整体架构，浅析koa洋葱模型原理和co原理 - 有组织在!</title><link rel="preconnect" href="https://cdn.ampproject.org"><link rel="preload" as="script" href="https://cdn.ampproject.org/v0.js"><script async="" src="https://cdn.ampproject.org/v0.js"></script><style amp-custom="">.amp-wp-enforced-sizes{max-width:100%;margin:0 auto}amp-img.amp-wp-enforced-sizes[layout="intrinsic"] > img{object-fit:contain}html{background:#0a89c0}body{background:#fff;color:#353535;font-family:Georgia,"Times New Roman",Times,Serif;font-weight:300;line-height:1.75em}p,ol,ul{margin:0 0 1em;padding:0}a,a:visited{color:#0a89c0}a:hover,a:active,a:focus{color:#353535}blockquote{color:#353535;background:rgba(127,127,127,.125);border-left:2px solid #0a89c0;margin:8px 0 24px 0;padding:16px}blockquote p:last-child{margin-bottom:0}.amp-wp-meta,.amp-wp-header div,.amp-wp-title,.amp-wp-tax-category,.amp-wp-footer p,.back-to-top{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen-Sans","Ubuntu","Cantarell","Helvetica Neue",sans-serif}.amp-wp-header{background-color:#0a89c0}.amp-wp-header div{color:#fff;font-size:1em;font-weight:400;margin:0 auto;max-width:calc(840px - 32px);padding:.875em 16px;position:relative}.amp-wp-header a{color:#fff;text-decoration:none}.amp-wp-header .amp-wp-site-icon{background-color:#fff;border:1px solid #fff;border-radius:50%;position:absolute;right:18px;top:10px}.amp-wp-article{color:#353535;font-weight:400;margin:1.5em auto;max-width:840px;overflow-wrap:break-word;word-wrap:break-word}.amp-wp-article-header{align-items:center;align-content:stretch;display:flex;flex-wrap:wrap;justify-content:space-between;margin:1.5em 16px 0}.amp-wp-title{color:#353535;display:block;flex:1 0 100%;font-weight:900;margin:0 0 .625em;width:100%}.amp-wp-meta{color:#696969;display:inline-block;flex:2 1 50%;font-size:.875em;line-height:1.5em;margin:0 0 1.5em;padding:0}.amp-wp-article-header .amp-wp-meta:last-of-type{text-align:right}.amp-wp-article-header .amp-wp-meta:first-of-type{text-align:left}.amp-wp-byline amp-img,.amp-wp-byline .amp-wp-author{display:inline-block;vertical-align:middle}.amp-wp-byline amp-img{border:1px solid #0a89c0;border-radius:50%;position:relative;margin-right:6px}.amp-wp-posted-on{text-align:right}.amp-wp-article-content{margin:0 16px}.amp-wp-article-content ul,.amp-wp-article-content ol{margin-left:1em}.amp-wp-article-content amp-img{margin:0 auto}.amp-wp-article-footer .amp-wp-meta{display:block}.amp-wp-tax-category{color:#696969;font-size:.875em;line-height:1.5em;margin:1.5em 16px}.amp-wp-footer{border-top:1px solid #c2c2c2;margin:calc(1.5em - 1px) 0 0}.amp-wp-footer div{margin:0 auto;max-width:calc(840px - 32px);padding:1.25em 16px 1.25em;position:relative}.amp-wp-footer h2{font-size:1em;line-height:1.375em;margin:0 0 .5em}.amp-wp-footer p{color:#696969;font-size:.8em;line-height:1.5em;margin:0 85px 0 0}.amp-wp-footer a{text-decoration:none}.back-to-top{bottom:1.275em;font-size:.8em;font-weight:600;line-height:2em;position:absolute;right:16px}.htmledit_views em,.htmledit_views span[lang]{font-style:italic}.htmledit_views{font-family:-apple-system,SF UI Text,Arial,PingFang SC,Hiragino Sans GB,Microsoft YaHei,WenQuanYi Micro Hei,sans-serif,SimHei,SimSun}.htmledit_views a>amp-img{padding:1px;margin:1px;border:none;outline:#0782c1 solid 1px}.htmledit_views p{font-size:16px;color:#4d4d4d;font-weight:400;line-height:26px;margin:0 0 16px;overflow-x:auto}.htmledit_views amp-img{max-width:100%;height:auto}.htmledit_views strong,.htmledit_views strong span{font-weight:700}.htmledit_views *{box-sizing:border-box}.htmledit_views h1,.htmledit_views h2,.htmledit_views h3{color:#4f4f4f;margin:8px 0 16px;font-weight:700}.htmledit_views ol,.htmledit_views ul{margin:0 0 24px;padding:0;font-size:16px}.htmledit_views ul ol{margin:0 0 24px 32px}.htmledit_views ul li{list-style-type:disc;margin:8px 0 0 32px}.htmledit_views ol li{list-style-type:decimal;margin-left:40px;margin-top:8px}.htmledit_views h1{font-size:28px;line-height:36px}.htmledit_views h2{font-size:24px;line-height:32px}.htmledit_views h3{font-size:22px;line-height:30px}.htmledit_views blockquote{display:block;padding:16px 16px 0;margin:0 0 24px;border-left:8px solid #dddfe4;background:#eef0f4;overflow:auto;overflow-scrolling:touch;word-wrap:normal;word-break:normal}.htmledit_views blockquote ol,.htmledit_views blockquote ul{margin-bottom:16px;padding:0;font-size:16px;line-height:24px}.htmledit_views blockquote ol li,.htmledit_views blockquote ul li{margin-bottom:0}.htmledit_views blockquote p{font-size:16px;line-height:26px;font-weight:400;margin-bottom:16px;color:#4f4f4f}.htmledit_views pre{white-space:pre-wrap;word-wrap:break-word;margin:0 0 24px;overflow-x:auto;padding:8px}.htmledit_views pre{font-family:Consolas,Inconsolata,Courier,monospace;font-size:14px;line-height:22px;color:#000}.htmledit_views pre code,.htmledit_views pre code div,.htmledit_views pre code span{font-family:"Source Code Pro","DejaVu Sans Mono","Ubuntu Mono","Anonymous Pro","Droid Sans Mono",Menlo,Monaco,Consolas,Inconsolata,Courier,monospace,"PingFang SC","Microsoft YaHei",sans-serif}.htmledit_views code{border-radius:4px}.htmledit_views a{color:#4ea1db;text-decoration:none}.htmledit_views a:focus,.htmledit_views a:hover{color:#ca0c16}.htmledit_views a:visited{color:#6795b5}.htmledit_views pre code{display:block;line-height:22px;overflow-x:auto;white-space:pre;word-wrap:normal;border-radius:4px;padding:8px}.htmledit_views pre code:not(.hljs){background-color:#f3f4f5}.htmledit_views pre code,.htmledit_views pre code div,.htmledit_views pre code span{font-size:14px}.htmledit_views code ol{margin:0;overflow:hidden}.htmledit_views code ol li{list-style-type:none;margin-left:0;margin-top:0;height:22px}.htmledit_views pre[data-from=code-for-outside]{overflow:hidden}.htmledit_views pre[data-from=code-for-outside] code{overflow-x:auto;overflow-y:hidden}.htmledit_views pre[data-from=code-for-outside] code *{overflow:visible;overflow-wrap:break-word}.htmledit_views pre[data-from=code-for-outside] p code{padding:0}:root:not(#_):not(#_):not(#_):not(#_):not(#_) .amp-wp-6599cf4{text-align:left}:root:not(#_):not(#_):not(#_):not(#_):not(#_) .amp-wp-7023da7{text-align:center}

/*# sourceURL=amp-custom.css */</style><script type="application/ld+json" class="yoast-schema-graph yoast-schema-graph--main">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://uzzz.org/#website","url":"https://uzzz.org/","name":"\u6709\u7ec4\u7ec7\u5728!","potentialAction":{"@type":"SearchAction","target":"https://uzzz.org/?s={search_term_string}","query-input":"required name=search_term_string"}},{"@type":"ImageObject","@id":"https://uzzz.org/article/4069/#primaryimage","url":"https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3lkTzZSU2daNVdaQldvS2ljaWE2d0ZCaktlOXUwSm40MlRUV2liWDhDc2ljSFBueUV3OW5hZTJUd01RLzY0MA?x-oss-process=image/format,png"},{"@type":"WebPage","@id":"https://uzzz.org/article/4069/#webpage","url":"https://uzzz.org/article/4069/","inLanguage":"en-US","name":"\u5b66\u4e60 koa \u6e90\u7801\u7684\u6574\u4f53\u67b6\u6784\uff0c\u6d45\u6790koa\u6d0b\u8471\u6a21\u578b\u539f\u7406\u548cco\u539f\u7406 - \u6709\u7ec4\u7ec7\u5728!","isPartOf":{"@id":"https://uzzz.org/#website"},"primaryImageOfPage":{"@id":"https://uzzz.org/article/4069/#primaryimage"},"datePublished":"2020-03-16T00:47:00+00:00","dateModified":"2020-03-16T00:47:00+00:00","author":{"@id":"https://uzzz.org/#/schema/person/29673f1347b0abda5882803c72ee5a3f"}},{"@type":["Person"],"@id":"https://uzzz.org/#/schema/person/29673f1347b0abda5882803c72ee5a3f","name":"fandyvon","sameAs":[]}]}</script><link rel="canonical" href="https://uzzz.org/article/4069/"></head>

<body class="">

<header id="top" class="amp-wp-header">
	<div>
		<a href="https://uzzz.org/">
										<amp-img src="https://uzzz.org/wp-content/uploads/2019/10/cropped-icon-32x32.png" width="32" height="32" class="amp-wp-site-icon i-amphtml-layout-fixed i-amphtml-layout-size-defined" style="width:32px;height:32px;" i-amphtml-layout="fixed"></amp-img>
						<span class="amp-site-title">
				有组织在!			</span>
		</a>

					</div>
</header>

<article class="amp-wp-article">
	<header class="amp-wp-article-header">
		<h1 class="amp-wp-title">学习 koa 源码的整体架构，浅析koa洋葱模型原理和co原理</h1>
			<div class="amp-wp-meta amp-wp-byline">
					<amp-img src="https://secure.gravatar.com/avatar/e786821a74ef0467825a7d60183307bc?s=24&d=mm&r=g" alt="fandyvon" width="24" height="24" layout="fixed" class="i-amphtml-layout-fixed i-amphtml-layout-size-defined" style="width:24px;height:24px;" i-amphtml-layout="fixed"></amp-img>
				<span class="amp-wp-author author vcard">fandyvon</span>
	</div>
<div class="amp-wp-meta amp-wp-posted-on">
	<time datetime="2020-03-16T08:47:00+00:00">
		2 years ago	</time>
</div>
	</header>

	
	<div class="amp-wp-article-content">
		<p><br>
<br>
<br>
 </p>
<div id="article_content" class="article_content clearfix">
 
 
<div class="htmledit_views" id="content_views">
<div id="js_content">
<h2><span>前言</span></h2>
<blockquote>
<p>这是<code>学习源码整体架构系列</code>第七篇。整体架构这词语好像有点大，姑且就算是源码整体结构吧，主要就是学习是代码整体结构，不深究其他不是主线的具体函数的实现。本篇文章学习的是实际仓库的代码。</p>
</blockquote>
<p><code>学习源码整体架构系列</code>文章如下：</p>
<h2><span>1.</span><a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw%3D%3D&chksm=8866253cbf11ac2a53b385153cd8e9a0c4018b6b566750cf0b5d61d17afa2e90b52d36db8054&idx=1&mid=2650744496&scene=21&sn=0f149e9436cb77bf9fc1bfb47aedd334#wechat_redirect" rel="nofollow">学习 jQuery 源码整体架构，打造属于自己的 js 类库</a><br><span>2.</span><a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw%3D%3D&chksm=88662535bf11ac23eea3f76335f6777e2acbf4ee660b5616148e14ffbefc0e8520806db21056&idx=1&mid=2650744505&scene=21&sn=26801ad6c2a5eb9cf64e7556b6478d39#wechat_redirect" rel="nofollow">学习 underscore 源码整体架构，打造属于自己的函数式编程类库</a><br><span>3.</span><a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw%3D%3D&chksm=8866254ebf11ac5822fc078082603f77a4b4d9b487c9f4d7069acb12c727c46c75946fa9b0cd&idx=1&mid=2650744514&scene=21&sn=776336d888d06bfe72cb4d5b07a4b90c#wechat_redirect" rel="nofollow">学习 lodash 源码整体架构，打造属于自己的函数式编程类库</a><br><span>4.</span><a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw%3D%3D&chksm=8866256bbf11ac7d9e2269f3638a705d5e5f45056d53ad2faf17b814e4c46ec6b0ba52571bde&idx=1&mid=2650744551&scene=21&sn=4d79c2fa97d7c737aab70055c7ec7fa3#wechat_redirect" rel="nofollow">学习 sentry 源码整体架构，打造属于自己的前端异常监控SDK</a><br><span>5.</span><a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw%3D%3D&chksm=88662484bf11ad922ed27d45873af838298949eea381545e82a511cabf0c6fc6876a8370c6fb&idx=1&mid=2650744584&scene=21&sn=b14f8a762f132adcf0f7e3e075ee2ded#wechat_redirect" rel="nofollow">学习 vuex 源码整体架构，打造属于自己的状态管理库</a><br><span>6.</span><a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw%3D%3D&chksm=88662490bf11ad86061ae76ff71a1177eeddab02c38d046eecd0e1ad25dc16f7591f91e9e3b2&idx=1&mid=2650744604&scene=21&sn=51d8d865c9848fd59f7763f5fb9ce789#wechat_redirect" rel="nofollow">学习 axios 源码整体架构，打造属于自己的请求库</a></h2>
<p>感兴趣的读者可以点击阅读。<br>其他源码计划中的有：<code>express</code>、<code>vue-rotuer</code>、<code>redux</code>、  <code>react-redux</code> 等源码，不知何时能写完（哭泣），欢迎持续关注我（若川）。</p>
<p>源码类文章，一般阅读量不高。已经有能力看懂的，自己就看了。不想看，不敢看的就不会去看源码。<br>所以我的文章，尽量写得让想看源码又不知道怎么看的读者能看懂。</p>
<p>如果你简历上一不小心写了熟悉<code>koa</code>，面试官大概率会问：</p>
<blockquote>
<p>1、<code>koa</code>洋葱模型怎么实现的。<br>2、如果中间件中的<code>next()</code>方法报错了怎么办。<br>3、<code>co</code>的原理是怎样的。<br>等等问题</p>
</blockquote>
<p><strong>导读</strong><br>文章通过例子调试<code>koa</code>，梳理<code>koa</code>的主流程，来理解<code>koa-compose</code>洋葱模型原理和<code>co</code>库的原理，相信看完一定会有所收获。</p>
<p>   <amp-img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3lkTzZSU2daNVdaQldvS2ljaWE2d0ZCaktlOXUwSm40MlRUV2liWDhDc2ljSFBueUV3OW5hZTJUd01RLzY0MA?x-oss-process=image/format,png" width="1080" height="430" class="amp-wp-enforced-sizes i-amphtml-layout-intrinsic i-amphtml-layout-size-defined" layout="intrinsic" i-amphtml-layout="intrinsic"><i-amphtml-sizer class="i-amphtml-sizer"><img alt="" aria-hidden="true" class="i-amphtml-intrinsic-sizer" role="presentation" src="data:image/svg+xml;charset=utf-8,<svg%20height=%22430%22%20width=%221080%22%20xmlns=%22http://www.w3.org/2000/svg%22%20version=%221.1%22/>"></i-amphtml-sizer><noscript><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3lkTzZSU2daNVdaQldvS2ljaWE2d0ZCaktlOXUwSm40MlRUV2liWDhDc2ljSFBueUV3OW5hZTJUd01RLzY0MA?x-oss-process=image/format,png" width="1080" height="430" class=""></noscript></amp-img><figcaption>
    本文目录<br>
   </figcaption></p><p>本文学习的<code>koa</code>版本是<code>v2.11.0</code>。克隆的官方仓库的<code>master</code>分支。截至目前（2020年3月11日），最新一次<code>commit</code>是<code>2020-01-04 07:41 Olle Jonsson</code> <code>eda27608</code>，<code>build: Drop unused Travis sudo: false directive (#1416)</code>。</p>
<p>本文仓库在这里若川的 koa-analysis github 仓库 https://github.com/lxchuan12/koa-analysis。求个<code>star</code>呀。</p>
<h2><span>本文阅读最佳方式</span></h2>
<p>先<code>star</code>一下我的仓库，再把它<code>git clone https://github.com/lxchuan12/koa-analysis.git</code>克隆下来。不用管你是否用过<code>nodejs</code>。会一点点<code>promise、generator、async、await</code>等知识即可看懂。如果一点点也不会，可以边看阮一峰老师的《ES6标准入门》相关章节。<strong>跟着文章节奏调试和示例代码调试，动手调试（用<code>vscode</code>或者<code>chrome</code>）印象更加深刻</strong>。文章长段代码不用细看，可以调试时再细看。看这类源码文章百遍，可能不如自己多调试几遍。也欢迎加我微信交流<code>lxchuan12</code>。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go"># 克隆我的这个仓库
git clone https://github.com/lxchuan12/koa-analysis.git
# chrome 调试：
# 全局安装 http-server
npm i -g http-server
hs koa/examples/
# 可以指定端口 -p 3001
# hs -p 3001 koa/examples/
# 浏览器中打开
# 然后在浏览器中打开localhost:8080，开心的把代码调试起来
</code></pre>
<p>这里把这个<code>examples</code>文件夹做个简单介绍。</p>
<ul>
<li>
<p><code>middleware</code>文件夹是用来<code>vscode</code>调试整体流程的。</p>
</li>
<li>
<p><code>simpleKoa</code> 文件夹是<code>koa</code>简化版，为了调试<code>koa-compose</code>洋葱模型如何串联起来各个中间件的。</p>
</li>
<li>
<p><code>koa-convert</code>文件夹是用来调试<code>koa-convert</code>和<code>co</code>源码的。</p>
</li>
<li>
<p><code>co-generator</code>文件夹是模拟实现<code>co</code>的示例代码。</p>
</li>
</ul>
<h2><span>vscode 调试 koa 源码方法</span></h2>
<p>之前，我在知乎回答了一个问题<a href="http://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw%3D%3D&chksm=8866249ebf11ad88635a58d9464c29cf2de44745927b81be2cb0adba874c532b3ff3b19434a2&idx=1&mid=2650744594&scene=21&sn=501237d70ebd4324af98780640ba1a14#wechat_redirect" rel="nofollow">一年内的前端看不懂前端框架源码怎么办？</a>推荐了一些资料，阅读量还不错，大家有兴趣可以看看。主要有四点：</p>
<blockquote>
<p>1.借助调试<br>2.搜索查阅相关高赞文章<br>3.把不懂的地方记录下来，查阅相关文档<br>4.总结</p>
</blockquote>
<p>看源码，调试很重要，所以我详细写下 <code>koa</code> 源码调试方法，帮助一些可能不知道如何调试的读者。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go"># 我已经克隆到我的koa-analysis仓库了
git clone https://github.com/koajs/koa.git
</code></pre>
<pre data-from="code-for-outside" class="has"><code class="language-go">// package.json
{
  "name": "koa",
  "version": "2.11.0",
  "description": "Koa web app framework",
  "main": "lib/application.js",
}
</code></pre>
<p>克隆源码后，看<code>package.json</code>找到<code>main</code>，就知道入口文件是<code>lib/application.js</code>了。</p>
<p>大概看完项目结构后发现没有<code>examples</code>文件夹（一般项目都会有这个文件夹，告知用户如何使用该项目），这时仔细看<code>README.md</code>。如果看英文<code>README.md</code>有些吃力，会发现在<code>Community</code>标题下有一个中文文档 v2.x。同时也有一个<code>examples</code>仓库。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go"># 我已经克隆下来到我的仓库了
git clone https://github.com/koajs/examples.git
</code></pre>
<p>这时再开心的把<code>examples</code>克隆到自己电脑。可以安装好依赖，逐个研究学习下这里的例子，然后可能就一不小心掌握了<code>koa</code>的基本用法。当然，我这里不详细写这一块了，我是自己手写一些例子来调试。</p>
<p>继续看文档会发现<strong>使用指南</strong>讲述<code>编写中间件</code>。</p>
<h3><span></span><span>使用文档中的中间件<code>koa-compose</code>例子来调试</span></h3>
<p>学习 <code>koa-compose</code> 前，先看两张图。</p>
<p>   <amp-img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3l3YTFJM09hT1h1NElVaWJVS21IWEF6SlF1TWJPdnNuVUtQS3RLd2ZEVURhTHZEbHA4OFppYjZEUS82NDA?x-oss-process=image/format,png" width="478" height="435" class="amp-wp-enforced-sizes i-amphtml-layout-intrinsic i-amphtml-layout-size-defined" layout="intrinsic" i-amphtml-layout="intrinsic"><i-amphtml-sizer class="i-amphtml-sizer"><img alt="" aria-hidden="true" class="i-amphtml-intrinsic-sizer" role="presentation" src="data:image/svg+xml;charset=utf-8,<svg%20height=%22435%22%20width=%22478%22%20xmlns=%22http://www.w3.org/2000/svg%22%20version=%221.1%22/>"></i-amphtml-sizer><noscript><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3l3YTFJM09hT1h1NElVaWJVS21IWEF6SlF1TWJPdnNuVUtQS3RLd2ZEVURhTHZEbHA4OFppYjZEUS82NDA?x-oss-process=image/format,png" width="478" height="435" class=""></noscript></amp-img><figcaption>
    洋葱模型示意图<br>
   </figcaption><amp-img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3k4REtKOGE3aWF1VVR6WG03QjduYllrNVJTNmFpYUdrbHN2MFZRQW5xOEd2R0F6OTFMelBXUk5hUS82NDA?x-oss-process=image/format,png" width="470" height="411" class="amp-wp-enforced-sizes i-amphtml-layout-intrinsic i-amphtml-layout-size-defined" layout="intrinsic" i-amphtml-layout="intrinsic"><i-amphtml-sizer class="i-amphtml-sizer"><img alt="" aria-hidden="true" class="i-amphtml-intrinsic-sizer" role="presentation" src="data:image/svg+xml;charset=utf-8,<svg%20height=%22411%22%20width=%22470%22%20xmlns=%22http://www.w3.org/2000/svg%22%20version=%221.1%22/>"></i-amphtml-sizer><noscript><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3k4REtKOGE3aWF1VVR6WG03QjduYllrNVJTNmFpYUdrbHN2MFZRQW5xOEd2R0F6OTFMelBXUk5hUS82NDA?x-oss-process=image/format,png" width="470" height="411" class=""></noscript></amp-img><figcaption>
    洋葱模型中间件示意图<br>
   </figcaption></p><p>在<code>koa</code>中，请求响应都放在中间件的第一个参数<code>context</code>对象中了。</p>
<p>再引用Koa中文文档中的一段：</p>
<p>如果您是前端开发人员，您可以将 <code>next()</code>; 之前的任意代码视为“捕获”阶段，这个简易的 <code>gif</code> 说明了 <code>async</code> 函数如何使我们能够恰当地利用堆栈流来实现请求和响应流：</p>
<p>   <amp-img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X2dpZi9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3lyUG51SVhsQzlYOVZtUTNycElDSWNNaEJkem94OHJscUtzV0Q1ZFJLaENVdG5MQXE1bHhjdEEvNjQw?x-oss-process=image/format,png" width="639" height="547" class="amp-wp-enforced-sizes i-amphtml-layout-intrinsic i-amphtml-layout-size-defined" layout="intrinsic" i-amphtml-layout="intrinsic"><i-amphtml-sizer class="i-amphtml-sizer"><img alt="" aria-hidden="true" class="i-amphtml-intrinsic-sizer" role="presentation" src="data:image/svg+xml;charset=utf-8,<svg%20height=%22547%22%20width=%22639%22%20xmlns=%22http://www.w3.org/2000/svg%22%20version=%221.1%22/>"></i-amphtml-sizer><noscript><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X2dpZi9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3lyUG51SVhsQzlYOVZtUTNycElDSWNNaEJkem94OHJscUtzV0Q1ZFJLaENVdG5MQXE1bHhjdEEvNjQw?x-oss-process=image/format,png" width="639" height="547" class=""></noscript></amp-img><figcaption>
    中间件gif图<br>
   </figcaption></p><blockquote>
<ol>
<li>
<p>创建一个跟踪响应时间的日期</p>
</li>
<li>
<p>等待下一个中间件的控制</p>
</li>
<li>
<p>创建另一个日期跟踪持续时间</p>
</li>
<li>
<p>等待下一个中间件的控制</p>
</li>
<li>
<p>将响应主体设置为“Hello World”</p>
</li>
<li>
<p>计算持续时间</p>
</li>
<li>
<p>输出日志行</p>
</li>
<li>
<p>计算响应时间</p>
</li>
<li>
<p>设置 <code>X-Response-Time</code> 头字段</p>
</li>
<li>
<p>交给 Koa 处理响应</p>
</li>
</ol>
</blockquote>
<p>读者们看完这个gif图，也可以思考下如何实现的。根据表现，可以猜测是<code>next</code>是一个函数，而且返回的可能是一个<code>promise</code>，被<code>await</code>调用。</p>
<p>看到这个<code>gif</code>图，我把之前写的<code>examples/koa-compose</code>的调试方法<strong>含泪删除</strong>了。默默写上<code>gif</code>图上的这些代码，想着这个读者们更容易读懂。我把这段代码写在这里 <code>koa/examples/middleware/app.js</code>便于调试。</p>
<p>在项目路径下配置新建.vscode/launch.json文件，<code>program</code>配置为自己写的<code>koa/examples/middleware/app.js</code>文件。</p>
<p>.vscode/launch.json 代码，点击这里展开/收缩，可以复制</p>
<p>按<code>F5键</code>开始调试，调试时先走主流程，必要的地方打上断点，不用一开始就关心细枝末节。</p>
<blockquote>
<p><strong>断点调试要领：</strong><br><strong>赋值语句可以一步跳过，看返回值即可，后续详细再看。</strong><br><strong>函数执行需要断点跟着看，也可以结合注释和上下文倒推这个函数做了什么。</strong></p>
</blockquote>
<p>上述比较啰嗦的写了一堆调试方法。主要是想着<code>授人予鱼不如授人予渔</code>，这样换成其他源码也会调试了。</p>
<p>简单说下<code>chrome</code>调试<code>nodejs</code>，<code>chrome</code>浏览器打开<code>chrome://inspect</code>，点击配置**configure…**配置<code>127.0.0.1:端口号</code>(端口号在<code>Vscode</code> 调试控制台显示了)。<br>更多可以查看English Debugging Guide<br>中文调试指南<br>喜欢看视频的读者也可以看慕课网这个视频node.js调试入门，讲得还是比较详细的。<br>不过我感觉在<code>chrome</code>调试<code>nodejs</code>项目体验不是很好（可能是我方式不对），所以我大部分具体的代码时都放在<code>html</code>文件<code>script</code>形式，在<code>chrome</code>调试了。</p>
<h2><span>先看看 <code>new Koa()</code> 结果<code>app</code>是什么</span></h2>
<p>看源码我习惯性看<strong>它的实例对象结构</strong>，一般所有属性和方法都放在实例对象上了，而且会通过原型链查找形式查找最顶端的属性和方法。</p>
<p>用<code>koa/examples/middleware/app.js</code>文件调试时，先看下执行<code>new Koa()</code>之后，<code>app</code>是什么，有个初步印象。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">// 文件 koa/examples/middleware/app.js
const Koa = require('../../lib/application');

// const Koa = require('koa');
// 这里打个断点
const app = new Koa();
// x-response-time

// 这里打个断点
app.use(async (ctx, next) => {

});
</code></pre>
<p>在调试控制台<code>ctrl + 反引号键（一般在</code>Tab<code>上方的按键）唤起</code>，输入<code>app</code>，按<code>enter</code>键打印<code>app</code>。会有一张这样的图。</p>
<p>   <amp-img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3lxdkdMVUNXNjc3Um10MkNZWjVveWliWmdYQTFUYW01eXBGNVRUaWIwWWh2OUJUVG9KV0lFUmhSZy82NDA?x-oss-process=image/format,png" width="1080" height="561" class="amp-wp-enforced-sizes i-amphtml-layout-intrinsic i-amphtml-layout-size-defined" layout="intrinsic" i-amphtml-layout="intrinsic"><i-amphtml-sizer class="i-amphtml-sizer"><img alt="" aria-hidden="true" class="i-amphtml-intrinsic-sizer" role="presentation" src="data:image/svg+xml;charset=utf-8,<svg%20height=%22561%22%20width=%221080%22%20xmlns=%22http://www.w3.org/2000/svg%22%20version=%221.1%22/>"></i-amphtml-sizer><noscript><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3lxdkdMVUNXNjc3Um10MkNZWjVveWliWmdYQTFUYW01eXBGNVRUaWIwWWh2OUJUVG9KV0lFUmhSZy82NDA?x-oss-process=image/format,png" width="1080" height="561" class=""></noscript></amp-img><figcaption>
    koa 实例对象调试图<br>
   </figcaption></p><p><code>VScode</code>也有一个代码调试神器插件<code>Debug Visualizer</code>。</p>
<p>安装好后插件后，按<code>ctrl + shift + p</code>，输入<code>Open a new Debug Visualizer View</code>，来使用，输入<code>app</code>，显示是这样的。</p>
<p>   <amp-img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X2pwZy9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3lxTXIzQTRuSmlhNDZFZDRSV1ZaRTFvYjg4RXRBNW9UdDNVU21kYjZYS1puSHp3YWZBU1Z2WTdBLzY0MA?x-oss-process=image/format,png" width="800" height="250" class="amp-wp-enforced-sizes i-amphtml-layout-intrinsic i-amphtml-layout-size-defined" layout="intrinsic" i-amphtml-layout="intrinsic"><i-amphtml-sizer class="i-amphtml-sizer"><img alt="" aria-hidden="true" class="i-amphtml-intrinsic-sizer" role="presentation" src="data:image/svg+xml;charset=utf-8,<svg%20height=%22250%22%20width=%22800%22%20xmlns=%22http://www.w3.org/2000/svg%22%20version=%221.1%22/>"></i-amphtml-sizer><noscript><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X2pwZy9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3lxTXIzQTRuSmlhNDZFZDRSV1ZaRTFvYjg4RXRBNW9UdDNVU21kYjZYS1puSHp3YWZBU1Z2WTdBLzY0MA?x-oss-process=image/format,png" width="800" height="250" class=""></noscript></amp-img><figcaption>
    koa 实例对象可视化简版<br>
   </figcaption></p><p>不过目前体验来看，相对还比较鸡肋，只能显示一级，而且只能显示对象，相信以后会更好。更多玩法可以查看它的文档。</p>
<p>我把koa实例对象比较完整的用<code>xmind</code>画出来了，大概看看就好，有个初步印象。</p>
<p>   <amp-img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3lmVkFzOU8zTFQyQkp3QktTMEh6bThtTzJ2RHZMM2liME41dFY1SzZjUDlDa3lzTHNkUEJ3OTZ3LzY0MA?x-oss-process=image/format,png" width="1080" height="1593" class="amp-wp-enforced-sizes i-amphtml-layout-intrinsic i-amphtml-layout-size-defined" layout="intrinsic" i-amphtml-layout="intrinsic"><i-amphtml-sizer class="i-amphtml-sizer"><img alt="" aria-hidden="true" class="i-amphtml-intrinsic-sizer" role="presentation" src="data:image/svg+xml;charset=utf-8,<svg%20height=%221593%22%20width=%221080%22%20xmlns=%22http://www.w3.org/2000/svg%22%20version=%221.1%22/>"></i-amphtml-sizer><noscript><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9NcHQ4NkVHamxwdTFsMXVDaWJsV3p4dmd1R3loUHp4V3lmVkFzOU8zTFQyQkp3QktTMEh6bThtTzJ2RHZMM2liME41dFY1SzZjUDlDa3lzTHNkUEJ3OTZ3LzY0MA?x-oss-process=image/format,png" width="1080" height="1593" class=""></noscript></amp-img><figcaption>
    koa 实例对象<br>
   </figcaption></p><p>接着，我们可以看下<code>app 实例、context、request、request</code>的官方文档。</p>
<h3><span></span><span>app 实例、context、request、request 官方API文档</span></h3>
<ul>
<li>
<p>index API | context API | request API | response API</p>
</li>
</ul>
<p>可以真正使用的时候再去仔细看文档。</p>
<h2><span>koa 主流程梳理简化</span></h2>
<p>通过<code>F5启动调试（直接跳到下一个断点处）</code>、<code>F10单步跳过</code>、<code>F11单步调试</code>等，配合重要的地方断点，调试完整体代码，其实比较容易整理出如下主流程的代码。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">class Emitter{
  // node 内置模块
  constructor(){
  }
}
class Koa extends Emitter{
  constructor(options){
    super();
    options = options || {};
    this.middleware = [];
    this.context = {
      method: 'GET',
      url: '/url',
      body: undefined,
      set: function(key, val){
        console.log('context.set', key, val);
      },
    };
  }
  use(fn){
    this.middleware.push(fn);
    return this;
  }
  listen(){
    const  fnMiddleware = compose(this.middleware);
    const ctx = this.context;
    const handleResponse = () => respond(ctx);
    const onerror = function(){
      console.log('onerror');
    };
    fnMiddleware(ctx).then(handleResponse).catch(onerror);
  }
}
function respond(ctx){
  console.log('handleResponse');
  console.log('response.end', ctx.body);
}
</code></pre>
<p>重点就在<code>listen</code>函数里的<code>compose</code>这个函数，接下来我们就详细来<strong>欣赏</strong>下这个函数。</p>
<h2><span>koa-compose 源码（洋葱模型实现）</span></h2>
<p>通过<code>app.use()</code> 添加了若干函数，但是要把它们串起来执行呀。像上文的<code>gif</code>图一样。</p>
<p><code>compose</code>函数，传入一个数组，返回一个函数。对入参是不是数组和校验数组每一项是不是函数。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">function compose (middleware) {
  if (!Array.isArray(middleware)) throw new TypeError('Middleware stack must be an array!')
  for (const fn of middleware) {
    if (typeof fn !== 'function') throw new TypeError('Middleware must be composed of functions!')
  }

 //  传入对象 context 返回Promise
  return function (context, next) {
    // last called middleware #
    let index = -1
    return dispatch(0)
    function dispatch (i) {
      if (i <= index) return Promise.reject(new Error('next() called multiple times'))
      index = i
      let fn = middleware[i]
      if (i === middleware.length) fn = next
      if (!fn) return Promise.resolve()
      try {
        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));
      } catch (err) {
        return Promise.reject(err)
      }
    }
  }
}
</code></pre>
<p>把简化的代码和<code>koa-compose</code>代码写在了一个文件中。koa/examples/simpleKoa/koa-compose.js</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">hs koa/examples/
# 然后可以打开localhost:8080/simpleKoa，开心的把代码调试起来
</code></pre>
<p>不过这样好像还是有点麻烦，我还把这些代码放在<code>codepen</code> https://codepen.io/lxchuan12/pen/wvarPEb中，<strong>直接可以在线调试啦</strong>。是不是觉得很贴心^_^，自己多调试几遍便于消化理解。</p>
<p>你会发现<code>compose</code>就是类似这样的结构（移除一些判断）。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">// 这样就可能更好理解了。
// simpleKoaCompose
const [fn1, fn2, fn3] = this.middleware;
const fnMiddleware = function(context){
    return Promise.resolve(
      fn1(context, function next(){
        return Promise.resolve(
          fn2(context, function next(){
              return Promise.resolve(
                  fn3(context, function next(){
                    return Promise.resolve();
                  })
              )
          })
        )
    })
  );
};
fnMiddleware(ctx).then(handleResponse).catch(onerror);
</code></pre>
<blockquote>
<p>也就是说<code>koa-compose</code>返回的是一个<code>Promise</code>，<code>Promise</code>中取出第一个函数（<code>app.use</code>添加的中间件），传入<code>context</code>和第一个<code>next</code>函数来执行。<br>第一个<code>next</code>函数里也是返回的是一个<code>Promise</code>，<code>Promise</code>中取出第二个函数（<code>app.use</code>添加的中间件），传入<code>context</code>和第二个<code>next</code>函数来执行。<br>第二个<code>next</code>函数里也是返回的是一个<code>Promise</code>，<code>Promise</code>中取出第三个函数（<code>app.use</code>添加的中间件），传入<code>context</code>和第三个<code>next</code>函数来执行。<br>第三个…<br>以此类推。最后一个中间件中有调用<code>next</code>函数，则返回<code>Promise.resolve</code>。如果没有，则不执行<code>next</code>函数。这样就把所有中间件串联起来了。这也就是我们常说的洋葱模型。</p>
</blockquote>
<p><strong>不得不说非常惊艳，“玩还是大神会玩”</strong>。</p>
<p>这种把函数存储下来的方式，在很多源码中都有看到。比如<code>lodash</code>源码的惰性求值，<code>vuex</code>也是把<code>action</code>等函数存储下，最后才去调用。</p>
<p>搞懂了<code>koa-compose</code> 洋葱模型实现的代码，其他代码就不在话下了。</p>
<h2><span>错误处理</span></h2>
<p>中文文档 错误处理</p>
<p>仔细看文档，文档中写了三种捕获错误的方式。</p>
<ul>
<li>
<p><code>ctx.onerror</code> 中间件中的错误捕获</p>
</li>
<li>
<p><code>app.on('error', (err) => {})</code> 最外层实例事件监听形式 也可以看看例子koajs/examples/errors/app.js 文件</p>
</li>
<li>
<p><code>app.onerror = (err) => {}</code> 重写<code>onerror</code>自定义形式 也可以看测试用例 onerror</p>
</li>
</ul>
<pre data-from="code-for-outside" class="has"><code class="language-go">// application.js 文件
class Application extends Emitter {
  // 代码有简化组合
  listen(){
    const  fnMiddleware = compose(this.middleware);
    if (!this.listenerCount('error')) this.on('error', this.onerror);
    const onerror = err => ctx.onerror(err);
    fnMiddleware(ctx).then(handleResponse).catch(onerror);
  }
  onerror(err) {
    // 代码省略
    // ...
  }
}
</code></pre>
<p><strong>ctx.onerror</strong></p>
<p><code>lib/context.js</code>文件中，有一个函数<code>onerror</code>，而且有这么一行代码<code>this.app.emit('error', err, this)</code>。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">module.exports = {
  onerror(){
    // delegate
    // app 是在new Koa() 实例
    this.app.emit('error', err, this);
  }
}
</code></pre>
<pre data-from="code-for-outside" class="has"><code class="language-go">app.use(async (ctx, next) => {
  try {
    await next();
  } catch (err) {
    err.status = err.statusCode || err.status || 500;
    throw err;
  }
});
</code></pre>
<p><code>try catch</code> 错误或被<code>fnMiddleware(ctx).then(handleResponse).catch(onerror);</code>，这里的<code>onerror</code>是<code>ctx.onerror</code><br>而<code>ctx.onerror</code>函数中又调用了<code>this.app.emit('error', err, this)</code>，所以在最外围<code>app.on('error'，err => {})</code>可以捕获中间件链中的错误。因为<code>koa</code>继承自<code>events模块</code>，所以有’emit’和<code>on</code>等方法）</p>
<h2><span>koa2 和 koa1 的简单对比</span></h2>
<p>中文文档中描述了 koa2 和 koa1 的区别</p>
<p><code>koa1</code>中主要是<code>generator</code>函数。<code>koa2</code>中会自动转换<code>generator</code>函数。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">// Koa 将转换
app.use(function *(next) {
  const start = Date.now();
  yield next;
  const ms = Date.now() - start;
  console.log(`${this.method} ${this.url} - ${ms}ms`);
});
</code></pre>
<h3><span></span><span>koa-convert 源码</span></h3>
<p>在<code>vscode/launch.json</code>文件，找到这个<code>program</code>字段，修改为<code>"program": "${workspaceFolder}/koa/examples/koa-convert/app.js"</code>。</p>
<p>通过<code>F5启动调试（直接跳到下一个断点处）</code>、<code>F10单步跳过</code>、<code>F11单步调试</code>调试走一遍流程。重要地方断点调试。</p>
<p><code>app.use</code>时有一层判断，是否是<code>generator</code>函数，如果是则用<code>koa-convert</code>暴露的方法<code>convert</code>来转换重新赋值，再存入<code>middleware</code>，后续再使用。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">class Koa extends Emitter{
  use(fn) {
    if (typeof fn !== 'function') throw new TypeError('middleware must be a function!');
    if (isGeneratorFunction(fn)) {
      deprecate('Support for generators will be removed in v3. ' +
                'See the documentation for examples of how to convert old middleware ' +
                'https://github.com/koajs/koa/blob/master/docs/migration.md');
      fn = convert(fn);
    }
    debug('use %s', fn._name || fn.name || '-');
    this.middleware.push(fn);
    return this;
  }
}
</code></pre>
<p><code>koa-convert</code>源码挺多，核心代码其实是这样的。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">function convert(){
 return function (ctx, next) {
    return co.call(ctx, mw.call(ctx, createGenerator(next)))
  }
  function * createGenerator (next) {
    return yield next()
  }
}
</code></pre>
<p>最后还是通过<code>co</code>来转换的。所以接下来看<code>co</code>的源码。</p>
<h3><span></span><span>co 源码</span></h3>
<p>tj大神写的co 仓库</p>
<p>本小节的示例代码都在这个文件夹<code>koa/examples/co-generator</code>中，<code>hs koa/example</code>，可以自行打开<code>https://localhost:8080/co-generator</code>调试查看。</p>
<p>看<code>co</code>源码前，先看几段简单代码。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">// 写一个请求简版请求
function request(ms= 1000) {
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve({name: '若川'});
    }, ms);
  });
}
</code></pre>
<pre data-from="code-for-outside" class="has"><code class="language-go">// 获取generator的值
function* generatorFunc(){
  const res = yield request();
  console.log(res, 'generatorFunc-res');
}
generatorFunc(); // 报告，我不会输出你想要的结果的
</code></pre>
<p>简单来说<code>co</code>，就是把<code>generator</code>自动执行，再返回一个<code>promise</code>。<strong><code>generator</code>函数这玩意它不自动执行呀，还要一步步调用<code>next()</code>，也就是叫它走一步才走一步</strong>。</p>
<p>所以有了<code>async、await</code>函数。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">// await 函数 自动执行
async function asyncFunc(){
    const res = await request();
    console.log(res, 'asyncFunc-res await 函数 自动执行');
}
asyncFunc(); // 输出结果
</code></pre>
<p>也就是说<code>co</code>需要做的事情，是让<code>generator</code>向<code>async、await</code>函数一样自动执行。</p>
<h3><span></span><span>模拟实现简版 co（第一版）</span></h3>
<p>这时，我们来模拟实现第一版的<code>co</code>。根据<code>generator</code>的特性，其实容易写出如下代码。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">// 获取generator的值
function* generatorFunc(){
  const res = yield request();
  console.log(res, 'generatorFunc-res');
}

function coSimple(gen){
  gen = gen();
  console.log(gen, 'gen');

  const ret = gen.next();
  const promise = ret.value;
  promise.then(res => {
    gen.next(res);
  });
}
coSimple(generatorFunc);
// 输出了想要的结果
// {name: "若川"}"generatorFunc-res"
</code></pre>
<h3><span></span><span>模拟实现简版 co（第二版）</span></h3>
<p>但是实际上，不会上面那么简单的。有可能是多个<code>yield</code>和传参数的情况。传参可以通过这如下两行代码来解决。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">const args = Array.prototype.slice.call(arguments, 1);
gen = gen.apply(ctx, args);
</code></pre>
<p>两个<code>yield</code>，我大不了重新调用一下<code>promise.then</code>，搞定。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">// 多个yeild，传参情况
function* generatorFunc(suffix = ''){
  const res = yield request();
  console.log(res, 'generatorFunc-res' + suffix);

  const res2 = yield request();
  console.log(res2, 'generatorFunc-res-2' + suffix);
}

function coSimple(gen){
  const ctx = this;
  const args = Array.prototype.slice.call(arguments, 1);
  gen = gen.apply(ctx, args);
  console.log(gen, 'gen');

  const ret = gen.next();
  const promise = ret.value;
  promise.then(res => {
    const ret = gen.next(res);
    const promise = ret.value;
      promise.then(res => {
        gen.next(res);
      });
  });
}

coSimple(generatorFunc, ' 哎呀，我真的是后缀');
</code></pre>
<h3><span></span><span>模拟实现简版 co（第三版）</span></h3>
<p>问题是肯定不止两次，无限次的<code>yield</code>的呢，这时肯定要把重复的封装起来。而且返回是<code>promise</code>，这就实现了如下版本的代码。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">function* generatorFunc(suffix = ''){
  const res = yield request();
  console.log(res, 'generatorFunc-res' + suffix);

  const res2 = yield request();
  console.log(res2, 'generatorFunc-res-2' + suffix);

  const res3 = yield request();
  console.log(res3, 'generatorFunc-res-3' + suffix);

  const res4 = yield request();
  console.log(res4, 'generatorFunc-res-4' + suffix);
}

function coSimple(gen){
  const ctx = this;
  const args = Array.prototype.slice.call(arguments, 1);
  gen = gen.apply(ctx, args);
  console.log(gen, 'gen');

  return new Promise((resolve, reject) => {

    onFulfilled();

    function onFulfilled(res){
      const ret = gen.next(res);
      next(ret);
    }

    function next(ret) {
      const promise = ret.value;
      promise && promise.then(onFulfilled);
    }

  });
}

coSimple(generatorFunc, ' 哎呀，我真的是后缀');
</code></pre>
<p>但第三版的模拟实现简版<code>co</code>中，还没有考虑报错和一些参数合法的情况。</p>
<h3><span></span><span>最终来看下<code>co</code>源码</span></h3>
<p>这时来看看<code>co</code>的源码，报错和错误的情况，错误时调用<code>reject</code>，是不是就好理解了一些呢。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">function co(gen) {
  var ctx = this;
  var args = slice.call(arguments, 1)

  // we wrap everything in a promise to avoid promise chaining,
  // which leads to memory leak errors.
  // see https://github.com/tj/co/issues/180
  return new Promise(function(resolve, reject) {
    // 把参数传递给gen函数并执行
    if (typeof gen === 'function') gen = gen.apply(ctx, args);
    // 如果不是函数 直接返回
    if (!gen || typeof gen.next !== 'function') return resolve(gen);

    onFulfilled();

    /**
     * @param {Mixed} res
     * @return {Promise}
     * @api private
     */

    function onFulfilled(res) {
      var ret;
      try {
        ret = gen.next(res);
      } catch (e) {
        return reject(e);
      }
      next(ret);
    }

    /**
     * @param {Error} err
     * @return {Promise}
     * @api private
     */

    function onRejected(err) {
      var ret;
      try {
        ret = gen.throw(err);
      } catch (e) {
        return reject(e);
      }
      next(ret);
    }

    /**
     * Get the next value in the generator,
     * return a promise.
     *
     * @param {Object} ret
     * @return {Promise}
     * @api private
     */

    // 反复执行调用自己
    function next(ret) {
      // 检查当前是否为 Generator 函数的最后一步，如果是就返回
      if (ret.done) return resolve(ret.value);
      // 确保返回值是promise对象。
      var value = toPromise.call(ctx, ret.value);
      // 使用 then 方法，为返回值加上回调函数，然后通过 onFulfilled 函数再次调用 next 函数。
      if (value && isPromise(value)) return value.then(onFulfilled, onRejected);
      // 在参数不符合要求的情况下（参数非 Thunk 函数和 Promise 对象），将 Promise 对象的状态改为 rejected，从而终止执行。
      return onRejected(new TypeError('You may only yield a function, promise, generator, array, or object, '
        + 'but the following object was passed: "' + String(ret.value) + '"'));
    }
  });
}
</code></pre>
<h2><span>koa 和 express 简单对比</span></h2>
<p>中文文档 koa 和 express 对比</p>
<p>文档里写的挺全面的。简单来说<code>koa2</code>语法更先进，更容易深度定制（<code>egg.js</code>、<code>think.js</code>、底层框架都是<code>koa</code>）。</p>
<h2><span>总结</span></h2>
<p>文章通过<code>授人予鱼不如授人予鱼</code>的方式，告知如何调试源码，看完了<code>koa-compose</code>洋葱模型实现，<code>koa-convert</code>和<code>co</code>等源码。</p>
<p><code>koa-compose</code>是将<code>app.use</code>添加到<code>middleware</code>数组中的中间件（函数），通过使用<code>Promise</code>串联起来，<code>next()</code>返回的是一个<code>promise</code>。</p>
<p><code>koa-convert</code> 判断<code>app.use</code>传入的函数是否是<code>generator</code>函数，如果是则用<code>koa-convert</code>来转换，最终还是调用的<code>co</code>来转换。</p>
<p><code>co</code>源码实现原理：其实就是通过不断的调用<code>generator</code>函数的<code>next()</code>函数，来达到自动执行<code>generator</code>函数的效果（类似<code>async、await函数的自动自行</code>）。</p>
<p><code>koa</code>框架总结：主要就是四个核心概念，洋葱模型（把中间件串联起来），<code>http</code>请求上下文（<code>context</code>）、<code>http</code>请求对象、<code>http</code>响应对象。</p>
<p>本文仓库在这里若川的 koa-analysis github 仓库 https://github.com/lxchuan12/koa-analysis。求个<code>star</code>呀。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">git clone https://github.com/lxchuan12/koa-analysis.git
</code></pre>
<p>再强烈建议下按照<strong>本文阅读最佳方式</strong>，克隆代码下来，<strong>动手调试代码学习更加深刻</strong>。</p>
<blockquote>
<p>如果读者发现有不妥或可改善之处，再或者哪里没写明白的地方，欢迎评论指出，也欢迎加我微信交流<code>lxchuan12</code>。另外觉得写得不错，对您有些许帮助，可以点赞、评论、转发分享，也是对笔者的一种支持，万分感谢。</p>
</blockquote>
<h3><span></span><span>解答下开头的提问</span></h3>
<p>仅供参考</p>
<blockquote>
<p>1、<code>koa</code>洋葱模型怎么实现的。</p>
</blockquote>
<p>可以参考上文整理的简版<code>koa-compose</code>作答。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">// 这样就可能更好理解了。
// simpleKoaCompose
const [fn1, fn2, fn3] = this.middleware;
const fnMiddleware = function(context){
    return Promise.resolve(
      fn1(context, function next(){
        return Promise.resolve(
          fn2(context, function next(){
              return Promise.resolve(
                  fn3(context, function next(){
                    return Promise.resolve();
                  })
              )
          })
        )
    })
  );
};
fnMiddleware(ctx).then(handleResponse).catch(onerror);
</code></pre>
<p>答：app.use() 把中间件函数存储在<code>middleware</code>数组中，最终会调用<code>koa-compose</code>导出的函数<code>compose</code>返回一个<code>promise</code>，中间函数的第一个参数<code>ctx</code>是包含响应和请求的一个对象，会不断传递给下一个中间件。<code>next</code>是一个函数，返回的是一个<code>promise</code>。</p>
<blockquote>
<p>2、如果中间件中的<code>next()</code>方法报错了怎么办。</p>
</blockquote>
<p>可参考上文整理的错误处理作答。</p>
<pre data-from="code-for-outside" class="has"><code class="language-go">ctx.onerror = function {
  this.app.emit('error', err, this);
};
  listen(){
    const  fnMiddleware = compose(this.middleware);
    if (!this.listenerCount('error')) this.on('error', this.onerror);
    const onerror = err => ctx.onerror(err);
    fnMiddleware(ctx).then(handleResponse).catch(onerror);
  }
  onerror(err) {
    // 代码省略
    // ...
  }
</code></pre>
<p>答：中间件链错误会由<code>ctx.onerror</code>捕获，该函数中会调用<code>this.app.emit('error', err, this)</code>（因为<code>koa</code>继承自<code>events模块</code>，所以有’emit’和<code>on</code>等方法），可以使用<code>app.on('error', (err) => {})</code>，或者<code>app.onerror = (err) => {}</code>进行捕获。</p>
<blockquote>
<p>3、<code>co</code>的原理是怎样的。<br>答：<code>co</code>的原理是通过不断调用<code>generator</code>函数的<code>next</code>方法来达到自动执行<code>generator</code>函数的，类似<code>async、await</code>函数自动执行。</p>
</blockquote>
<p>答完，面试官可能觉得小伙子还是蛮懂<code>koa</code>的啊。当然也可能继续追问，直到答不出…</p>
<h3><span></span><span>还能做些什么 ？</span></h3>
<p>学完了整体流程，<code>koa-compose</code>、<code>koa-convert</code>和<code>co</code>的源码。</p>
<p>还能仔细看看看<code>http</code>请求上下文（<code>context</code>）、<code>http</code>请求对象、<code>http</code>响应对象的具体实现。</p>
<p>还能根据我文章说的调试方式调试koa 组织中的各种中间件，比如<code>koa-bodyparser</code>, <code>koa-router</code>，<code>koa-jwt</code>，<code>koa-session</code>、<code>koa-cors</code>等等。</p>
<p>还能把<code>examples</code>仓库克隆下来，我的这个仓库已经克隆了，挨个调试学习下源码。</p>
<p><code>web</code>框架有很多，比如<code>Express.js</code>，<code>Koa.js</code>、<code>Egg.js</code>、<code>Nest.js</code>、<code>Next.js</code>、<code>Fastify.js</code>、<code>Hapi.js</code>、<code>Restify.js</code>、<code>Loopback.io</code>、<code>Sails.js</code>、<code>Midway.js</code>等等。</p>
<p>还能把这些框架的优势劣势、设计思想等学习下。</p>
<p>还能继续学习<code>HTTP</code>协议、<code>TCP/IP</code>协议网络相关，虽然不属于<code>koa</code>的知识，但需深入学习掌握。</p>
<p>学无止境~~~</p>
<p data-amp-original-style="text-align: left" class="amp-wp-6599cf4"><span><strong>推</strong></span><span><strong>荐</strong></span><span><strong>阅</strong></span><span><strong>读</strong></span></p>
<p data-amp-original-style="text-align: left" class="amp-wp-6599cf4"><span><em><strong>1、<a target="_blank" href="https://blog.csdn.net/azl397985856/article/details/104681814" rel="noopener noreferrer">写给大忙人看的进程和线程</a></strong></em></span></p>
<p data-amp-original-style="text-align: left" class="amp-wp-6599cf4"><span><em><em><strong>2、<a target="_blank" href="https://blog.csdn.net/azl397985856/article/details/104809873" rel="noopener noreferrer">超详细！从本质上搞懂困惑你多年的KMP匹配算法</a></strong></em></em></span></p>
<p data-amp-original-style="text-align: left" class="amp-wp-6599cf4"><span><em><em><strong>3、<a target="_blank" href="https://blog.csdn.net/azl397985856/article/details/104787970" rel="noopener noreferrer">十大经典排序算法整理汇总（附代码）</a></strong></em></em></span></p>
<p data-amp-original-style="text-align: left" class="amp-wp-6599cf4"><span><em><em><strong>4、<a target="_blank" href="https://blog.csdn.net/azl397985856/article/details/104832310" rel="noopener noreferrer">外部排序：如何用 2GB内存给 20 亿个整数排序？</a></strong></em></em></span></p>
<p data-amp-original-style="text-align: left" class="amp-wp-6599cf4"><span><em><strong>5、<a target="_blank" href="https://blog.csdn.net/azl397985856/article/details/104765538" rel="noopener noreferrer">内核地址空间大冒险3：权限管理</a></strong></em></span></p>
<p data-amp-original-style="text-align: left" class="amp-wp-6599cf4"><span><em><em><strong>6、<a target="_blank" href="https://blog.csdn.net/azl397985856/article/details/104528725" rel="noopener noreferrer">用好这几个工具，能大幅提升你的 Git/GitHub 操作效率！</a></strong></em></em></span></p>
<p data-amp-original-style="text-align: center" class="amp-wp-7023da7"><amp-img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84RzdDSWlhT09UbnczeVFuSUZ4S0l0cW1jak1SbDdiMU5sWWNidld6SHhueXRVMGZOajJUTzVVNEVrRWh6dWQzQ1BvWEJyeEJVNzFJYzQ3czR2SXdQOUEvNjQw?x-oss-process=image/format,png" width="495" height="48" class="amp-wp-enforced-sizes i-amphtml-layout-intrinsic i-amphtml-layout-size-defined" layout="intrinsic" i-amphtml-layout="intrinsic"><i-amphtml-sizer class="i-amphtml-sizer"><img alt="" aria-hidden="true" class="i-amphtml-intrinsic-sizer" role="presentation" src="data:image/svg+xml;charset=utf-8,<svg%20height=%2248%22%20width=%22495%22%20xmlns=%22http://www.w3.org/2000/svg%22%20version=%221.1%22/>"></i-amphtml-sizer><noscript><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84RzdDSWlhT09UbnczeVFuSUZ4S0l0cW1jak1SbDdiMU5sWWNidld6SHhueXRVMGZOajJUTzVVNEVrRWh6dWQzQ1BvWEJyeEJVNzFJYzQ3czR2SXdQOUEvNjQw?x-oss-process=image/format,png" width="495" height="48" class=""></noscript></amp-img></p>
<p data-amp-original-style="text-align: center" class="amp-wp-7023da7"><amp-img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9DdWFybERjdVdQNGtjalFiVVo3YnlScDdQNlcwb2doc051WUtFT1JkQWNQd1hvQ1ZEazQ1ZjRVaFJyV1VMRWRqc2lhR2liVkJzbE5pYW1rQkVic09tcHlvUS82NDA?x-oss-process=image/format,png" width="300" height="390" class="amp-wp-enforced-sizes i-amphtml-layout-intrinsic i-amphtml-layout-size-defined" layout="intrinsic" i-amphtml-layout="intrinsic"><i-amphtml-sizer class="i-amphtml-sizer"><img alt="" aria-hidden="true" class="i-amphtml-intrinsic-sizer" role="presentation" src="data:image/svg+xml;charset=utf-8,<svg%20height=%22390%22%20width=%22300%22%20xmlns=%22http://www.w3.org/2000/svg%22%20version=%221.1%22/>"></i-amphtml-sizer><noscript><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9DdWFybERjdVdQNGtjalFiVVo3YnlScDdQNlcwb2doc051WUtFT1JkQWNQd1hvQ1ZEazQ1ZjRVaFJyV1VMRWRqc2lhR2liVkJzbE5pYW1rQkVic09tcHlvUS82NDA?x-oss-process=image/format,png" width="300" height="390" class=""></noscript></amp-img></p>
<p>如果觉得文章不错，帮忙点个在看呗</p>
</div>
</div>
<div class="more-toolbox">
<div class="left-toolbox">
<ul class="toolbox-list">
<li class="tool-item tool-active is-like "><a><br>
      <svg class="icon" aria-hidden="true"><br>
       <use xlink:href="#csdnc-thumbsup"></use><br>
      </svg><span class="name">点赞</span> <span class="count"></span> </a></li>
<li class="tool-item tool-active is-collection "><a data-report-click='{"mod":"popu_824"}'><br>
      <svg class="icon" aria-hidden="true"><br>
       <use xlink:href="#icon-csdnc-Collection-G"></use><br>
      </svg><span class="name">收藏</span></a></li>
<li class="tool-item tool-active is-share"><a data-report-click='{"mod":"1582594662_002"}'><br>
      <svg class="icon" aria-hidden="true"><br>
       <use xlink:href="#icon-csdnc-fenxiang"></use><br>
      </svg>分享</a></li>
<p>    <br>
     </p>
<li class="tool-item tool-more"> <a><br>
      <svg class="icon" viewbox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><br>
       <defs>

<p>       </p></defs>
       <path d="M179.176 499.222m-113.245 0a113.245 113.245 0 1 0 226.49 0 113.245 113.245 0 1 0-226.49 0Z"></path>
       <path d="M509.684 499.222m-113.245 0a113.245 113.245 0 1 0 226.49 0 113.245 113.245 0 1 0-226.49 0Z"></path>
       <path d="M846.175 499.222m-113.245 0a113.245 113.245 0 1 0 226.49 0 113.245 113.245 0 1 0-226.49 0Z"></path>
      </svg> </a> 
<ul class="more-box">
<li class="item"><a class="article-report">文章举报</a></li>
</ul>
</li>
</ul></div>
</div>
<div class="person-messagebox">
<div class="left-message">
   <a href="https://blog.csdn.net/azl397985856"> <amp-img src="https://profile.csdnimg.cn/0/2/B/3_azl397985856" class="avatar_pic amp-wp-enforced-sizes i-amphtml-layout-intrinsic i-amphtml-layout-size-defined" width="75" height="75" layout="intrinsic" i-amphtml-layout="intrinsic"><i-amphtml-sizer class="i-amphtml-sizer"><img alt="" aria-hidden="true" class="i-amphtml-intrinsic-sizer" role="presentation" src="data:image/svg+xml;charset=utf-8,<svg%20height=%2275%22%20width=%2275%22%20xmlns=%22http://www.w3.org/2000/svg%22%20version=%221.1%22/>"></i-amphtml-sizer><noscript><img src="https://profile.csdnimg.cn/0/2/B/3_azl397985856" class="avatar_pic" width="75" height="75"></noscript></amp-img> <amp-img src="https://g.csdnimg.cn/static/user-reg-year/1x/6.png" class="user-years amp-wp-enforced-sizes i-amphtml-layout-intrinsic i-amphtml-layout-size-defined" width="22" height="23" layout="intrinsic" i-amphtml-layout="intrinsic"><i-amphtml-sizer class="i-amphtml-sizer"><img alt="" aria-hidden="true" class="i-amphtml-intrinsic-sizer" role="presentation" src="data:image/svg+xml;charset=utf-8,<svg%20height=%2223%22%20width=%2222%22%20xmlns=%22http://www.w3.org/2000/svg%22%20version=%221.1%22/>"></i-amphtml-sizer><noscript><img src="https://g.csdnimg.cn/static/user-reg-year/1x/6.png" class="user-years" width="22" height="23"></noscript></amp-img> </a>
  </div>
<div class="middle-message">
<div class="title">
    <span class="tit"><a href="https://blog.csdn.net/azl397985856" data-report-click='{"mod":"popu_379"}' target="_blank" rel="noopener noreferrer">fe_lucifer</a></span>
   </div>
<div class="text">
    <span>发布了86 篇原创文章</span> ·<br>
    <span>获赞 7</span> ·<br>
    <span>访问量 1万+</span>
   </div>
</div>
<div class="right-message">
   <a href="https://im.csdn.net/im/main.html?userName=azl397985856" target="_blank" class="btn btn-sm btn-red-hollow bt-button personal-letter" rel="noopener noreferrer">私信 </a><br>
   <a class="btn btn-sm  bt-button personal-watch" data-report-click='{"mod":"popu_379"}'>关注</a>
  </div>
</div>
</div>
	</div>

	<footer class="amp-wp-article-footer">
			<div class="amp-wp-meta amp-wp-tax-category">
		Categories: Uncategorized	</div>

	</footer>
</article>

<footer class="amp-wp-footer">
	<div>
		<h2>有组织在!</h2>
		<a href="#top" class="back-to-top">Back to top</a>
	</div>
</footer>




</body></html>
