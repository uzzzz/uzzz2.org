<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Thomas带你领率谷歌AI的美丽 &#8211; 有组织在!</title>
	<atom:link href="https://uzzz.org/category/thomasdainilingshuaigugeaidemeili/feed" rel="self" type="application/rss+xml" />
	<link>http://uzzz.org/</link>
	<description></description>
	<lastBuildDate>Thu, 18 Oct 2018 06:17:59 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.2.4</generator>

<image>
	<url>https://uzzz.org/wp-content/uploads/2019/10/cropped-icon-32x32.png</url>
	<title>Thomas带你领率谷歌AI的美丽 &#8211; 有组织在!</title>
	<link>http://uzzz.org/</link>
	<width>32</width>
	<height>32</height>
</image> 
	<item>
		<title>TensorFlow学习笔记&#8211;Deep Dream模型</title>
		<link>https://uzzz.org/article/1677.html</link>
				<pubDate>Thu, 18 Oct 2018 06:17:59 +0000</pubDate>
		<dc:creator><![CDATA[fandyvon]]></dc:creator>
				<category><![CDATA[Python]]></category>
		<category><![CDATA[Thomas带你领率谷歌AI的美丽]]></category>

		<guid isPermaLink="false">https://uzzz.org/article/1677.html</guid>
				<description><![CDATA[零、目标 Deep Dream是谷歌推出的一个有意思的技术。在训练好的CNN上，设定几个参数就可以生成一张图象。具体目标是： 了解Deep Dream基本原理 掌握实现生成Deep Dream 模型 一、技术原理 在卷积网络中，通常输入的是一张图象，经过若干层的卷积运算，最终输出图像的类别。这期间使用到了图片计算梯度，网络根据梯度不断的调整和学习最佳的参数。但是卷积层究竟学习到了什么，卷积层的参数代表了什么，浅层卷积和深层卷积学习到的内容有哪些区别，这些问题Deep Dream可以解答。 假设输入网络的图像为X，网络输出的各个类别的概率为t（t是一个多维向量，代表了多种类别的概率）。设定t[N]为优化目标，不断的让神经网络去调整输入图像X的像素值，让输出t[N]尽可能的大，最后极大化第N类别的概率得到图片。 关于卷积层究竟学到了什么，只需要最大化卷积层的某一个通道数据就可以了。折输入的图像为X，中间某个卷积层的输出是Y，Y的形状是hwc，其中h为Y的高度，w为Y的宽度，c为通道数。卷积的一个通道就可以代表一种学习到的信息。以某一个通道的平均值作为优化目标，就可以弄清楚这个通道究竟学习到了什么，这也是Deep Dream的基本原理。 二、在TensorFlow中使用 导入Inception模型 原始的Deep Dream 模型只需要优化ImageNet 模型卷积层某个通道的激活值就可以。因此，应该先导入ImageNet图像识别模型，这里以 Inception 为例。创建 load_inception.py 文件，输入如下代码： # 导入基本模块 import numpy as np import tensorflow as tf # 创建图和会话 graph = tf.Graph() sess = tf.InteractiveSession(graph=graph) # 导入Inception模型 # tensorflow_inception_graph.pb 文件存储了inception的网络结构和对应的数据 model_fn = 'tensorflow_inception_graph.pb' with tf.gfile.FastGFile(model_fn, 'rb') as f: graph_def = tf.GraphDef() graph_def.ParseFromString(f.read()) # 导入的时候需要给网络制定一个输入图像，因此定义一个t_input作为占位符 # 需要注意的是，使用的图像数据通常的格式为：(height,width,channel)， # 其中height为图像的像素高度，width为图像的像素宽度，chaneel为图像的通道数，一般使用RGB图像，所以通道数为3 t_input = tf.placeholder(np.float32, name='input') imagenet_mean = 117.0 # 处理输入图像 # 虽然图像的格式是(height,width,channel)，但是Inception模型所需的输入格式是(batch,height,width,channel) # 这是因为(height,width,channel)只能表示一张图片，但在训练神经网络时往往需要多张图片 # 因此在前面加了一维，让输入的图片符合Inception需要的格式 # 尽管这里一次只需要输入一张图片,但是同样也需要将数据变为Inception所需的格式，只不过这里的batch等于1 # 对图像减去一个像素均值 # 原因是在训练Inception 模型的时候，已经做了减去均值的预处理，因此这里使用同样的方法处理，才能保持输入一致 # t_input-imagenet_mean 减去均值，这里使用的Inception模型减去的是一个固定均值117，所以这里也减去117 # expand_dims 执行加一维操作，从[height,width,channel] 变为[1,height,width,channel] t_preprocessed = tf.expand_dims(t_input - imagenet_mean, 0) # 导入模型 tf.import_graph_def(graph_def, {'input': t_preprocessed}) # 找到所有的卷积层 layers = [op.name for op in graph.get_operations() if op.type == 'Conv2D' and 'import/' in op.name] # 输出卷积层层数 print('Number of layers', len(layers)) # 输出mixed4d_3x3_bottleneck_pre_relu 形状 name = 'mixed4d_3x3_bottleneck_pre_relu' print('shape of %s: %s' % (name, str(graph.get_tensor_by_name('import/' + name + ':0').get_shape()))) 这段代码运行后，会输出卷积层总数是59个 注1： 在输出卷积层“mixed4d_3x3_bottleneck_pre_relu”的形状时，输出的结果是(?,?,?,144)，原因是此时还不清楚输入图像的个数以及大小，所以前三维的值不确定 生成原始图像 以 mixed4d_3x3_bottleneck_pre_relu 卷积层为例，最大化它的某一个通道的平均值，以达到生成图像的目的。 创建 gen_naive.py 文件，导入Inception模型，导入方法同上节。首先定义保存图片的函数： def savearray(img_array, img_name): scipy.misc.toimage(img_array).save(img_name) print('img saved : %s' % img_name) 接着创建程序的主要部分： # 定义卷积层、通道数，并去除对应的Tensor name = 'mixed4d_3x3_bottleneck_pre_relu' # 选择任意的通道，这里是139 channel = 139 # 取出 mixed4d_3x3_bottleneck_pre_relu 卷积层的输出层]]></description>
								<content:encoded><![CDATA[<div id="article_content" class="article_content clearfix">
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-3019150162.css">
<div id="content_views" class="markdown_views prism-tomorrow-night">
  <!-- flowchart 箭头图标 勿删 --><br />
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
  </svg> </p>
<h4><a id="_0"></a>零、目标</h4>
<p>Deep Dream是谷歌推出的一个有意思的技术。在训练好的CNN上，设定几个参数就可以生成一张图象。具体目标是：</p>
<ol>
<li>了解Deep Dream基本原理</li>
<li>掌握实现生成Deep Dream 模型</li>
</ol>
<h4><a id="_5"></a>一、技术原理</h4>
<p>在卷积网络中，通常输入的是一张图象，经过若干层的卷积运算，最终输出图像的类别。这期间使用到了图片计算梯度，网络根据梯度不断的调整和学习最佳的参数。但是卷积层究竟学习到了什么，卷积层的参数代表了什么，浅层卷积和深层卷积学习到的内容有哪些区别，这些问题Deep Dream可以解答。<br /> 假设输入网络的图像为X，网络输出的各个类别的概率为t（t是一个多维向量，代表了多种类别的概率）。设定t[N]为优化目标，不断的让神经网络去调整输入图像X的像素值，让输出t[N]尽可能的大，最后极大化第N类别的概率得到图片。<br /> 关于卷积层究竟学到了什么，只需要最大化卷积层的某一个通道数据就可以了。折输入的图像为X，中间某个卷积层的输出是Y，Y的形状是h<em>w</em>c，其中h为Y的高度，w为Y的宽度，c为通道数。卷积的一个通道就可以代表一种学习到的信息。以某一个通道的平均值作为优化目标，就可以弄清楚这个通道究竟学习到了什么，这也是Deep Dream的基本原理。</p>
<h4><a id="TensorFlow_10"></a>二、在TensorFlow中使用</h4>
<ol>
<li>导入Inception模型<br /> 原始的Deep Dream 模型只需要优化ImageNet 模型卷积层某个通道的激活值就可以。因此，应该先导入ImageNet图像识别模型，这里以 <strong>Inception</strong> 为例。创建 <strong>load_inception.py</strong> 文件，输入如下代码：</li>
</ol>
<pre><code class="prism language-python"><span class="token comment"># 导入基本模块</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

<span class="token comment"># 创建图和会话</span>
graph <span class="token operator">=</span> tf<span class="token punctuation">.</span>Graph<span class="token punctuation">(</span><span class="token punctuation">)</span>
sess <span class="token operator">=</span> tf<span class="token punctuation">.</span>InteractiveSession<span class="token punctuation">(</span>graph<span class="token operator">=</span>graph<span class="token punctuation">)</span>

<span class="token comment"># 导入Inception模型</span>
<span class="token comment"># tensorflow_inception_graph.pb 文件存储了inception的网络结构和对应的数据</span>
model_fn <span class="token operator">=</span> <span class="token string">'tensorflow_inception_graph.pb'</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>gfile<span class="token punctuation">.</span>FastGFile<span class="token punctuation">(</span>model_fn<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    graph_def <span class="token operator">=</span> tf<span class="token punctuation">.</span>GraphDef<span class="token punctuation">(</span><span class="token punctuation">)</span>
    graph_def<span class="token punctuation">.</span>ParseFromString<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment"># 导入的时候需要给网络制定一个输入图像，因此定义一个t_input作为占位符</span>
<span class="token comment"># 需要注意的是，使用的图像数据通常的格式为：(height,width,channel)，</span>
<span class="token comment"># 其中height为图像的像素高度，width为图像的像素宽度，chaneel为图像的通道数，一般使用RGB图像，所以通道数为3</span>
t_input <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'input'</span><span class="token punctuation">)</span>
imagenet_mean <span class="token operator">=</span> <span class="token number">117.0</span>

<span class="token comment"># 处理输入图像</span>
<span class="token comment"># 虽然图像的格式是(height,width,channel)，但是Inception模型所需的输入格式是(batch,height,width,channel)</span>
<span class="token comment"># 这是因为(height,width,channel)只能表示一张图片，但在训练神经网络时往往需要多张图片</span>
<span class="token comment"># 因此在前面加了一维，让输入的图片符合Inception需要的格式</span>
<span class="token comment"># 尽管这里一次只需要输入一张图片,但是同样也需要将数据变为Inception所需的格式，只不过这里的batch等于1</span>
<span class="token comment"># 对图像减去一个像素均值</span>
<span class="token comment"># 原因是在训练Inception 模型的时候，已经做了减去均值的预处理，因此这里使用同样的方法处理，才能保持输入一致</span>
<span class="token comment"># t_input-imagenet_mean 减去均值，这里使用的Inception模型减去的是一个固定均值117，所以这里也减去117</span>
<span class="token comment"># expand_dims 执行加一维操作，从[height,width,channel] 变为[1,height,width,channel]</span>
t_preprocessed <span class="token operator">=</span> tf<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>t_input <span class="token operator">-</span> imagenet_mean<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment"># 导入模型</span>
tf<span class="token punctuation">.</span>import_graph_def<span class="token punctuation">(</span>graph_def<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'input'</span><span class="token punctuation">:</span> t_preprocessed<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># 找到所有的卷积层</span>
layers <span class="token operator">=</span> <span class="token punctuation">[</span>op<span class="token punctuation">.</span>name <span class="token keyword">for</span> op <span class="token keyword">in</span> graph<span class="token punctuation">.</span>get_operations<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> op<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">'Conv2D'</span> <span class="token operator">and</span> <span class="token string">'import/'</span> <span class="token keyword">in</span> op<span class="token punctuation">.</span>name<span class="token punctuation">]</span>

<span class="token comment"># 输出卷积层层数</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Number of layers'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>layers<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 输出mixed4d_3x3_bottleneck_pre_relu 形状</span>
name <span class="token operator">=</span> <span class="token string">'mixed4d_3x3_bottleneck_pre_relu'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'shape of %s: %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>graph<span class="token punctuation">.</span>get_tensor_by_name<span class="token punctuation">(</span><span class="token string">'import/'</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">':0'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


</code></pre>
<p>这段代码运行后，会输出卷积层总数是59个</p>
<blockquote>
<p>注1：<br /> 在输出卷积层“mixed4d_3x3_bottleneck_pre_relu”的形状时，输出的结果是(?,?,?,144)，原因是此时还不清楚输入图像的个数以及大小，所以前三维的值不确定</p>
</blockquote>
<ol start="2">
<li>生成原始图像<br /> 以 mixed4d_3x3_bottleneck_pre_relu 卷积层为例，最大化它的某一个通道的平均值，以达到生成图像的目的。<br /> 创建 <strong>gen_naive.py</strong> 文件，导入Inception模型，导入方法同上节。首先定义保存图片的函数：</li>
</ol>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">savearray</span><span class="token punctuation">(</span>img_array<span class="token punctuation">,</span> img_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    scipy<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>toimage<span class="token punctuation">(</span>img_array<span class="token punctuation">)</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>img_name<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'img saved : %s'</span> <span class="token operator">%</span> img_name<span class="token punctuation">)</span>

</code></pre>
<p>接着创建程序的主要部分：</p>
<pre><code class="prism language-python"><span class="token comment"># 定义卷积层、通道数，并去除对应的Tensor</span>
name <span class="token operator">=</span> <span class="token string">'mixed4d_3x3_bottleneck_pre_relu'</span>
<span class="token comment"># 选择任意的通道，这里是139</span>
channel <span class="token operator">=</span> <span class="token number">139</span>
<span class="token comment"># 取出 mixed4d_3x3_bottleneck_pre_relu 卷积层的输出层</span>
layer_output <span class="token operator">=</span> graph<span class="token punctuation">.</span>get_tensor_by_name<span class="token punctuation">(</span><span class="token string">"import/%s:0"</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>

<span class="token comment"># 定义原始的图像噪声</span>
<span class="token comment"># 他是一个形状为（224，224，3）的张量，表示初始化图像优化起点</span>
img_noise <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">100.0</span>

<span class="token comment"># 调用 render_navie 函数渲染</span>
render_naive<span class="token punctuation">(</span>layer_output<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> channel<span class="token punctuation">]</span><span class="token punctuation">,</span> img_noise<span class="token punctuation">,</span> iter_n<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>

</code></pre>
<p>最后定义渲染函数</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">render_naive</span><span class="token punctuation">(</span>t_obj<span class="token punctuation">,</span> img0<span class="token punctuation">,</span> iter_n<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> step<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' 渲染函数 :param t_obj:卷积层某个通道的值 :param img0:初始化图像 :param iter_n:迭代的步数 :param step: :return: '''</span>
    <span class="token comment"># t_score 是优化目标。他是t_obj的平均值</span>
    <span class="token comment"># t_score 越大，就说明神经网络卷积层对应的通道的平均激活越大</span>
    t_score <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>t_obj<span class="token punctuation">)</span>
    <span class="token comment"># 计算t_score对t_input的梯度</span>
    <span class="token comment"># 代码的目标是通过调整输入图像 t_input ，来让 t_score 尽可能的大</span>
    <span class="token comment"># 因此使用体服下降法</span>
    t_grad <span class="token operator">=</span> tf<span class="token punctuation">.</span>gradients<span class="token punctuation">(</span>t_score<span class="token punctuation">,</span> t_input<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment"># 创建新图</span>
    img <span class="token operator">=</span> img0<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 迭代 iter_n 每一步都将梯度应用到图像上</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>iter_n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 在sess中计算梯度，以及当前的score</span>
        g<span class="token punctuation">,</span> score <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>t_grad<span class="token punctuation">,</span> t_score<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>t_input<span class="token punctuation">:</span> img<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment"># 对img应用梯度，step可以看作学习率</span>
        g <span class="token operator">/=</span> g<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">8</span>
        img <span class="token operator">+=</span> g <span class="token operator">*</span> step
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'score(mean)=%f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span>

    savearray<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token string">'navie.jpg'</span><span class="token punctuation">)</span>

</code></pre>
<p>运行程序后，将得到20次迭代后的图像，如下图<br /> <a href="https://imgchr.com/i/id2L4g" rel="nofollow" data-token="4a367ce6fb687af0e162fa7a8cd15fd0"><img src="https://s1.ax1x.com/2018/10/17/id2L4g.jpg" alt="id2L4g.jpg"></a></p>
<ol start="3">
<li>生成大尺寸图片<br /> 上节生成的图片尺寸太小，这节通过代码，将生成的大尺寸的图片。上节中传递图片尺寸的参数是 <strong>img_noise</strong> ，如果 <strong>img_noise</strong> 传递更大的值，那么生成的图片尺寸就会更大。但是这样就出现一个问题，生成图片的过程是需要消耗内存/显存的，<strong>img_noise</strong> 传递的尺寸越大，消耗的内存/显存就越多，最终会因为内存/显存不足，导致渲染失败。如何解决这个问题呢，其实很简单，每次不对整张图片做优化，而是把图片分为几个部分，每次只对一部分做优化，这样消耗的内存/显存就是固定大小的。<br /> 新建 <strong>gen_multiscale.py</strong> 文件，写入如下代码，这个函数可以对任意大小的图像进行提督计算：</li>
</ol>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">calc_grad_tiled</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> t_grad<span class="token punctuation">,</span> title_size<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' 对任意大小的图像计算梯度 :param img: :param t_grad: :param title_size:每次优化的大小 :return: '''</span>
    <span class="token comment"># 每次只对title_size*title_size大小的图像计算梯度</span>
    sz <span class="token operator">=</span> title_size
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>

    <span class="token comment"># 如果直接计算梯度，在每个 title_size * title_size 的边缘会出现比较明显的边缘效应，影响美观</span>
    <span class="token comment"># 解决的办法是：生成两个随机数 sx、sy，对图片进行整体移动</span>
    <span class="token comment"># img_shift 先在行上做整体移动，再在列上做整体移动</span>
    <span class="token comment"># 防止出现边缘效应</span>
    sx<span class="token punctuation">,</span> sy <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>sz<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    img_shift <span class="token operator">=</span> np<span class="token punctuation">.</span>roll<span class="token punctuation">(</span>np<span class="token punctuation">.</span>roll<span class="token punctuation">(</span>img<span class="token punctuation">,</span> sx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    grad <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token comment"># y,x是开始及位置的像素</span>
    <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>h <span class="token operator">-</span> sz <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>w <span class="token operator">-</span> sz <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 每次对sub计算梯度。sub的大小是title_size*title_size</span>
            sub <span class="token operator">=</span> img_shift<span class="token punctuation">[</span>y<span class="token punctuation">:</span>y <span class="token operator">+</span> sz<span class="token punctuation">,</span> x<span class="token punctuation">:</span>x <span class="token operator">+</span> sz<span class="token punctuation">]</span>
            g <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>t_grad<span class="token punctuation">,</span> <span class="token punctuation">{</span>t_input<span class="token punctuation">:</span> sub<span class="token punctuation">}</span><span class="token punctuation">)</span>
            grad<span class="token punctuation">[</span>y<span class="token punctuation">:</span>y <span class="token operator">+</span> sz<span class="token punctuation">,</span> x<span class="token punctuation">:</span>x <span class="token operator">+</span> sz<span class="token punctuation">]</span> <span class="token operator">=</span> g

        <span class="token comment"># 使用np.roll移回去</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>roll<span class="token punctuation">(</span>np<span class="token punctuation">.</span>roll<span class="token punctuation">(</span>grad<span class="token punctuation">,</span> <span class="token operator">-</span>sx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span>sy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

</code></pre>
<p>为了加快图像的收敛速度，可以采用先生成小尺寸，再将图片放大：</p>
<pre><code class="prism language-python"><span class="token comment"># 将图片放大ratio倍</span>
<span class="token keyword">def</span> <span class="token function">resize_ratio</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> ratio<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 首先确定源像素的范围</span>
    <span class="token builtin">min</span> <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token builtin">max</span> <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> <span class="token punctuation">(</span>img <span class="token operator">-</span> <span class="token builtin">min</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token builtin">max</span> <span class="token operator">-</span> <span class="token builtin">min</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255</span>
    img <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span>scipy<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>imresize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> ratio<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 使用完 scipy.misc.imresize 函数后，将像素缩放回去</span>
    img <span class="token operator">=</span> img <span class="token operator">/</span> <span class="token number">255</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token builtin">max</span> <span class="token operator">-</span> <span class="token builtin">min</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">min</span>
    <span class="token keyword">return</span> img

<span class="token comment"># 生成大尺寸图片</span>
<span class="token keyword">def</span> <span class="token function">render_multiscale</span><span class="token punctuation">(</span>t_obj<span class="token punctuation">,</span> img0<span class="token punctuation">,</span> iter_n<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> step<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> octave_n<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> octave_scale<span class="token operator">=</span><span class="token number">1.4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' 生成大尺寸图片 :param t_obj: :param img0: :param iter_n: :param step: :param octave_n:放大次数 :param octave_scale:放大倍数 :return: '''</span>
    <span class="token comment"># 同样定义目标梯度</span>
    t_score <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>t_obj<span class="token punctuation">)</span>
    t_grad <span class="token operator">=</span> tf<span class="token punctuation">.</span>gradients<span class="token punctuation">(</span>t_score<span class="token punctuation">,</span> t_input<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    img <span class="token operator">=</span> img0<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 先生成小尺寸图像</span>
    <span class="token comment"># 然后调用 resize_ratio 将小尺寸图像放大 octave_scale 倍</span>
    <span class="token comment"># 再使用放大后的图像作为初始值进行计算</span>
    <span class="token keyword">for</span> octave <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>octave_n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> octave <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># 每次将图片放大octave_scale倍</span>
            <span class="token comment"># 共放大octave_n-1次</span>
            img <span class="token operator">=</span> resize_ratio<span class="token punctuation">(</span>img<span class="token punctuation">,</span> octave_scale<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>iter_n<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 计算任意大小图像的梯度</span>
            g <span class="token operator">=</span> calc_grad_tiled<span class="token punctuation">(</span>img<span class="token punctuation">,</span> t_grad<span class="token punctuation">)</span>
            g <span class="token operator">/=</span> g<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">8</span>
            img <span class="token operator">+=</span> g <span class="token operator">*</span> step
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">' '</span><span class="token punctuation">)</span>
    savearray<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token string">'multiscale.jpg'</span><span class="token punctuation">)</span>

</code></pre>
<p>下面编写主内容</p>
<pre><code class="prism language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'mixed4d_3x3_bottleneck_pre_relu'</span>
    channel <span class="token operator">=</span> <span class="token number">139</span>
    img_noise <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">100.0</span>
    layer_output <span class="token operator">=</span> graph<span class="token punctuation">.</span>get_tensor_by_name<span class="token punctuation">(</span><span class="token string">"import/%s:0"</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
    render_multiscale<span class="token punctuation">(</span>layer_output<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> channel<span class="token punctuation">]</span><span class="token punctuation">,</span> img_noise<span class="token punctuation">,</span> iter_n<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>

</code></pre>
<p>运行代码后，将生成一张大尺寸的图片，如下图：<br /> <img src="https://s1.ax1x.com/2018/10/17/idfgEV.jpg" alt="idfgEV.jpg"><br /> 从图中可以看出，mixed4d_3x3_bottleneck_pre_relu 卷积层的第139个通道实际上就是学到了某种花朵的特征。</p>
<ol start="4">
<li>生成高质量图片<br /> 前面两节生成的图片都是分辨率不高的图片，这节将生成高质量的图片。在图像处理算法中，有 <strong>高频成分</strong> 和 <strong>低频成分</strong> 之分。所谓高频成分，是指图像中灰度、颜色、明度变化比较剧烈的地方，比如边缘、细节部分。低频成分是指图像变化不大的地方，比如大块色块、整体风格。<br /> 上节生成的图片高频成分太多，图片不够柔和。如何解决这个问题呢？一种方法是针对高频成分加入损失，这样图像在生成的时候就会因为新加入损失的作用二发生变化，但是加入损失会导致计算量和收敛步数增大。另一种方法是 <strong>放大低频梯度</strong> ，对梯度进行分解，降至分为 <strong>高频梯度</strong> 和 <strong>低频梯度</strong> ，在人为的去放大低频梯度，就可以得到较为柔和的图像。<br /> 一般情况下，要使用 <strong>拉普拉斯金字塔</strong> 对图像进行分解，这种算法可以把图片分解为多层。同时，也可以对梯队进行分解，分解之后，对高频的梯度和低频的梯度都做标准化，可以让梯度的低频成分和高频成分差不多，表现在图像上就会增加图像的低频成分，从而提高生成图像的质量。这种方法称为 <strong>拉普拉斯金字塔标准化</strong>，具体实现代码如下：</li>
</ol>
<pre><code class="prism language-python">k <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
k <span class="token operator">=</span> np<span class="token punctuation">.</span>outer<span class="token punctuation">(</span>k<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
k5x5 <span class="token operator">=</span> k<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">/</span> k<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>eye<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

<span class="token comment"># 这个函数将图像分为低频和高频成分</span>
<span class="token keyword">def</span> <span class="token function">lap_split</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">'split'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 做一次卷积相当于一次平滑，因此lo为低频成分</span>
        lo <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>img<span class="token punctuation">,</span> k5x5<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'SAME'</span><span class="token punctuation">)</span>
        <span class="token comment"># 低频成分缩放到原始图像大叫就得到lo2，再用原始图像img减去lo2，就得到高频成分hi</span>
        lo2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d_transpose<span class="token punctuation">(</span>lo<span class="token punctuation">,</span> k5x5 <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        hi <span class="token operator">=</span> img <span class="token operator">-</span> lo2
    <span class="token keyword">return</span> lo<span class="token punctuation">,</span> hi


<span class="token comment"># 这个函数将图像img分成n层拉普拉斯金字塔</span>
<span class="token keyword">def</span> <span class="token function">lap_split_n</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    levels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 调用lap_split将图像分为低频和高频部分</span>
        <span class="token comment"># 高频部分保存到levels中</span>
        <span class="token comment"># 低频部分再继续分解</span>
        img<span class="token punctuation">,</span> hi <span class="token operator">=</span> lap_split<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
        levels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>hi<span class="token punctuation">)</span>
    levels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token keyword">return</span> levels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>


<span class="token comment"># 将拉普拉斯金字塔还原到原始图像</span>
<span class="token keyword">def</span> <span class="token function">lap_merge</span><span class="token punctuation">(</span>levels<span class="token punctuation">)</span><span class="token punctuation">:</span>
    img <span class="token operator">=</span> levels<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> hi <span class="token keyword">in</span> levels<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">'merge'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            img <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d_transpose<span class="token punctuation">(</span>img<span class="token punctuation">,</span> k5x5 <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>hi<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> hi
    <span class="token keyword">return</span> img


<span class="token comment"># 对img做标准化</span>
<span class="token keyword">def</span> <span class="token function">normalize_std</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">'normalize'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        std <span class="token operator">=</span> tf<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>square<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> img <span class="token operator">/</span> tf<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>std<span class="token punctuation">,</span> eps<span class="token punctuation">)</span>


<span class="token comment"># 拉普拉斯金字塔标准化</span>
<span class="token keyword">def</span> <span class="token function">lap_normalize</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> scale_n<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    img <span class="token operator">=</span> tf<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    tlevels <span class="token operator">=</span> lap_split_n<span class="token punctuation">(</span>img<span class="token punctuation">,</span> scale_n<span class="token punctuation">)</span>
    <span class="token comment"># 每一层都做一个normalize_std</span>
    tlevels <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span>normalize_std<span class="token punctuation">,</span> tlevels<span class="token punctuation">)</span><span class="token punctuation">)</span>
    out <span class="token operator">=</span> lap_merge<span class="token punctuation">(</span>tlevels<span class="token punctuation">)</span>
    <span class="token keyword">return</span> out<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
</code></pre>
<p>编写完拉普拉斯标准化函数后，现在编写生成图像的代码：</p>
<pre><code class="prism language-python"><span class="token comment"># 将一个Tensor函数转换成numpy.ndarray 函数</span>
<span class="token keyword">def</span> <span class="token function">tffunc</span><span class="token punctuation">(</span><span class="token operator">*</span>argtypes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    placeholders <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">,</span> argtypes<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">wrap</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
        out <span class="token operator">=</span> f<span class="token punctuation">(</span><span class="token operator">*</span>placeholders<span class="token punctuation">)</span>

        <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> out<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>placeholders<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> session<span class="token operator">=</span>kw<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> wrapper

    <span class="token keyword">return</span> wrap


<span class="token keyword">def</span> <span class="token function">render_lapnorm</span><span class="token punctuation">(</span>t_obj<span class="token punctuation">,</span> img0<span class="token punctuation">,</span>
                   iter_n<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> step<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> octave_n<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> octave_scale<span class="token operator">=</span><span class="token number">1.4</span><span class="token punctuation">,</span> lap_n<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 同样定义目标和梯度</span>
    t_score <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>t_obj<span class="token punctuation">)</span>
    t_grad <span class="token operator">=</span> tf<span class="token punctuation">.</span>gradients<span class="token punctuation">(</span>t_score<span class="token punctuation">,</span> t_input<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># 将lap_normalize转换为正常函数</span>
    lap_norm_func <span class="token operator">=</span> tffunc<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">(</span>partial<span class="token punctuation">(</span>lap_normalize<span class="token punctuation">,</span> scale_n<span class="token operator">=</span>lap_n<span class="token punctuation">)</span><span class="token punctuation">)</span>

    img <span class="token operator">=</span> img0<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> octave <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>octave_n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> octave <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            img <span class="token operator">=</span> resize_ratio<span class="token punctuation">(</span>img<span class="token punctuation">,</span> octave_scale<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>iter_n<span class="token punctuation">)</span><span class="token punctuation">:</span>
            g <span class="token operator">=</span> calc_grad_tiled<span class="token punctuation">(</span>img<span class="token punctuation">,</span> t_grad<span class="token punctuation">)</span>
            <span class="token comment"># 唯一的区别在于我们使用lap_norm_func来标准化g！</span>
            g <span class="token operator">=</span> lap_norm_func<span class="token punctuation">(</span>g<span class="token punctuation">)</span>
            img <span class="token operator">+=</span> g <span class="token operator">*</span> step
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">' '</span><span class="token punctuation">)</span>
    savearray<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token string">'lapnorm.jpg'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'mixed4d_3x3_bottleneck_pre_relu'</span>
    channel <span class="token operator">=</span> <span class="token number">139</span>
    img_noise <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">100.0</span>
    layer_output <span class="token operator">=</span> graph<span class="token punctuation">.</span>get_tensor_by_name<span class="token punctuation">(</span><span class="token string">'import/%s:0'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
    render_lapnorm<span class="token punctuation">(</span>layer_output<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> channel<span class="token punctuation">]</span><span class="token punctuation">,</span> img_noise<span class="token punctuation">,</span> iter_n<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>

</code></pre>
<p>运行上面代码后，将生成高质量的图片：<br /> <img src="https://s1.ax1x.com/2018/10/18/iwAYNt.jpg" alt="iwAYNt.jpg"></p>
<ol start="5">
<li>生成最终的图片<br /> 前面已经讲解了如何通过极大化卷积层摸个通道的平均值生成图片，并学习了如何生成更大和质量更高的图像。但是最终的Deep Dream 模型还需要对图片添加一个背景。具体代码如下：</li>
</ol>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">resize</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> hw<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">min</span> <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token builtin">max</span> <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> <span class="token punctuation">(</span>img <span class="token operator">-</span> <span class="token builtin">min</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token builtin">max</span> <span class="token operator">-</span> <span class="token builtin">min</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255</span>
    img <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span>scipy<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>imresize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> hw<span class="token punctuation">)</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> img <span class="token operator">/</span> <span class="token number">255</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token builtin">max</span> <span class="token operator">-</span> <span class="token builtin">min</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">min</span>
    <span class="token keyword">return</span> img


<span class="token keyword">def</span> <span class="token function">render_deepdream</span><span class="token punctuation">(</span>t_obj<span class="token punctuation">,</span> img0<span class="token punctuation">,</span> iter_n<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> step<span class="token operator">=</span><span class="token number">1.5</span><span class="token punctuation">,</span> octave_n<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> octave_scale<span class="token operator">=</span><span class="token number">1.4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t_score <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>t_obj<span class="token punctuation">)</span>
    t_grad <span class="token operator">=</span> tf<span class="token punctuation">.</span>gradients<span class="token punctuation">(</span>t_score<span class="token punctuation">,</span> t_input<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    img <span class="token operator">=</span> img0
    <span class="token comment"># 同样将图像进行金字塔分解</span>
    <span class="token comment"># 提取高频和低频的方法比较简单，直接缩放</span>
    octaves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>octave_n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        hw <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        lo <span class="token operator">=</span> resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span>hw<span class="token punctuation">)</span> <span class="token operator">/</span> octave_scale<span class="token punctuation">)</span><span class="token punctuation">)</span>
        hi <span class="token operator">=</span> img <span class="token operator">-</span> resize<span class="token punctuation">(</span>lo<span class="token punctuation">,</span> hw<span class="token punctuation">)</span>
        img <span class="token operator">=</span> lo
        octaves<span class="token punctuation">.</span>append<span class="token punctuation">(</span>hi<span class="token punctuation">)</span>

    <span class="token comment"># 先生成低频的图像，再依次放大并加上高频</span>
    <span class="token keyword">for</span> octave <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>octave_n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> octave <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            hi <span class="token operator">=</span> octaves<span class="token punctuation">[</span><span class="token operator">-</span>octave<span class="token punctuation">]</span>
            img <span class="token operator">=</span> resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> hi<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> hi
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>iter_n<span class="token punctuation">)</span><span class="token punctuation">:</span>
            g <span class="token operator">=</span> calc_grad_tiled<span class="token punctuation">(</span>img<span class="token punctuation">,</span> t_grad<span class="token punctuation">)</span>
            img <span class="token operator">+=</span> g <span class="token operator">*</span> <span class="token punctuation">(</span>step <span class="token operator">/</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">' '</span><span class="token punctuation">)</span>

    img <span class="token operator">=</span> img<span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>
    savearray<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token string">'deepdream.jpg'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    img0 <span class="token operator">=</span> PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'test.jpg'</span><span class="token punctuation">)</span>
    img0 <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span>img0<span class="token punctuation">)</span>

    <span class="token comment"># name = 'mixed4d_3x3_bottleneck_pre_relu'</span>
    name <span class="token operator">=</span> <span class="token string">'mixed4c'</span>
    <span class="token comment"># channel = 139</span>
    layer_output <span class="token operator">=</span> graph<span class="token punctuation">.</span>get_tensor_by_name<span class="token punctuation">(</span><span class="token string">'import/%s:0'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
    <span class="token comment"># render_deepdream(layer_output[:, :, :, channel], img0, iter_n=150)</span>
    render_deepdream<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>square<span class="token punctuation">(</span>layer_output<span class="token punctuation">)</span><span class="token punctuation">,</span> img0<span class="token punctuation">)</span>

</code></pre>
<h4><a id="_396"></a>三、代码下载地址</h4>
<p><a href="https://pan.baidu.com/s/1U3_4Eq31_Cv4tKzDTp8Ulg" rel="nofollow" data-token="080c793f943ecd1be6b867468e08f33c">下载地址</a></p>
</p></div>
<link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-e9f16cbbc2.css" rel="stylesheet">
</div>
]]></content:encoded>
										</item>
	</channel>
</rss>
