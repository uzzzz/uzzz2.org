<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>TK1 &#8211; 有组织在!</title>
	<atom:link href="https://uzzz.org/category/tk1/feed" rel="self" type="application/rss+xml" />
	<link>http://uzzz.org/</link>
	<description></description>
	<lastBuildDate>Mon, 07 Aug 2017 08:54:01 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.2.4</generator>

<image>
	<url>https://uzzz.org/wp-content/uploads/2019/10/cropped-icon-32x32.png</url>
	<title>TK1 &#8211; 有组织在!</title>
	<link>http://uzzz.org/</link>
	<width>32</width>
	<height>32</height>
</image> 
	<item>
		<title>darknet-yolo运行摄像头测试分析及过程主要代码梳理</title>
		<link>https://uzzz.org/article/1422.html</link>
				<pubDate>Mon, 07 Aug 2017 08:54:01 +0000</pubDate>
		<dc:creator><![CDATA[fandyvon]]></dc:creator>
				<category><![CDATA[darknet]]></category>
		<category><![CDATA[TK1]]></category>

		<guid isPermaLink="false">https://uzzz.org/article/1422.html</guid>
				<description><![CDATA[本人是在JESON TK1开发板上实现yolo的视频实时运行测试 darknet的安装很简单，从官网上克隆代码即可： git clone https://github.com/pjreddie/darknet.git 修改makefile文件，使用opencv和cuda GPU=1 OPENCV=1 切换目录 cd darknet make通过就安装成功，若出现如下错误： obj/avgpool_layer_kernels.o -o libdarknet.so -lm -pthreadpkg-config –libs OpenCV-L/usr/local/cuda/lib64 -lcuda -lcudart -lcublas -lcurand -lstdc++ /usr/bin/ld: cannot find -lcudart /usr/bin/ld: cannot find -lcublas /usr/bin/ld: cannot find -lcurand 参照cannot find -lcudart …解决方案 安装成功 下面进行视频测试 权重文件请自行在darknet官网下载，本博客使用了tiny-yolo-voc.weights tiny-yolo-coco.weights （考虑到TK1开发板性能速度问题，只使用了小模型） VOC数据集测试，连接摄像头，运行命令 cd darknet #voc webcam test ./darknet detector demo cfg/voc.data cfg/tiny-yolo-voc.cfg tiny-yolo-voc.weights 测试速度不够快，修改网络输入图片大小到208&#215;208，修改tiny-yolo-voc.cfg第四行 width=208 height=208 速度达到16帧左右，基本满足实时要求 同理： coco数据集测试，连接摄像头，运行命令 cd darknet #coco webcam test ./darknet detector demo cfg/coco.data cfg/tiny-yolo.cfg tiny-yolo-coco.weights 速度在15帧左右 本测试主要代码梳理： ./darknet detector demo cfg/voc.data cfg/tiny-yolo-voc.cfg tiny-yolo-voc.weights 上述命令的意思是进入darknet.c文件，这个文件在examples文件夹中，然后进入darknet.c的main函数，main函数主要是判断输入的参数，判断的时候以空格左键分隔符，根据输入参数运行代码，main函数的主要代码： int main(int argc, char **argv) { //test_resize("data/bad.jpg"); //test_box(); //test_convolutional_layer(); if(argc &#60; 2){ fprintf(stderr, "usage: %s &#60;function&#62;\n", argv[0]); return 0; } gpu_index = find_int_arg(argc, argv, "-i", 0); if(find_arg(argc, argv, "-nogpu")) { gpu_index = -1; } #ifndef GPU gpu_index = -1; #else if(gpu_index &#62;= 0){ cuda_set_device(gpu_index); } #endif if (0 == strcmp(argv[1], "average")){ average(argc, argv); } else if (0 == strcmp(argv[1], "yolo")){ run_yolo(argc, argv); } else if (0 == strcmp(argv[1], "voxel")){ run_voxel(argc, argv); } else if (0 == strcmp(argv[1], "super")){ run_super(argc, argv); } else if (0 == strcmp(argv[1], "lsd")){ run_lsd(argc, argv); } else if (0 == strcmp(argv[1], "detector")){]]></description>
								<content:encoded><![CDATA[<div id="article_content" class="article_content clearfix">
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-3019150162.css">
<div id="content_views" class="markdown_views prism-atom-one-dark">
  <!-- flowchart 箭头图标 勿删 --><br />
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
  </svg> </p>
<p>本人是在JESON TK1开发板上实现yolo的视频实时运行测试</p>
<p>darknet的安装很简单，从官网上克隆代码即可：</p>
<pre class="prettyprint"><code class=" hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/pjreddie/darknet.git</span></code></pre>
<p>修改makefile文件，使用opencv和cuda</p>
<pre class="prettyprint"><code class=" hljs ini"><span class="hljs-setting">GPU=<span class="hljs-value"><span class="hljs-number">1</span></span></span>
<span class="hljs-setting">OPENCV=<span class="hljs-value"><span class="hljs-number">1</span></span></span></code></pre>
<p>切换目录 <br /> <code>cd darknet</code> <br /> make通过就安装成功，若出现如下错误：</p>
<pre class="prettyprint"><code class=" hljs lasso">obj/avgpool_layer_kernels<span class="hljs-built_in">.</span>o <span class="hljs-attribute">-o</span> libdarknet<span class="hljs-built_in">.</span>so <span class="hljs-attribute">-lm</span> <span class="hljs-attribute">-pthreadpkg</span><span class="hljs-attribute">-config</span> –libs OpenCV<span class="hljs-attribute">-L</span>/usr/<span class="hljs-built_in">local</span>/cuda/lib64 <span class="hljs-attribute">-lcuda</span> <span class="hljs-attribute">-lcudart</span> <span class="hljs-attribute">-lcublas</span> <span class="hljs-attribute">-lcurand</span> <span class="hljs-attribute">-lstdc</span><span class="hljs-subst">++</span> 
/usr/bin/ld: cannot find <span class="hljs-attribute">-lcudart</span> 
/usr/bin/ld: cannot find <span class="hljs-attribute">-lcublas</span> 
/usr/bin/ld: cannot find <span class="hljs-attribute">-lcurand</span> </code></pre>
<p>参照<a href="http://blog.csdn.net/weixin_35654926/article/details/76825490" rel="nofollow noopener noreferrer" target="_blank" data-token="8c11cbdaabd8948d19bf160b61e235d3">cannot find -lcudart …解决方案</a> <br /> 安装成功</p>
<p>下面进行视频测试 <br /> 权重文件请自行在darknet官网下载，本博客使用了tiny-yolo-voc.weights <br /> tiny-yolo-coco.weights （考虑到TK1开发板性能速度问题，只使用了小模型）</p>
<p>VOC数据集测试，连接摄像头，运行命令</p>
<pre class="prettyprint"><code class=" hljs lasso">cd darknet
<span class="hljs-variable">#voc</span> webcam test
<span class="hljs-built_in">.</span>/darknet detector demo cfg/voc<span class="hljs-built_in">.</span><span class="hljs-built_in">data</span> cfg/tiny<span class="hljs-attribute">-yolo</span><span class="hljs-attribute">-voc</span><span class="hljs-built_in">.</span>cfg tiny<span class="hljs-attribute">-yolo</span><span class="hljs-attribute">-voc</span><span class="hljs-built_in">.</span>weights</code></pre>
<p>测试速度不够快，修改网络输入图片大小到208&#215;208，修改tiny-yolo-voc.cfg第四行</p>
<pre class="prettyprint"><code class=" hljs ini"><span class="hljs-setting">width=<span class="hljs-value"><span class="hljs-number">208</span></span></span>
<span class="hljs-setting">height=<span class="hljs-value"><span class="hljs-number">208</span></span></span></code></pre>
<p>速度达到16帧左右，基本满足实时要求</p>
<p>同理： <br /> coco数据集测试，连接摄像头，运行命令</p>
<pre class="prettyprint"><code class=" hljs lasso">cd darknet
<span class="hljs-variable">#coco</span> webcam test
<span class="hljs-built_in">.</span>/darknet detector demo cfg/coco<span class="hljs-built_in">.</span><span class="hljs-built_in">data</span> cfg/tiny<span class="hljs-attribute">-yolo</span><span class="hljs-built_in">.</span>cfg tiny<span class="hljs-attribute">-yolo</span><span class="hljs-attribute">-coco</span><span class="hljs-built_in">.</span>weights</code></pre>
<p>速度在15帧左右</p>
<p>本测试主要代码梳理：</p>
<pre class="prettyprint"><code class=" hljs lasso"><span class="hljs-built_in">.</span>/darknet detector demo cfg/voc<span class="hljs-built_in">.</span><span class="hljs-built_in">data</span> cfg/tiny<span class="hljs-attribute">-yolo</span><span class="hljs-attribute">-voc</span><span class="hljs-built_in">.</span>cfg tiny<span class="hljs-attribute">-yolo</span><span class="hljs-attribute">-voc</span><span class="hljs-built_in">.</span>weights</code></pre>
<p>上述命令的意思是进入darknet.c文件，这个文件在examples文件夹中，然后进入darknet.c的main函数，main函数主要是判断输入的参数，判断的时候以空格左键分隔符，根据输入参数运行代码，main函数的主要代码：</p>
<pre class="prettyprint"><code class=" hljs cpp"><span class="hljs-keyword">int</span> main(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)
{
    <span class="hljs-comment">//test_resize("data/bad.jpg");</span>
    <span class="hljs-comment">//test_box();</span>
    <span class="hljs-comment">//test_convolutional_layer();</span>
    <span class="hljs-keyword">if</span>(argc &lt; <span class="hljs-number">2</span>){
        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"usage: %s &lt;function&gt;\n"</span>, argv[<span class="hljs-number">0</span>]);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    gpu_index = find_int_arg(argc, argv, <span class="hljs-string">"-i"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span>(find_arg(argc, argv, <span class="hljs-string">"-nogpu"</span>)) {
        gpu_index = -<span class="hljs-number">1</span>;
    }

<span class="hljs-preprocessor">#ifndef GPU</span>
    gpu_index = -<span class="hljs-number">1</span>;
<span class="hljs-preprocessor">#else</span>
    <span class="hljs-keyword">if</span>(gpu_index &gt;= <span class="hljs-number">0</span>){
        cuda_set_device(gpu_index);
    }
<span class="hljs-preprocessor">#endif</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"average"</span>)){
        average(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"yolo"</span>)){
        run_yolo(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"voxel"</span>)){
        run_voxel(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"super"</span>)){
        run_super(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"lsd"</span>)){
        run_lsd(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"detector"</span>)){
        run_detector(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"detect"</span>)){
        <span class="hljs-keyword">float</span> thresh = find_float_arg(argc, argv, <span class="hljs-string">"-thresh"</span>, <span class="hljs-number">.24</span>);
        <span class="hljs-keyword">char</span> *filename = (argc &gt; <span class="hljs-number">4</span>) ? argv[<span class="hljs-number">4</span>]: <span class="hljs-number">0</span>;
        <span class="hljs-keyword">char</span> *outfile = find_char_arg(argc, argv, <span class="hljs-string">"-out"</span>, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">int</span> fullscreen = find_arg(argc, argv, <span class="hljs-string">"-fullscreen"</span>);
        test_detector(<span class="hljs-string">"cfg/coco.data"</span>, argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], filename, thresh, <span class="hljs-number">.5</span>, outfile, fullscreen);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"cifar"</span>)){
        run_cifar(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"go"</span>)){
        run_go(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"rnn"</span>)){
        run_char_rnn(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"vid"</span>)){
        run_vid_rnn(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"coco"</span>)){
        run_coco(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"classify"</span>)){
        predict_classifier(<span class="hljs-string">"cfg/imagenet1k.data"</span>, argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], argv[<span class="hljs-number">4</span>], <span class="hljs-number">5</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"classifier"</span>)){
        run_classifier(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"regressor"</span>)){
        run_regressor(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"segmenter"</span>)){
        run_segmenter(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"art"</span>)){
        run_art(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"tag"</span>)){
        run_tag(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"compare"</span>)){
        run_compare(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"dice"</span>)){
        run_dice(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"writing"</span>)){
        run_writing(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"3d"</span>)){
        composite_3d(argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], argv[<span class="hljs-number">4</span>], (argc &gt; <span class="hljs-number">5</span>) ? atof(argv[<span class="hljs-number">5</span>]) : <span class="hljs-number">0</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"test"</span>)){
        test_resize(argv[<span class="hljs-number">2</span>]);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"captcha"</span>)){
        run_captcha(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"nightmare"</span>)){
        run_nightmare(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"rgbgr"</span>)){
        rgbgr_net(argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], argv[<span class="hljs-number">4</span>]);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"reset"</span>)){
        reset_normalize_net(argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], argv[<span class="hljs-number">4</span>]);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"denormalize"</span>)){
        denormalize_net(argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], argv[<span class="hljs-number">4</span>]);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"statistics"</span>)){
        statistics_net(argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>]);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"normalize"</span>)){
        normalize_net(argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], argv[<span class="hljs-number">4</span>]);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"rescale"</span>)){
        rescale_net(argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], argv[<span class="hljs-number">4</span>]);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"ops"</span>)){
        operations(argv[<span class="hljs-number">2</span>]);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"speed"</span>)){
        speed(argv[<span class="hljs-number">2</span>], (argc &gt; <span class="hljs-number">3</span> &amp;&amp; argv[<span class="hljs-number">3</span>]) ? atoi(argv[<span class="hljs-number">3</span>]) : <span class="hljs-number">0</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"oneoff"</span>)){
        oneoff(argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], argv[<span class="hljs-number">4</span>]);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"oneoff2"</span>)){
        oneoff2(argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], argv[<span class="hljs-number">4</span>], atoi(argv[<span class="hljs-number">5</span>]));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"partial"</span>)){
        partial(argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], argv[<span class="hljs-number">4</span>], atoi(argv[<span class="hljs-number">5</span>]));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"average"</span>)){
        average(argc, argv);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"visualize"</span>)){
        visualize(argv[<span class="hljs-number">2</span>], (argc &gt; <span class="hljs-number">3</span>) ? argv[<span class="hljs-number">3</span>] : <span class="hljs-number">0</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"mkimg"</span>)){
        mkimg(argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], atoi(argv[<span class="hljs-number">4</span>]), atoi(argv[<span class="hljs-number">5</span>]), atoi(argv[<span class="hljs-number">6</span>]), argv[<span class="hljs-number">7</span>]);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"imtest"</span>)){
        test_resize(argv[<span class="hljs-number">2</span>]);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Not an option: %s\n"</span>, argv[<span class="hljs-number">1</span>]);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre>
<p>本博客测试输入参数为detector，因此你运行main的以下代码：</p>
<pre class="prettyprint"><code class=" hljs mel"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-keyword">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"detector"</span>)){
        run_detector(argc, argv);</code></pre>
<p>run_detector函数位于examples文件夹中detector.c文件，代码如下：</p>
<pre class="prettyprint"><code class=" hljs cpp"><span class="hljs-keyword">void</span> run_detector(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)
{
    <span class="hljs-keyword">char</span> *prefix = find_char_arg(argc, argv, <span class="hljs-string">"-prefix"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">float</span> thresh = find_float_arg(argc, argv, <span class="hljs-string">"-thresh"</span>, <span class="hljs-number">.24</span>);
    <span class="hljs-keyword">float</span> hier_thresh = find_float_arg(argc, argv, <span class="hljs-string">"-hier"</span>, <span class="hljs-number">.5</span>);
    <span class="hljs-keyword">int</span> cam_index = find_int_arg(argc, argv, <span class="hljs-string">"-c"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">int</span> frame_skip = find_int_arg(argc, argv, <span class="hljs-string">"-s"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">int</span> avg = find_int_arg(argc, argv, <span class="hljs-string">"-avg"</span>, <span class="hljs-number">3</span>);
    <span class="hljs-keyword">if</span>(argc &lt; <span class="hljs-number">4</span>){
        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"usage: %s %s [train/test/valid] [cfg] [weights (optional)]\n"</span>, argv[<span class="hljs-number">0</span>], argv[<span class="hljs-number">1</span>]);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">char</span> *gpu_list = find_char_arg(argc, argv, <span class="hljs-string">"-gpus"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">char</span> *outfile = find_char_arg(argc, argv, <span class="hljs-string">"-out"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">int</span> *gpus = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">int</span> gpu = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">int</span> ngpus = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(gpu_list){
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\n"</span>, gpu_list);
        <span class="hljs-keyword">int</span> len = <span class="hljs-built_in">strlen</span>(gpu_list);
        ngpus = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">int</span> i;
        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; len; ++i){
            <span class="hljs-keyword">if</span> (gpu_list[i] == <span class="hljs-string">','</span>) ++ngpus;
        }
        gpus = <span class="hljs-built_in">calloc</span>(ngpus, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));
        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; ngpus; ++i){
            gpus[i] = atoi(gpu_list);
            gpu_list = <span class="hljs-built_in">strchr</span>(gpu_list, <span class="hljs-string">','</span>)+<span class="hljs-number">1</span>;
        }
    } <span class="hljs-keyword">else</span> {
        gpu = gpu_index;
        gpus = &amp;gpu;
        ngpus = <span class="hljs-number">1</span>;
    }

    <span class="hljs-keyword">int</span> clear = find_arg(argc, argv, <span class="hljs-string">"-clear"</span>);
    <span class="hljs-keyword">int</span> fullscreen = find_arg(argc, argv, <span class="hljs-string">"-fullscreen"</span>);
    <span class="hljs-keyword">int</span> width = find_int_arg(argc, argv, <span class="hljs-string">"-w"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">int</span> height = find_int_arg(argc, argv, <span class="hljs-string">"-h"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">int</span> fps = find_int_arg(argc, argv, <span class="hljs-string">"-fps"</span>, <span class="hljs-number">0</span>);

    <span class="hljs-keyword">char</span> *datacfg = argv[<span class="hljs-number">3</span>];
    <span class="hljs-keyword">char</span> *cfg = argv[<span class="hljs-number">4</span>];
    <span class="hljs-keyword">char</span> *weights = (argc &gt; <span class="hljs-number">5</span>) ? argv[<span class="hljs-number">5</span>] : <span class="hljs-number">0</span>;
    <span class="hljs-keyword">char</span> *filename = (argc &gt; <span class="hljs-number">6</span>) ? argv[<span class="hljs-number">6</span>]: <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"test"</span>)) test_detector(datacfg, cfg, weights, filename, thresh, hier_thresh, outfile, fullscreen);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"train"</span>)) train_detector(datacfg, cfg, weights, gpus, ngpus, clear);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"valid"</span>)) validate_detector(datacfg, cfg, weights, outfile);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"valid2"</span>)) validate_detector_flip(datacfg, cfg, weights, outfile);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"recall"</span>)) validate_detector_recall(cfg, weights);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"demo"</span>)) {
        <span class="hljs-built_in">list</span> *options = read_data_cfg(datacfg);
        <span class="hljs-keyword">int</span> classes = option_find_int(options, <span class="hljs-string">"classes"</span>, <span class="hljs-number">20</span>);
        <span class="hljs-keyword">char</span> *name_list = option_find_str(options, <span class="hljs-string">"names"</span>, <span class="hljs-string">"data/names.list"</span>);
        <span class="hljs-keyword">char</span> **names = get_labels(name_list);
        demo(cfg, weights, thresh, cam_index, filename, names, classes, frame_skip, prefix, avg, hier_thresh, width, height, fps, fullscreen);
    }
}</code></pre>
<p>命令行输入第二个参数为demo，因此上述代码关键函数是demo()，demo函数位于src文件夹的demo.c文件中，用于实现检测和显示检测结果。代码如下：</p>
<pre class="prettyprint"><code class=" hljs cpp"><span class="hljs-keyword">void</span> demo(<span class="hljs-keyword">char</span> *cfgfile, <span class="hljs-keyword">char</span> *weightfile, <span class="hljs-keyword">float</span> thresh, <span class="hljs-keyword">int</span> cam_index, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">char</span> **names, <span class="hljs-keyword">int</span> classes, <span class="hljs-keyword">int</span> delay, <span class="hljs-keyword">char</span> *prefix, <span class="hljs-keyword">int</span> avg_frames, <span class="hljs-keyword">float</span> hier, <span class="hljs-keyword">int</span> w, <span class="hljs-keyword">int</span> h, <span class="hljs-keyword">int</span> frames, <span class="hljs-keyword">int</span> fullscreen)
{
    demo_delay = delay;
    demo_frame = avg_frames;
    predictions = <span class="hljs-built_in">calloc</span>(demo_frame, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">float</span>*));
    image **alphabet = load_alphabet();
    demo_names = names;
    demo_alphabet = alphabet;
    demo_classes = classes;
    demo_thresh = thresh;
    demo_hier = hier;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Demo\n"</span>);
    net = parse_network_cfg(cfgfile);
    <span class="hljs-keyword">if</span>(weightfile){
        load_weights(&amp;net, weightfile);
    }
    set_batch_network(&amp;net, <span class="hljs-number">1</span>);
    pthread_t detect_thread;
    pthread_t fetch_thread;

    srand(<span class="hljs-number">2222222</span>);

    <span class="hljs-keyword">if</span>(filename){
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"video file: %s\n"</span>, filename);
        cap = cvCaptureFromFile(filename);
    }<span class="hljs-keyword">else</span>{
        cap = cvCaptureFromCAM(cam_index);

        <span class="hljs-keyword">if</span>(w){
            cvSetCaptureProperty(cap, CV_CAP_PROP_FRAME_WIDTH, w);
        }
        <span class="hljs-keyword">if</span>(h){
            cvSetCaptureProperty(cap, CV_CAP_PROP_FRAME_HEIGHT, h);
        }
        <span class="hljs-keyword">if</span>(frames){
            cvSetCaptureProperty(cap, CV_CAP_PROP_FPS, frames);
        }
    }

    <span class="hljs-keyword">if</span>(!cap) error(<span class="hljs-string">"Couldn't connect to webcam.\n"</span>);

    layer l = net.layers[net.n-<span class="hljs-number">1</span>];
    demo_detections = l.n*l.w*l.h;
    <span class="hljs-keyword">int</span> j;

    avg = (<span class="hljs-keyword">float</span> *) <span class="hljs-built_in">calloc</span>(l.outputs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">float</span>));
    last_avg  = (<span class="hljs-keyword">float</span> *) <span class="hljs-built_in">calloc</span>(l.outputs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">float</span>));
    last_avg2 = (<span class="hljs-keyword">float</span> *) <span class="hljs-built_in">calloc</span>(l.outputs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">float</span>));
    <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; demo_frame; ++j) predictions[j] = (<span class="hljs-keyword">float</span> *) <span class="hljs-built_in">calloc</span>(l.outputs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">float</span>));

    boxes = (box *)<span class="hljs-built_in">calloc</span>(l.w*l.h*l.n, <span class="hljs-keyword">sizeof</span>(box));
    probs = (<span class="hljs-keyword">float</span> **)<span class="hljs-built_in">calloc</span>(l.w*l.h*l.n, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">float</span> *));
    <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; l.w*l.h*l.n; ++j) probs[j] = (<span class="hljs-keyword">float</span> *)<span class="hljs-built_in">calloc</span>(l.classes+<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">float</span>));

    buff[<span class="hljs-number">0</span>] = get_image_from_stream(cap);
    buff[<span class="hljs-number">1</span>] = copy_image(buff[<span class="hljs-number">0</span>]);
    buff[<span class="hljs-number">2</span>] = copy_image(buff[<span class="hljs-number">0</span>]);
    buff_letter[<span class="hljs-number">0</span>] = letterbox_image(buff[<span class="hljs-number">0</span>], net.w, net.h);
    buff_letter[<span class="hljs-number">1</span>] = letterbox_image(buff[<span class="hljs-number">0</span>], net.w, net.h);
    buff_letter[<span class="hljs-number">2</span>] = letterbox_image(buff[<span class="hljs-number">0</span>], net.w, net.h);
    ipl = cvCreateImage(cvSize(buff[<span class="hljs-number">0</span>].w,buff[<span class="hljs-number">0</span>].h), IPL_DEPTH_8U, buff[<span class="hljs-number">0</span>].c);

    <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(!prefix){
        cvNamedWindow(<span class="hljs-string">"Demo"</span>, CV_WINDOW_NORMAL); 
        <span class="hljs-keyword">if</span>(fullscreen){
            cvSetWindowProperty(<span class="hljs-string">"Demo"</span>, CV_WND_PROP_FULLSCREEN, CV_WINDOW_FULLSCREEN);
        } <span class="hljs-keyword">else</span> {
            cvMoveWindow(<span class="hljs-string">"Demo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            cvResizeWindow(<span class="hljs-string">"Demo"</span>, <span class="hljs-number">1352</span>, <span class="hljs-number">1013</span>);
        }
    }

    demo_time = get_wall_time();

    <span class="hljs-keyword">while</span>(!demo_done){
        buff_index = (buff_index + <span class="hljs-number">1</span>) %<span class="hljs-number">3</span>;
        <span class="hljs-keyword">if</span>(pthread_create(&amp;fetch_thread, <span class="hljs-number">0</span>, fetch_in_thread, <span class="hljs-number">0</span>)) error(<span class="hljs-string">"Thread creation failed"</span>);
        <span class="hljs-keyword">if</span>(pthread_create(&amp;detect_thread, <span class="hljs-number">0</span>, detect_in_thread, <span class="hljs-number">0</span>)) error(<span class="hljs-string">"Thread creation failed"</span>);
        <span class="hljs-keyword">if</span>(!prefix){
            <span class="hljs-keyword">if</span>(count % (demo_delay+<span class="hljs-number">1</span>) == <span class="hljs-number">0</span>){
                fps = <span class="hljs-number">1.</span>/(get_wall_time() - demo_time);
                demo_time = get_wall_time();
                <span class="hljs-keyword">float</span> *swap = last_avg;
                last_avg  = last_avg2;
                last_avg2 = swap;
                <span class="hljs-built_in">memcpy</span>(last_avg, avg, l.outputs*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">float</span>));
            }
            display_in_thread(<span class="hljs-number">0</span>);
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">char</span> name[<span class="hljs-number">256</span>];
            <span class="hljs-built_in">sprintf</span>(name, <span class="hljs-string">"%s_%08d"</span>, prefix, count);
            save_image(buff[(buff_index + <span class="hljs-number">1</span>)%<span class="hljs-number">3</span>], name);
        }
        pthread_join(fetch_thread, <span class="hljs-number">0</span>);
        pthread_join(detect_thread, <span class="hljs-number">0</span>);
        ++count;
    }
}
<span class="hljs-preprocessor">#else</span>
<span class="hljs-keyword">void</span> demo(<span class="hljs-keyword">char</span> *cfgfile, <span class="hljs-keyword">char</span> *weightfile, <span class="hljs-keyword">float</span> thresh, <span class="hljs-keyword">int</span> cam_index, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">char</span> **names, <span class="hljs-keyword">int</span> classes, <span class="hljs-keyword">int</span> delay, <span class="hljs-keyword">char</span> *prefix, <span class="hljs-keyword">int</span> avg, <span class="hljs-keyword">float</span> hier, <span class="hljs-keyword">int</span> w, <span class="hljs-keyword">int</span> h, <span class="hljs-keyword">int</span> frames, <span class="hljs-keyword">int</span> fullscreen)
{
    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Demo needs OpenCV for webcam images.\n"</span>);
}</code></pre>
</p></div>
<link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-e9f16cbbc2.css" rel="stylesheet">
</div>
]]></content:encoded>
										</item>
	</channel>
</rss>
